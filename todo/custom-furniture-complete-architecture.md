# å®šåˆ¶å®¶å…·ç³»ç»Ÿå®Œæ•´æ¶æ„åˆ†æ

> **æ¨¡å—ä½ç½®**: `core-hs.fe5726b7.bundle` + `plugins-hs-9fd2f87f.fe5726b7.bundle`  
> **åˆ†ææ—¥æœŸ**: 2026-01-22  
> **æ¶æ„å±‚çº§**: 11å±‚å®Œæ•´æ¶æ„ï¼ˆæ— çœç•¥ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#1-ç³»ç»Ÿæ¦‚è§ˆ)
2. [çº¦æŸç³»ç»Ÿè¯¦ç»†åˆ†æ](#2-çº¦æŸç³»ç»Ÿè¯¦ç»†åˆ†æ)
3. [å‚æ•°åŒ–ç³»ç»Ÿè¯¦ç»†åˆ†æ](#3-å‚æ•°åŒ–ç³»ç»Ÿè¯¦ç»†åˆ†æ)
4. [å®šåˆ¶å®¶å…·æ ¸å¿ƒç±»](#4-å®šåˆ¶å®¶å…·æ ¸å¿ƒç±»)
5. [æŸœä½“ç³»ç»Ÿè¯¦ç»†åˆ†æ](#5-æŸœä½“ç³»ç»Ÿè¯¦ç»†åˆ†æ)
6. [å­éƒ¨ä»¶ç³»ç»Ÿ](#6-å­éƒ¨ä»¶ç³»ç»Ÿ)
7. [é˜µåˆ—ç³»ç»Ÿ](#7-é˜µåˆ—ç³»ç»Ÿ)
8. [æ ¸å¿ƒç®—æ³•](#8-æ ¸å¿ƒç®—æ³•)
9. [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#9-æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
10. [TypeScriptç±»å‹å®šä¹‰](#10-typescriptç±»å‹å®šä¹‰)
11. [å®æˆ˜ç¤ºä¾‹](#11-å®æˆ˜ç¤ºä¾‹)
12. [ç©ºé—´çº¦æŸä¸éšœç¢ç‰©ç³»ç»Ÿ](#12-ç©ºé—´çº¦æŸä¸éšœç¢ç‰©ç³»ç»Ÿ) â­**æ–°å¢**
    - 12.1 ç³»ç»Ÿæ¦‚è¿°
    - 12.2 å¢™é¢å¸é™„ç³»ç»Ÿ
    - 12.3 éšœç¢ç‰©æ£€æµ‹ä¸é¿è®©
    - 12.4 ç¢°æ’æ£€æµ‹å¼•æ“ï¼ˆClipPolygonï¼‰
    - 12.5 å®æˆ˜ç¤ºä¾‹ï¼ˆ5ä¸ªï¼‰
    - 12.6 ç³»ç»Ÿæµç¨‹å›¾
    - 12.7 å…³é”®æ•°æ®ç»“æ„
    - 12.8 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹
    - 12.9 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
    - 12.10 æœ¬ç« æ€»ç»“

---

## 1. ç³»ç»Ÿæ¦‚è§ˆ

### 1.1 ç³»ç»Ÿå®šä½

å®šåˆ¶å®¶å…·ç³»ç»Ÿï¼ˆCustom Furniture Systemï¼‰æ˜¯ä¸€ä¸ªåŸºäº**çº¦æŸæ±‚è§£**å’Œ**å‚æ•°åŒ–å»ºæ¨¡**çš„æ™ºèƒ½å®¶å…·è®¾è®¡ç³»ç»Ÿï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š

- **çº¦æŸé©±åŠ¨**: é€šè¿‡çº¦æŸæ–¹ç¨‹è‡ªåŠ¨è®¡ç®—å‡ ä½•å‚æ•°
- **å‚æ•°åŒ–å»ºæ¨¡**: å‚æ•°æ›´æ–°è‡ªåŠ¨ä¼ æ’­åˆ°æ‰€æœ‰ä¾èµ–å¯¹è±¡
- **æŸœä½“å®šåˆ¶**: æ”¯æŒåœ°æŸœã€åŠæŸœã€é«˜æŸœç­‰å¤šç§æŸœä½“ç±»å‹
- **æ ·å¼ç³»ç»Ÿ**: ç»Ÿä¸€çš„æè´¨ã€æ ·å¼ã€é…ä»¶ç®¡ç†
- **å­éƒ¨ä»¶åµŒå¥—**: æ”¯æŒæŠ½å±‰ã€é—¨æ¿ã€æ‹‰ç¯®ç­‰å­éƒ¨ä»¶
- **é˜µåˆ—ç³»ç»Ÿ**: æ”¯æŒä¸€ç»´/äºŒç»´é˜µåˆ—å¤åˆ¶

### 1.2 æ ¸å¿ƒæ¨¡å—æ¶æ„

```
å®šåˆ¶å®¶å…·ç³»ç»Ÿ
â”œâ”€â”€ Coreå±‚ (core-hs.fe5726b7.bundle)
â”‚   â”œâ”€â”€ NCustomizedParametricModel (å‚æ•°åŒ–æ¨¡å‹åŸºç±»)
â”‚   â”œâ”€â”€ ParametricContentBase (å‚æ•°åŒ–å†…å®¹åŸºç±»)
â”‚   â”œâ”€â”€ ParametricContentSubpart (å­éƒ¨ä»¶ç®¡ç†)
â”‚   â”œâ”€â”€ ParametricModelArray (é˜µåˆ—ç®¡ç†)
â”‚   â””â”€â”€ Constraint System (çº¦æŸç³»ç»Ÿ)
â”‚
â””â”€â”€ Pluginå±‚ (plugins-hs-9fd2f87f.fe5726b7.bundle)
    â”œâ”€â”€ Cabinet (æŸœä½“ç³»ç»Ÿ)
    â”‚   â”œâ”€â”€ CabinetType (æŸœä½“ç±»å‹)
    â”‚   â”œâ”€â”€ CabinetPartsEnum (æŸœä½“éƒ¨ä»¶æšä¸¾)
    â”‚   â”œâ”€â”€ CabinetStyle (æ ·å¼é…ç½®)
    â”‚   â””â”€â”€ StyleIds (æ ·å¼IDç®¡ç†)
    â”‚
    â”œâ”€â”€ UserStyleCategory (ç”¨æˆ·æ ·å¼åˆ†ç±»)
    â”œâ”€â”€ ConstraintHelper (çº¦æŸè¾…åŠ©å·¥å…·)
    â””â”€â”€ Request Handlers (è¯·æ±‚å¤„ç†å™¨)
```

### 1.3 ç±»ç»§æ‰¿å±‚æ¬¡

```typescript
Entity (å®ä½“åŸºç±»)
  â””â”€â”€ NCustomizedFeatureModel (å®šåˆ¶ç‰¹å¾æ¨¡å‹)
      â””â”€â”€ NCustomizedParametricModel (å®šåˆ¶å‚æ•°åŒ–æ¨¡å‹)
          â”œâ”€â”€ NCustomizedBackgroundWall (å®šåˆ¶èƒŒæ™¯å¢™)
          â”œâ”€â”€ NCustomizedCeiling (å®šåˆ¶åŠé¡¶)
          â””â”€â”€ Cabinet (æŸœä½“)
              â”œâ”€â”€ BaseCabinet (åœ°æŸœ)
              â”œâ”€â”€ WallCabinet (åŠæŸœ)
              â”œâ”€â”€ HighCabinet (é«˜æŸœ)
              â””â”€â”€ CornerCabinet (è½¬è§’æŸœ)
```

---

## 2. çº¦æŸç³»ç»Ÿè¯¦ç»†åˆ†æ

### 2.1 çº¦æŸç³»ç»Ÿæ¦‚è¿°

çº¦æŸç³»ç»Ÿæ˜¯å®šåˆ¶å®¶å…·çš„**æ ¸å¿ƒè®¡ç®—å¼•æ“**ï¼Œè´Ÿè´£ï¼š
- å‡ ä½•å‚æ•°çš„è‡ªåŠ¨è®¡ç®—
- å‚æ•°ä¾èµ–å…³ç³»çš„ç»´æŠ¤
- çº¦æŸå†²çªæ£€æµ‹ä¸è§£å†³
- å‚æ•°æ›´æ–°çš„ä¼ æ’­

### 2.2 çº¦æŸç±»å‹æšä¸¾

#### 2.2.1 EN_VARIABLE_LIMIT_TYPEï¼ˆå˜é‡é™åˆ¶ç±»å‹ï¼‰

```typescript
enum EN_VARIABLE_LIMIT_TYPE {
  NONE = 0,           // æ— é™åˆ¶
  INTERVAL = 1,       // åŒºé—´é™åˆ¶ [min, max]
  FIXED = 2,          // å›ºå®šå€¼
  EXPRESSION = 3,     // è¡¨è¾¾å¼çº¦æŸ
  OPTIONS = 4,        // é€‰é¡¹çº¦æŸï¼ˆæšä¸¾å€¼ï¼‰
  INCREMENT = 5       // å¢é‡çº¦æŸï¼ˆæ­¥è¿›å€¼ï¼‰
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```javascript
// ç¤ºä¾‹ï¼šé—¨æ¿åšåº¦çš„é€‰é¡¹çº¦æŸ
{
  id: "cabinet_door_thickness",
  limitType: EN_VARIABLE_LIMIT_TYPE.OPTIONS,
  options: ["18mm", "20mm", "22mm"],
  value: "20mm"
}

// ç¤ºä¾‹ï¼šæŸœä½“å®½åº¦çš„åŒºé—´çº¦æŸ
{
  id: "cabinet_width",
  limitType: EN_VARIABLE_LIMIT_TYPE.INTERVAL,
  min: 300,
  max: 1200,
  value: 600
}

// ç¤ºä¾‹ï¼šå°é¢é«˜åº¦çš„è¡¨è¾¾å¼çº¦æŸ
{
  id: "countertop_height",
  limitType: EN_VARIABLE_LIMIT_TYPE.EXPRESSION,
  equation: "base_cabinet_height + countertop_thickness",
  dependencies: ["base_cabinet_height", "countertop_thickness"]
}
```

#### 2.2.2 çº¦æŸç±»å‹è¯¦ç»†å®šä¹‰

```typescript
interface ConstraintType {
  // ä½ç½®çº¦æŸ
  POSITION: "position";
  
  // å°ºå¯¸çº¦æŸ
  DIMENSION: "dimension";
  
  // è§’åº¦çº¦æŸ
  ANGLE: "angle";
  
  // ç­‰å¼çº¦æŸ
  EQUATION: "equation";
  
  // è·ç¦»çº¦æŸ
  DISTANCE: "distance";
  
  // å¯¹é½çº¦æŸ
  ALIGNMENT: "alignment";
}
```

### 2.3 çº¦æŸç»“æ„å®šä¹‰

#### 2.3.1 åŸºç¡€çº¦æŸç»“æ„

```typescript
interface Constraint {
  // çº¦æŸå…ƒæ•°æ®
  localId: string;              // æœ¬åœ°IDï¼Œå¦‚ "id_bd1_w_eq"
  _des?: string;                // çº¦æŸæè¿°ï¼Œå¦‚ "å·¦ä¾§æ¿_1"
  comment1?: string;            // æ³¨é‡Š1
  comment2?: string;            // æ³¨é‡Š2
  
  // çº¦æŸç±»å‹
  type: "position" | "dimension" | "angle" | "equation";
  
  // çº¦æŸæ–¹ç¨‹
  equation: string;             // å¦‚ "id_bd1_w = ID_board_thickness"
  output: string;               // è¾“å‡ºå˜é‡
  
  // çº¦æŸè¾“å…¥
  inputs: {
    [stateId: string]: State;   // è¾“å…¥çŠ¶æ€æ˜ å°„
  };
  
  // çº¦æŸè®¡ç®—
  compute(): void;              // è®¡ç®—çº¦æŸå€¼
  init(inputs: Map, states: Map): void;  // åˆå§‹åŒ–çº¦æŸ
}
```

#### 2.3.2 çº¦æŸç¤ºä¾‹

```javascript
// ç¤ºä¾‹1ï¼šä½ç½®çº¦æŸ
{
  _des: "å‰æŒ¡æ°´ä½ç½®",
  localId: "id_constraints_noDripEdge_position_z",
  type: "position",
  equation: "id_noDripEdge_position_z = id_countertop_position_z + id_countertop_height",
  output: "id_noDripEdge_position_z",
  inputs: {
    id_countertop_position_z: State,
    id_countertop_height: State
  }
}

// ç¤ºä¾‹2ï¼šæ–¹ç¨‹çº¦æŸ
{
  _des: "å·¦ä¾§æ¿å®½åº¦",
  localId: "id_bd1_w_eq",
  type: "equation",
  equation: "id_bd1_w = ID_board_thickness",
  output: "id_bd1_w",
  inputs: {
    ID_board_thickness: State
  }
}

// ç¤ºä¾‹3ï¼šè§’åº¦çº¦æŸï¼ˆåœ†å¼§æŸœï¼‰
{
  _des: "åœ†å¼§èµ·å§‹è§’åº¦",
  localId: "id_arc_angle_start_helper",
  type: "angle",
  equation: "id_arc_angle_start_helper = Math.atan2(pt1_y - center_y, pt1_x - center_x) * 180 / Math.PI",
  output: "id_arc_angle_start_helper",
  inputs: {
    pt1_x: State,
    pt1_y: State,
    center_x: State,
    center_y: State
  }
}
```

### 2.4 çº¦æŸæ±‚è§£å™¨ï¼ˆConstraintSolverï¼‰

#### 2.4.1 æ±‚è§£å™¨æ¶æ„

```typescript
class ConstraintSolver {
  private constraints: Map<string, Constraint>;
  private states: Map<string, State>;
  private dependencyGraph: DependencyGraph;
  private computationOrder: string[];
  
  constructor() {
    this.constraints = new Map();
    this.states = new Map();
    this.dependencyGraph = new DependencyGraph();
    this.computationOrder = [];
  }
  
  // æ·»åŠ çº¦æŸ
  addConstraint(constraint: Constraint): void {
    this.constraints.set(constraint.localId, constraint);
    this.updateDependencyGraph(constraint);
  }
  
  // æ›´æ–°ä¾èµ–å›¾
  updateDependencyGraph(constraint: Constraint): void {
    const output = constraint.output;
    const inputs = Object.keys(constraint.inputs);
    
    this.dependencyGraph.addNode(output);
    inputs.forEach(input => {
      this.dependencyGraph.addEdge(input, output);
    });
  }
  
  // æ‹“æ‰‘æ’åºè®¡ç®—é¡ºåº
  computeTopologicalOrder(): string[] {
    return this.dependencyGraph.topologicalSort();
  }
  
  // æ±‚è§£æ‰€æœ‰çº¦æŸ
  solve(): void {
    this.computationOrder = this.computeTopologicalOrder();
    
    this.computationOrder.forEach(stateId => {
      const constraint = this.findConstraintByOutput(stateId);
      if (constraint) {
        constraint.compute();
      }
    });
  }
  
  // æ£€æµ‹å¾ªç¯ä¾èµ–
  detectCircularDependency(): boolean {
    return this.dependencyGraph.hasCycle();
  }
  
  // æŸ¥æ‰¾çº¦æŸ
  findConstraintByOutput(output: string): Constraint | undefined {
    for (const constraint of this.constraints.values()) {
      if (constraint.output === output) {
        return constraint;
      }
    }
    return undefined;
  }
}
```

#### 2.4.2 ä¾èµ–å›¾å®ç°

```typescript
class DependencyGraph {
  private adjacencyList: Map<string, Set<string>>;
  private inDegree: Map<string, number>;
  
  constructor() {
    this.adjacencyList = new Map();
    this.inDegree = new Map();
  }
  
  addNode(node: string): void {
    if (!this.adjacencyList.has(node)) {
      this.adjacencyList.set(node, new Set());
      this.inDegree.set(node, 0);
    }
  }
  
  addEdge(from: string, to: string): void {
    this.addNode(from);
    this.addNode(to);
    
    if (!this.adjacencyList.get(from)!.has(to)) {
      this.adjacencyList.get(from)!.add(to);
      this.inDegree.set(to, (this.inDegree.get(to) || 0) + 1);
    }
  }
  
  // Kahnç®—æ³•æ‹“æ‰‘æ’åº
  topologicalSort(): string[] {
    const queue: string[] = [];
    const result: string[] = [];
    const tempInDegree = new Map(this.inDegree);
    
    // æ‰¾åˆ°æ‰€æœ‰å…¥åº¦ä¸º0çš„èŠ‚ç‚¹
    for (const [node, degree] of tempInDegree.entries()) {
      if (degree === 0) {
        queue.push(node);
      }
    }
    
    while (queue.length > 0) {
      const current = queue.shift()!;
      result.push(current);
      
      // å‡å°‘é‚»æ¥èŠ‚ç‚¹çš„å…¥åº¦
      for (const neighbor of this.adjacencyList.get(current) || []) {
        const newDegree = tempInDegree.get(neighbor)! - 1;
        tempInDegree.set(neighbor, newDegree);
        
        if (newDegree === 0) {
          queue.push(neighbor);
        }
      }
    }
    
    // å¦‚æœresulté•¿åº¦å°äºèŠ‚ç‚¹æ•°ï¼Œè¯´æ˜æœ‰ç¯
    if (result.length !== this.adjacencyList.size) {
      throw new Error("Circular dependency detected!");
    }
    
    return result;
  }
  
  // DFSæ£€æµ‹ç¯
  hasCycle(): boolean {
    const visited = new Set<string>();
    const recursionStack = new Set<string>();
    
    const dfs = (node: string): boolean => {
      visited.add(node);
      recursionStack.add(node);
      
      for (const neighbor of this.adjacencyList.get(node) || []) {
        if (!visited.has(neighbor)) {
          if (dfs(neighbor)) return true;
        } else if (recursionStack.has(neighbor)) {
          return true;  // å‘ç°ç¯
        }
      }
      
      recursionStack.delete(node);
      return false;
    };
    
    for (const node of this.adjacencyList.keys()) {
      if (!visited.has(node)) {
        if (dfs(node)) return true;
      }
    }
    
    return false;
  }
}
```

### 2.5 çº¦æŸä¼ æ’­ç®—æ³•

#### 2.5.1 ä¼ æ’­ç®—æ³•æµç¨‹

```
1. å‚æ•°æ›´æ–°è§¦å‘
   â†“
2. æ ‡è®°å—å½±å“çš„çº¦æŸ
   â†“
3. æ‹“æ‰‘æ’åºè®¡ç®—é¡ºåº
   â†“
4. æŒ‰åºè®¡ç®—çº¦æŸ
   â†“
5. æ›´æ–°ä¾èµ–çŠ¶æ€
   â†“
6. è§¦å‘å‡ ä½•æ›´æ–°
```

#### 2.5.2 ä¼ æ’­ç®—æ³•å®ç°

```typescript
class ConstraintPropagation {
  private solver: ConstraintSolver;
  private affectedStates: Set<string>;
  
  // å‚æ•°æ›´æ–°è§¦å‘ä¼ æ’­
  propagate(changedStateId: string, newValue: any): void {
    // 1. æ›´æ–°çŠ¶æ€å€¼
    const state = this.solver.states.get(changedStateId);
    if (!state) return;
    
    state.value = newValue;
    
    // 2. æ ‡è®°å—å½±å“çš„çŠ¶æ€
    this.affectedStates = new Set();
    this.markAffectedStates(changedStateId);
    
    // 3. è·å–è®¡ç®—é¡ºåºï¼ˆæ‹“æ‰‘æ’åºï¼‰
    const computationOrder = this.getComputationOrder(this.affectedStates);
    
    // 4. æŒ‰åºè®¡ç®—çº¦æŸ
    computationOrder.forEach(stateId => {
      const constraint = this.solver.findConstraintByOutput(stateId);
      if (constraint) {
        try {
          constraint.compute();
        } catch (error) {
          console.error(`Constraint ${constraint.localId} failed:`, error);
        }
      }
    });
    
    // 5. è§¦å‘å‡ ä½•æ›´æ–°
    this.triggerGeometryUpdate(this.affectedStates);
  }
  
  // é€’å½’æ ‡è®°å—å½±å“çš„çŠ¶æ€
  markAffectedStates(stateId: string, visited = new Set<string>()): void {
    if (visited.has(stateId)) return;
    visited.add(stateId);
    
    this.affectedStates.add(stateId);
    
    // æŸ¥æ‰¾æ‰€æœ‰ä¾èµ–æ­¤çŠ¶æ€çš„çº¦æŸ
    const dependentConstraints = this.findDependentConstraints(stateId);
    
    dependentConstraints.forEach(constraint => {
      this.markAffectedStates(constraint.output, visited);
    });
  }
  
  // æŸ¥æ‰¾ä¾èµ–çº¦æŸ
  

  findDependentConstraints(stateId: string): Constraint[] {
    const result: Constraint[] = [];
    
    for (const constraint of this.solver.constraints.values()) {
      if (constraint.inputs[stateId]) {
        result.push(constraint);
      }
    }
    
    return result;
  }
  
  // è·å–å—å½±å“çŠ¶æ€çš„è®¡ç®—é¡ºåº
  getComputationOrder(affectedStates: Set<string>): string[] {
    const subgraph = this.buildSubgraph(affectedStates);
    return subgraph.topologicalSort();
  }
  
  // æ„å»ºå­å›¾
  buildSubgraph(states: Set<string>): DependencyGraph {
    const subgraph = new DependencyGraph();
    
    states.forEach(stateId => {
      subgraph.addNode(stateId);
      
      const constraint = this.solver.findConstraintByOutput(stateId);
      if (constraint) {
        Object.keys(constraint.inputs).forEach(inputId => {
          if (states.has(inputId)) {
            subgraph.addEdge(inputId, stateId);
          }
        });
      }
    });
    
    return subgraph;
  }
  
  // è§¦å‘å‡ ä½•æ›´æ–°
  triggerGeometryUpdate(states: Set<string>): void {
    // é€šçŸ¥å‡ ä½•å¼•æ“æ›´æ–°
    HSCore.Event.emit('geometry:update', {
      affectedStates: Array.from(states)
    });
  }
}
```

### 2.6 çº¦æŸå†²çªæ£€æµ‹

#### 2.6.1 å†²çªç±»å‹

```typescript
enum ConstraintConflictType {
  CIRCULAR_DEPENDENCY = "circular_dependency",   // å¾ªç¯ä¾èµ–
  OVER_CONSTRAINED = "over_constrained",         // è¿‡çº¦æŸ
  UNDER_CONSTRAINED = "under_constrained",       // æ¬ çº¦æŸ
  INVALID_EQUATION = "invalid_equation",         // æ— æ•ˆæ–¹ç¨‹
  VALUE_OUT_OF_RANGE = "value_out_of_range"     // å€¼è¶…å‡ºèŒƒå›´
}
```

#### 2.6.2 å†²çªæ£€æµ‹å™¨å®ç°

```typescript
class ConstraintConflictDetector {
  private solver: ConstraintSolver;
  
  // æ£€æµ‹æ‰€æœ‰å†²çª
  detectConflicts(): ConstraintConflict[] {
    const conflicts: ConstraintConflict[] = [];
    
    // 1. æ£€æµ‹å¾ªç¯ä¾èµ–
    if (this.solver.detectCircularDependency()) {
      conflicts.push({
        type: ConstraintConflictType.CIRCULAR_DEPENDENCY,
        message: "æ£€æµ‹åˆ°çº¦æŸå¾ªç¯ä¾èµ–",
        severity: "error"
      });
    }
    
    // 2. æ£€æµ‹è¿‡çº¦æŸ/æ¬ çº¦æŸ
    const constraintStatus = this.analyzeConstraintStatus();
    conflicts.push(...constraintStatus);
    
    // 3. æ£€æµ‹æ— æ•ˆæ–¹ç¨‹
    const invalidEquations = this.detectInvalidEquations();
    conflicts.push(...invalidEquations);
    
    // 4. æ£€æµ‹å€¼èŒƒå›´å†²çª
    const rangeConflicts = this.detectRangeConflicts();
    conflicts.push(...rangeConflicts);
    
    return conflicts;
  }
}
```

### 2.7 çº¦æŸç³»ç»Ÿå®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     çº¦æŸç³»ç»Ÿæ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. çº¦æŸå®šä¹‰ (Constraint Definition)                         â”‚
â”‚     - ä½ç½®çº¦æŸ (Position)                                    â”‚
â”‚     - å°ºå¯¸çº¦æŸ (Dimension)                                   â”‚
â”‚     - è§’åº¦çº¦æŸ (Angle)                                       â”‚
â”‚     - æ–¹ç¨‹çº¦æŸ (Equation)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ä¾èµ–å›¾æ„å»º (Dependency Graph)                            â”‚
â”‚     - èŠ‚ç‚¹: çŠ¶æ€å˜é‡ (State Variables)                       â”‚
â”‚     - è¾¹: ä¾èµ–å…³ç³» (Dependencies)                            â”‚
â”‚     - æ£€æµ‹: å¾ªç¯ä¾èµ– (Cycle Detection)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ‹“æ‰‘æ’åº (Topological Sort)                              â”‚
â”‚     - Kahnç®—æ³•è®¡ç®—é¡ºåº                                       â”‚
â”‚     - å…¥åº¦ç»Ÿè®¡ (In-degree Counting)                          â”‚
â”‚     - é˜Ÿåˆ—å¤„ç† (Queue Processing)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. çº¦æŸæ±‚è§£ (Constraint Solving)                            â”‚
â”‚     - æŒ‰æ‹“æ‰‘é¡ºåºè®¡ç®—                                         â”‚
â”‚     - æ–¹ç¨‹æ±‚å€¼ (Equation Evaluation)                         â”‚
â”‚     - ç»“æœéªŒè¯ (Result Validation)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. çº¦æŸä¼ æ’­ (Constraint Propagation)                        â”‚
â”‚     - å‚æ•°æ›´æ–°è§¦å‘                                           â”‚
â”‚     - æ ‡è®°å—å½±å“çŠ¶æ€                                         â”‚
â”‚     - é€’å½’ä¼ æ’­æ›´æ–°                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å†²çªæ£€æµ‹ä¸è§£å†³ (Conflict Detection & Resolution)         â”‚
â”‚     - å¾ªç¯ä¾èµ–æ£€æµ‹                                           â”‚
â”‚     - è¿‡çº¦æŸ/æ¬ çº¦æŸæ£€æµ‹                                      â”‚
â”‚     - å€¼èŒƒå›´å†²çªæ£€æµ‹                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. å‡ ä½•æ›´æ–° (Geometry Update)                               â”‚
â”‚     - è§¦å‘å‡ ä½•é‡å»º                                           â”‚
â”‚     - æ›´æ–°3Dæ¨¡å‹                                             â”‚
â”‚     - åˆ·æ–°æ¸²æŸ“è§†å›¾                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å‚æ•°åŒ–ç³»ç»Ÿè¯¦ç»†åˆ†æ

### 3.1 å‚æ•°åŒ–ç³»ç»Ÿæ¦‚è¿°

å‚æ•°åŒ–ç³»ç»Ÿç®¡ç†æ¨¡å‹çš„æ‰€æœ‰å¯å˜å‚æ•°ï¼Œæ”¯æŒï¼š
- å‚æ•°å®šä¹‰ä¸å­˜å‚¨
- å‚æ•°ä¾èµ–å…³ç³»ç®¡ç†
- å‚æ•°è¡¨è¾¾å¼è§£æ
- å‚æ•°æ›´æ–°ä¼ æ’­
- å‚æ•°éªŒè¯

### 3.2 å‚æ•°å®šä¹‰ï¼ˆParameter Definitionï¼‰

```typescript
interface Parameter {
  // å‚æ•°æ ‡è¯†
  id: string;                    // å‚æ•°ID
  name: string;                  // å‚æ•°åç§°
  description?: string;          // å‚æ•°æè¿°
  
  // å‚æ•°å€¼
  value: any;                    // å½“å‰å€¼
  defaultValue: any;             // é»˜è®¤å€¼
  unit?: string;                 // å•ä½
  
  // å‚æ•°ç±»å‹
  type: ParameterType;           // å‚æ•°ç±»å‹
  dataType: DataType;            // æ•°æ®ç±»å‹
  
  // çº¦æŸæ¡ä»¶
  limitType: EN_VARIABLE_LIMIT_TYPE;  // é™åˆ¶ç±»å‹
  min?: number;                  // æœ€å°å€¼
  max?: number;                  // æœ€å¤§å€¼
  options?: any[];               // é€‰é¡¹åˆ—è¡¨
  increment?: number;            // å¢é‡
  
  // ä¾èµ–å…³ç³»
  expression?: string;           // è®¡ç®—è¡¨è¾¾å¼
  dependencies?: string[];       // ä¾èµ–å‚æ•°åˆ—è¡¨
  
  // UIç›¸å…³
  visible?: boolean;             // æ˜¯å¦å¯è§
  editable?: boolean;            // æ˜¯å¦å¯ç¼–è¾‘
  category?: string;             // å‚æ•°åˆ†ç±»
}
```

### 3.3 å‚æ•°åŒ–ç³»ç»Ÿå®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‚æ•°åŒ–ç³»ç»Ÿæ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å‚æ•°å®šä¹‰ (Parameter Definition)                          â”‚
â”‚     - å‚æ•°IDã€åç§°ã€ç±»å‹                                     â”‚
â”‚     - é»˜è®¤å€¼ã€é™åˆ¶æ¡ä»¶                                       â”‚
â”‚     - ä¾èµ–è¡¨è¾¾å¼                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. å‚æ•°ä¾èµ–å›¾ (Parameter Dependency Graph)                  â”‚
â”‚     - æ„å»ºå‚æ•°ä¾èµ–å…³ç³»                                       â”‚
â”‚     - æå–è¡¨è¾¾å¼ä¸­çš„å˜é‡                                     â”‚
â”‚     - ç»´æŠ¤æ­£å‘/åå‘ä¾èµ–åˆ—è¡¨                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å‚æ•°è¡¨è¾¾å¼è§£æ (Expression Parser)                       â”‚
â”‚     - JavaScriptè¡¨è¾¾å¼æ±‚å€¼                                   â”‚
â”‚     - å˜é‡æå–ä¸éªŒè¯                                         â”‚
â”‚     - è¯­æ³•æ£€æŸ¥                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å‚æ•°è®¡ç®—å¼•æ“ (Parameter Calculation Engine)              â”‚
â”‚     - è®¡ç®—å‚æ•°å€¼                                             â”‚
â”‚     - è·å–å‚æ•°ä¸Šä¸‹æ–‡                                         â”‚
â”‚     - ç»“æœéªŒè¯                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. å‚æ•°æ›´æ–°ä¼ æ’­ (Parameter Update Propagation)              â”‚
â”‚     - å‚æ•°æ›´æ–°è§¦å‘                                           â”‚
â”‚     - è·å–æ‰€æœ‰ä¾èµ–è€…                                         â”‚
â”‚     - æ‹“æ‰‘æ’åºè®¡ç®—é¡ºåº                                       â”‚
â”‚     - æŒ‰åºé‡æ–°è®¡ç®—                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å‚æ•°éªŒè¯ç³»ç»Ÿ (Parameter Validation)                      â”‚
â”‚     - åŒºé—´éªŒè¯ (Interval)                                    â”‚
â”‚     - é€‰é¡¹éªŒè¯ (Options)                                     â”‚
â”‚     - å›ºå®šå€¼éªŒè¯ (Fixed)                                     â”‚
â”‚     - å¢é‡éªŒè¯ (Increment)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. äº‹ä»¶é€šçŸ¥ (Event Notification)                            â”‚
â”‚     - è§¦å‘å‚æ•°æ›´æ–°äº‹ä»¶                                       â”‚
â”‚     - é€šçŸ¥UIæ›´æ–°                                             â”‚
â”‚     - è§¦å‘å‡ ä½•é‡å»º                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. å®šåˆ¶å®¶å…·æ ¸å¿ƒç±»

### 4.1 NCustomizedParametricModel

```typescript
class NCustomizedParametricModel extends NCustomizedFeatureModel {
  // å‚æ•°ç³»ç»Ÿ
  parameters: {
    [key: string]: any;           // å‚æ•°æ˜ å°„
  };
  
  // çº¦æŸç³»ç»Ÿ
  states: Map<string, State>;     // çŠ¶æ€æ˜ å°„
  constraints: Map<string, Constraint>;  // çº¦æŸæ˜ å°„
  
  // å­éƒ¨ä»¶ç³»ç»Ÿ
  subparts: ParametricContentSubpart[];
  
  // é˜µåˆ—ç³»ç»Ÿ
  arrays: ParametricModelArray[];
  
  // è®¡ç®—æ–¹æ³•
  compute(): void {
    // 1. æ±‚è§£çº¦æŸ
    this.solveConstraints();
    
    // 2. æ›´æ–°å­éƒ¨ä»¶
    this.updateSubparts();
    
    // 3. æ›´æ–°é˜µåˆ—
    this.updateArrays();
    
    // 4. é‡å»ºå‡ ä½•
    this.rebuildGeometry();
  }
  
  // æ›´æ–°å‚æ•°
  updateParameter(paramId: string, value: any): void {
    this.parameters[paramId] = value;
    this.compute();
  }
}
```

---

## 5. æŸœä½“ç³»ç»Ÿè¯¦ç»†åˆ†æ

### 5.1 æŸœä½“ç±»å‹æšä¸¾ï¼ˆCabinetTypeï¼‰

```typescript
// æŸœä½“ç±»å‹
enum CabinetType {
  BaseCabinet = "BaseCabinet",           // åœ°æŸœ
  WallCabinet = "WallCabinet",           // åŠæŸœ
  HighCabinet = "HighCabinet",           // é«˜æŸœ
  CornerBaseCabinet = "CornerBaseCabinet",  // è½¬è§’åœ°æŸœ
  CornerWallCabinet = "CornerWallCabinet",  // è½¬è§’åŠæŸœ
  OpenCabinet = "OpenCabinet",           // å¼€æ”¾æŸœ
  ArcCabinet = "ArcCabinet"              // åœ†å¼§æŸœ
}

// æŸœä½“è¯¦ç»†ç±»å‹ï¼ˆä»cabinet.jsåˆ†æï¼‰
enum CabinetDetailType {
  ä¸€å­—å‹åœ°æŸœ = "ä¸€å­—å‹åœ°æŸœ",
  Lå­—å‹åœ°æŸœ = "Lå­—å‹åœ°æŸœ",
  Uå­—å‹åœ°æŸœ = "Uå­—å‹åœ°æŸœ",
  å²›å°åœ°æŸœ = "å²›å°åœ°æŸœ",
  å§å°åœ°æŸœ = "å§å°åœ°æŸœ"
}
```

### 5.2 æŸœä½“éƒ¨ä»¶æšä¸¾ï¼ˆCabinetPartsEnumï¼‰

```typescript
const CabinetPartsEnum = {
  Body: "cabinetbody",              // æŸœä½“
  Door: "Door",                      // é—¨æ¿
  Handle: "Handle",                  // æŠŠæ‰‹
  Drawer: "Drawer",                  // æŠ½å±‰
  Basket: "Basket",                  // æ‹‰ç¯®
  Appliance: "Appliance",            // ç”µå™¨
  NoDripEdge: "NoDripEdge",          // å‰æŒ¡æ°´
  Backsplash: "Backsplash",          // åæŒ¡æ°´
  Countertop: "Countertop",          // å°é¢
  Topline: "Topline",                // é¡¶çº¿
  Toekick: "Toekick",                // è¸¢è„šçº¿
  Lightline: "Lightline",            // ç¯çº¿
  ZipboardL: "ZipboardL",            // Lå‹è£…é¥°æ¿
  ZipboardI: "ZipboardI",            // Iå‹è£…é¥°æ¿
  BarCounter: "BarCounter",          // å§å°
  Lightboard: "Lightboard",          // ç¯æ¿
  SideDeco: "SideDeco",              // ä¾§è£…é¥°
  SlidingDoorSideBoard: "SlidingDoorSideBoard",  // æ¨æ‹‰é—¨ä¾§æ¿
  ClosingBoard: "ClosingBoard",      // å°æ¿
  BarLeg: "BarLeg",                  // å§å°è…¿
  DrawerDoor: "DrawerDoor"           // æŠ½å±‰é—¨
};
```

### 5.3 æ ·å¼ç³»ç»Ÿï¼ˆStyleIdsï¼‰

```typescript
const StyleIds = {
  // æè´¨ç›¸å…³
  BodyMaterial: "cabinet_body_material",         // æŸœä½“æè´¨
  DoorMaterial: "cabinet_door_material",         // é—¨æ¿æè´¨
  HandleMaterial: "cabinet_handle_material",     // å†…åµŒæŠŠæ‰‹æè´¨
  GlassMaterial: "cabinet_glass_material",       // ç»ç’ƒæè´¨
  CountertopMaterial: "cabinet_countertop_material",  // å°é¢æè´¨
  ToekickMaterial: "cabinet_toekick_material",   // è„šçº¿æè´¨
  ToplineMaterial: "cabinet_topline_material",   // é¡¶çº¿æè´¨
  LightlineMaterial: "cabinet_lightline_material",  // ç¯çº¿æè´¨
  WallMaterial: "wall_material",                 // å¢™ä½“æè´¨
  FloorMaterial: "floor_material",               // åœ°é¢æè´¨
  
  // æ ·å¼ç›¸å…³
  DoorStyle: "cabinet_door_style",               // é—¨æ¿æ ·å¼
  HandleStyle: "cabinet_handle_style",           // æŠŠæ‰‹æ ·å¼
  ToekickStyle: "cabinet_toekick_molding",       // è„šçº¿æ ·å¼
  ToplineStyle: "cabinet_topline_style",         // é¡¶çº¿æ ·å¼
  LightlineStyle: "cabinet_lightline_style",     // ç¯çº¿æ ·å¼
  FrontsplashStyle: "cabinet_frontsplash_style", // å‰æŒ¡æ°´æ ·å¼
  BacksplashStyle: "cabinet_backsplash_style",   // åæŒ¡æ°´æ ·å¼
  ClosingBoardStyle: "cabinet_closingboard_style",  // å°æ¿æ ·å¼
  DrawerDoorStyle: "cabinet_drawerdoor_style",   // 
æŠ½å±‰é—¨æ ·å¼
  ApplianceStyle: "cabinet_appliance_style",     // ç”µå™¨æ ·å¼
  BasketStyle: "cabinet_basket_style",           // æ‹‰ç¯®æ ·å¼
  BarLegStyle: "cabinet_barleg_style",           // å§å°è…¿æ ·å¼
  
  // å‚æ•°ç›¸å…³
  DoorThickness: "cabinet_door_thickness",       // é—¨æ¿åšåº¦
  ToekickHeight: "cabinet_toekick_height",       // è„šçº¿é«˜åº¦
  BaseCabinetHeight: "cabinet_base_height"       // åœ°æŸœé«˜åº¦
};
```

### 5.4 å‚æ•°IDç³»ç»Ÿï¼ˆParamIdsï¼‰

```typescript
const ParamIds = {
  CountertopExtendLeft: "cabinet_countertop_extend_left",              // å°é¢å·¦å»¶ä¼¸
  CountertopExtendRight: "cabinet_countertop_extend_right",            // å°é¢å³å»¶ä¼¸
  CountertopExtendFront: "cabinet_countertop_extend_front",            // å°é¢å‰å»¶ä¼¸
  CountertopExtendBack: "cabinet_countertop_extend_back",              // å°é¢åå»¶ä¼¸
  CountertopExtendNodripedgeHeight: "cabinet_countertop_nodripedge_height",  // å‰æŒ¡æ°´é«˜åº¦
  CountertopExtendBacksplashHeight: "cabinet_countertop_backsplash_height",  // åæŒ¡æ°´é«˜åº¦
  CountertopHeight: "cabinet_countertop_height",                       // å°é¢åšåº¦
  CountertopConnection: "cabinet_countertop_connection",               // è¿æ¥å°é¢
  CountertopSinkPosition: "cabinet_countertop_sinkposition"            // å°ç›†ä½ç½®
};
```

### 5.5 æŸœä½“æ ·å¼ç®¡ç†å™¨ï¼ˆCabinetStyleï¼‰

```typescript
class CabinetStyle {
  id: string;
  brandId: string;                // å“ç‰ŒID (shejijia/zhibang)
  version: number;                // ç‰ˆæœ¬å·
  styles: StyleItem[];            // æ ·å¼åˆ—è¡¨
  countertopparam: ParamItem[];   // å°é¢å‚æ•°åˆ—è¡¨
  
  // è·å–æ ·å¼å…ƒæ•°æ®
  getMetaById(styleId: string): any {
    const style = this.styles.find(s => s.id === styleId);
    return style ? style.meta || style.value : null;
  }
  
  // è®¾ç½®æ ·å¼å…ƒæ•°æ®
  setMetaById(styleId: string, meta: any): void {
    const style = this.styles.find(s => s.id === styleId);
    if (style) {
      style.meta = meta;
    }
  }
  
  // è·å–å‚æ•°å€¼
  getValueByParamId(paramId: string): any {
    const param = this.countertopparam.find(p => p.id === paramId);
    return param ? param.value : null;
  }
  
  // è·å–æ•°å€¼å‹å‚æ•°
  getNumberByParamId(paramId: string): number {
    return parseFloat(this.getValueByParamId(paramId));
  }
  
  // è®¾ç½®å‚æ•°å€¼
  setValueByParamId(paramId: string, value: any): void {
    const param = this.countertopparam.find(p => p.id === paramId);
    if (param) {
      param.value = value;
    }
  }
  
  // åŠ è½½æ ·å¼æ•°æ®
  async loadStyles(): Promise<void> {
    // ä»æœåŠ¡å™¨åŠ è½½æè´¨å’Œæ ·å¼æ•°æ®
    await StyleHelper.getStylesBySeekIds(this.styles);
    this.loaded = true;
  }
}
```

---

## 6. å­éƒ¨ä»¶ç³»ç»Ÿ

### 6.1 å­éƒ¨ä»¶ç»“æ„

```typescript
interface ParametricContentSubpart {
  // å­éƒ¨ä»¶ID
  id: string;
  localId: string;
  
  // å­éƒ¨ä»¶ç±»å‹
  type: string;                   // å¦‚ "drawer", "door", "basket"
  
  // å‚æ•°æ•°æ®
  parameters: {
    [key: string]: any;
  };
  
  // å‡ ä½•æ•°æ®
  geometry: {
    position: Vector3;
    rotation: Vector3;
    scale: Vector3;
  };
  
  // çº¦æŸå…³ç³»
  constraints: Constraint[];
  
  // çˆ¶å­å…³ç³»
  parent: NCustomizedParametricModel;
  children: ParametricContentSubpart[];
  
  // è®¡ç®—æ–¹æ³•
  compute(): void;
  updateGeometry(): void;
}
```

### 6.2 å­éƒ¨ä»¶ç®¡ç†å™¨

```typescript
class SubpartManager {
  private subparts: Map<string, ParametricContentSubpart>;
  private parent: NCustomizedParametricModel;
  
  constructor(parent: NCustomizedParametricModel) {
    this.parent = parent;
    this.subparts = new Map();
  }
  
  // æ·»åŠ å­éƒ¨ä»¶
  addSubpart(subpart: ParametricContentSubpart): void {
    subpart.parent = this.parent;
    this.subparts.set(subpart.id, subpart);
    
    // å°†å­éƒ¨ä»¶çº¦æŸæ·»åŠ åˆ°çˆ¶å¯¹è±¡
    this.parent.constraints.push(...subpart.constraints);
  }
  
  // ç§»é™¤å­éƒ¨ä»¶
  removeSubpart(subpartId: string): void {
    const subpart = this.subparts.get(subpartId);
    if (subpart) {
      // ç§»é™¤ç›¸å…³çº¦æŸ
      this.removeSubpartConstraints(subpart);
      this.subparts.delete(subpartId);
    }
  }
  
  // æ›´æ–°æ‰€æœ‰å­éƒ¨ä»¶
  updateAllSubparts(): void {
    for (const subpart of this.subparts.values()) {
      subpart.compute();
      subpart.updateGeometry();
    }
  }
  
  // è·å–å­éƒ¨ä»¶
  getSubpart(subpartId: string): ParametricContentSubpart | undefined {
    return this.subparts.get(subpartId);
  }
  
  // è·å–æŒ‡å®šç±»å‹çš„å­éƒ¨ä»¶
  getSubpartsByType(type: string): ParametricContentSubpart[] {
    return Array.from(this.subparts.values()).filter(s => s.type === type);
  }
}
```

### 6.3 å­éƒ¨ä»¶åµŒå¥—ç®—æ³•

```typescript
class SubpartNestingAlgorithm {
  // è®¡ç®—å­éƒ¨ä»¶åµŒå¥—ä½ç½®
  calculateNestingPosition(
    parent: NCustomizedParametricModel,
    subpart: ParametricContentSubpart,
    index: number
  ): Vector3 {
    const parentBounds = parent.getBoundingBox();
    const subpartSize = subpart.getSize();
    
    // æ ¹æ®çˆ¶å¯¹è±¡å’Œå­éƒ¨ä»¶ç±»å‹è®¡ç®—ä½ç½®
    switch (subpart.type) {
      case "drawer":
        return this.calculateDrawerPosition(parentBounds, subpartSize, index);
      case "door":
        return this.calculateDoorPosition(parentBounds, subpartSize, index);
      case "basket":
        return this.calculateBasketPosition(parentBounds, subpartSize, index);
      default:
        return new Vector3(0, 0, 0);
    }
  }
  
  // è®¡ç®—æŠ½å±‰ä½ç½®
  calculateDrawerPosition(
    parentBounds: BoundingBox,
    drawerSize: Vector3,
    index: number
  ): Vector3 {
    const spacing = 0.005; // 5mmé—´è·
    const y = parentBounds.min.y + (drawerSize.y + spacing) * index;
    
    return new Vector3(
      parentBounds.min.x,
      y,
      parentBounds.min.z
    );
  }
}
```

---

## 7. é˜µåˆ—ç³»ç»Ÿ

### 7.1 é˜µåˆ—ç»“æ„

```typescript
interface ParametricModelArray {
  // é˜µåˆ—ID
  id: string;
  localId: string;
  
  // é˜µåˆ—ç±»å‹
  type: ArrayType;                // LINEAR_1D, LINEAR_2D, CIRCULAR
  
  // é˜µåˆ—å‚æ•°
  count: number;                  // é˜µåˆ—æ•°é‡
  spacing: number;                // é—´è·
  direction: Vector3;             // æ–¹å‘
  
  // æºå¯¹è±¡
  source: NCustomizedParametricModel;
  
  // é˜µåˆ—å®ä¾‹
  instances: NCustomizedParametricModel[];
  
  // çº¦æŸå…³ç³»
  constraints: Constraint[];
  
  // ç”Ÿæˆé˜µåˆ—
  generate(): void;
  update(): void;
}

enum ArrayType {
  LINEAR_1D = "linear_1d",        // ä¸€ç»´çº¿æ€§é˜µåˆ—
  LINEAR_2D = "linear_2d",        // äºŒç»´çº¿æ€§é˜µåˆ—
  CIRCULAR = "circular",          // åœ†å½¢é˜µåˆ—
  PATH = "path"                   // è·¯å¾„é˜µåˆ—
}
```

### 7.2 é˜µåˆ—ç®¡ç†å™¨

```typescript
class ArrayManager {
  private arrays: Map<string, ParametricModelArray>;
  
  constructor() {
    this.arrays = new Map();
  }
  
  // åˆ›å»ºé˜µåˆ—
  createArray(
    source: NCustomizedParametricModel,
    type: ArrayType,
    count: number,
    spacing: number,
    direction: Vector3
  ): ParametricModelArray {
    const array: ParametricModelArray = {
      id: generateUUID(),
      localId: `array_${source.id}`,
      type,
      count,
      spacing,
      direction,
      source,
      instances: [],
      constraints: [],
      generate: function() {
        this.instances = [];
        for (let i = 1; i < this.count; i++) {
          const instance = this.source.clone();
          const offset = this.direction.clone().multiplyScalar(i * this.spacing);
          instance.position.add(offset);
          this.instances.push(instance);
        }
      },
      update: function() {
        this.instances.forEach((instance, i) => {
          const offset = this.direction.clone().multiplyScalar((i + 1) * this.spacing);
          instance.position.copy(this.source.position).add(offset);
        });
      }
    };
    
    array.generate();
    this.arrays.set(array.id, array);
    
    return array;
  }
  
  // æ›´æ–°é˜µåˆ—
  updateArray(arrayId: string): void {
    const array = this.arrays.get(arrayId);
    if (array) {
      array.update();
    }
  }
  
  // åˆ é™¤é˜µåˆ—
  deleteArray(arrayId: string): void {
    this.arrays.delete(arrayId);
  }
}
```

### 7.3 é˜µåˆ—ç”Ÿæˆç®—æ³•

```typescript
class ArrayGenerationAlgorithm {
  // ä¸€ç»´çº¿æ€§é˜µåˆ—
  generateLinear1D(
    source: NCustomizedParametricModel,
    count: number,
    spacing: number,
    direction: Vector3
  ): NCustomizedParametricModel[] {
    const instances: NCustomizedParametricModel[] = [];
    
    for (let i = 1; i < count; i++) {
      const instance = source.clone();
      const offset = direction.clone().multiplyScalar(i * spacing);
      instance.position.add(offset);
      instances.push(instance);
    }
    
    return instances;
  }
  
  // äºŒç»´çº¿æ€§é˜µåˆ—
  generateLinear2D(
    source: NCustomizedParametricModel,
    countX: number,
    countY: number,
    spacingX: number,
    spacingY: number,
    directionX: Vector3,
    directionY: Vector3
  ): NCustomizedParametricModel[] {
    const instances: NCustomizedParametricModel[] = [];
    
    for (let i = 0; i < countX; i++) {
      for (let j = 0; j < countY; j++) {
        if (i === 0 && j === 0) continue; // è·³è¿‡æºå¯¹è±¡
        
        const instance = source.clone();
        const offsetX = directionX.clone().multiplyScalar(i * spacingX);
        const offsetY = directionY.clone().multiplyScalar(j * spacingY);
        instance.position.add(offsetX).add(offsetY);
        instances.push(instance);
      }
    }
    
    return instances;
  }
  
  // åœ†å½¢é˜µåˆ—
  generateCircular(
    source: NCustomizedParametricModel,
    count: number,
    radius: number,
    center: Vector3,
    startAngle: number = 0
  ): NCustomizedParametricModel[] {
    const instances: NCustomizedParametricModel[] = [];
    const angleStep = (2 * Math.PI) / count;
    
    for (let i = 1; i < count; i++) {
      const instance = source.clone();
      const angle = startAngle + i * angleStep;
      const offset = new Vector3(
        Math.cos(angle) * radius,
        0,
        Math.sin(angle) * radius
      );
      instance.position.copy(center).add(offset);
      instance.rotation.y = angle;
      instances.push(instance);
    }
    
    return instances;
  }
}
```

---

## 8. æ ¸å¿ƒç®—æ³•

### 8.1 çº¦æŸæ±‚è§£ç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰

```
ç®—æ³•: ConstraintSolving
è¾“å…¥: constraints (çº¦æŸé›†åˆ), states (çŠ¶æ€é›†åˆ)
è¾“å‡º: æ›´æ–°åçš„çŠ¶æ€å€¼

1. æ„å»ºä¾èµ–å›¾ G = (V, E)
   FOR EACH constraint IN constraints:
       output = constraint.output
       inputs = constraint.inputs
       ADD vertex output TO V
       FOR EACH input IN inputs:
           ADD edge (input, output) TO E
   
2. æ£€æµ‹å¾ªç¯ä¾èµ–
   IF hasCycle(G) THEN:
       THROW Error("Circular dependency detected")
   
3. æ‹“æ‰‘æ’åº
   computationOrder = topologicalSort(G)
   
4. æŒ‰åºè®¡ç®—çº¦æŸ
   FOR EACH stateId IN computationOrder:
       constraint = findConstraintByOutput(stateId)
       IF constraint EXISTS THEN:
           TRY:
               constraint.compute()
           CATCH error:
               HANDLE constraint error
   
5. è¿”å›æ›´æ–°åçš„çŠ¶æ€
   RETURN states
```

### 8.2 å‚æ•°åŒ–æ›´æ–°ç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰

```
ç®—æ³•: ParameterUpdatePropagation
è¾“å…¥: paramId (å‚æ•°ID), newValue (æ–°å€¼)
è¾“å‡º: æ›´æ–°æ‰€æœ‰ä¾èµ–å‚æ•°

1. éªŒè¯æ–°å€¼
   param = getParameter(paramId)
   IF NOT validate(param, newValue) THEN:
       RETURN error
   
2. æ›´æ–°å‚æ•°å€¼
   param.value = newValue
   
3. è·å–æ‰€æœ‰ä¾èµ–è€…ï¼ˆBFS/DFSï¼‰
   affectedParams = getAllDependents(paramId)
   
4. æ‹“æ‰‘æ’åºè®¡ç®—é¡ºåº
   subgraph = buildSubgraph(affectedParams)
   computationOrder = topologicalSort(subgraph)
   
5. æŒ‰åºé‡æ–°è®¡ç®—
   FOR EACH affectedParamId IN computationOrder:
       newVal = calculateParameter(affectedParamId)
       affectedParam = getParameter(affectedParamId)
       affectedParam.value = newVal
   
6. è§¦å‘æ›´æ–°äº‹ä»¶
   emitUpdateEvents(paramId, affectedParams)
   
7. è§¦å‘å‡ ä½•æ›´æ–°
   triggerGeometryUpdate(affectedParams)
```

### 8.3 å­éƒ¨ä»¶åµŒå¥—ç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰

```
ç®—æ³•: SubpartNesting
è¾“å…¥: parent (çˆ¶å¯¹è±¡), subparts (å­éƒ¨ä»¶åˆ—è¡¨)
è¾“å‡º: æ›´æ–°å­éƒ¨ä»¶ä½ç½®

1. è·å–çˆ¶å¯¹è±¡è¾¹ç•Œ
   parentBounds = parent.getBoundingBox()
   
2. æŒ‰ç±»å‹åˆ†ç»„å­éƒ¨ä»¶
   groupedSubparts = groupByType(subparts)
   
3. ä¸ºæ¯ä¸ªç»„åˆ†é…ç©ºé—´
   FOR EACH type, group IN groupedSubparts:
       availableSpace = calculateAvailableSpace(parentBounds, type)
       
4. è®¡ç®—å­éƒ¨ä»¶å¸ƒå±€
   FOR EACH subpart IN group:
       position = calculatePosition(
           parentBounds,
           subpart.size,
           subpart.index,
           availableSpace
       )
       subpart.position = position
       
5. åº”ç”¨çº¦æŸ
   FOR EACH subpart IN subparts:
       applyConstraints(subpart)
       
6. æ›´æ–°å‡ ä½•
   FOR EACH subpart IN subparts:
       subpart.updateGeometry()
```

### 8.4 é˜µåˆ—ç”Ÿæˆç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰

```
ç®—æ³•: ArrayGeneration
è¾“å…¥: source (æºå¯¹è±¡), type (é˜µåˆ—ç±»å‹), params (é˜µåˆ—å‚æ•°)
è¾“å‡º: é˜µåˆ—å®ä¾‹åˆ—è¡¨

1. æ ¹æ®ç±»å‹é€‰æ‹©ç®—æ³•
   SWITCH type:
       CASE LINEAR_1D:
           RETURN generateLinear1D(source, params)
       CASE LINEAR_2D:
           RETURN generateLinear2D(source, params)
       CASE CIRCULAR:
           RETURN generateCircular(source, params)
       
2. ä¸€ç»´çº¿æ€§é˜µåˆ—
   Function generateLinear1D(source, params):
       instances = []
       FOR i = 1 TO params.count - 1:
           instance = source.clone()
           offset = params.direction * i * params.spacing
           instance.position += offset
           instances.append(instance)
       RETURN instances
       
3. äºŒç»´çº¿æ€§é˜µåˆ—
   Function 
generateLinear2D(source, params):
       instances = []
       FOR i = 0 TO params.countX - 1:
           FOR j = 0 TO params.countY - 1:
               IF i == 0 AND j == 0 THEN CONTINUE
               instance = source.clone()
               offsetX = params.directionX * i * params.spacingX
               offsetY = params.directionY * j * params.spacingY
               instance.position += offsetX + offsetY
               instances.append(instance)
       RETURN instances
```

### 8.5 ç¢°æ’æ£€æµ‹ç®—æ³•

```typescript
class CollisionDetection {
  // AABBåŒ…å›´ç›’ç¢°æ’æ£€æµ‹
  checkAABBCollision(box1: BoundingBox, box2: BoundingBox): boolean {
    return (
      box1.min.x <= box2.max.x && box1.max.x >= box2.min.x &&
      box1.min.y <= box2.max.y && box1.max.y >= box2.min.y &&
      box1.min.z <= box2.max.z && box1.max.z >= box2.min.z
    );
  }
  
  // æ£€æµ‹æŸœä½“ä¸å­éƒ¨ä»¶ç¢°æ’
  checkCabinetSubpartCollision(
    cabinet: NCustomizedParametricModel,
    subpart: ParametricContentSubpart
  ): boolean {
    const cabinetBox = cabinet.getBoundingBox();
    const subpartBox = subpart.getBoundingBox();
    return this.checkAABBCollision(cabinetBox, subpartBox);
  }
}
```

---

## 9. æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### 9.1 æ•°æ®æµæ¶æ„

```
ç”¨æˆ·è¾“å…¥
   â”‚
   â–¼
å‚æ•°æ›´æ–°
   â”‚
   â”œâ”€â”€â†’ å‚æ•°éªŒè¯ â†’ å¤±è´¥ â†’ é”™è¯¯æç¤º
   â”‚                â†“
   â”‚              æˆåŠŸ
   â–¼
çº¦æŸä¼ æ’­
   â”‚
   â”œâ”€â”€â†’ æ ‡è®°å—å½±å“çŠ¶æ€
   â”œâ”€â”€â†’ æ‹“æ‰‘æ’åº
   â”œâ”€â”€â†’ è®¡ç®—çº¦æŸ
   â–¼
çŠ¶æ€æ›´æ–°
   â”‚
   â”œâ”€â”€â†’ æ›´æ–°å­éƒ¨ä»¶
   â”œâ”€â”€â†’ æ›´æ–°é˜µåˆ—
   â”œâ”€â”€â†’ æ›´æ–°æè´¨
   â–¼
å‡ ä½•é‡å»º
   â”‚
   â”œâ”€â”€â†’ ç”Ÿæˆç½‘æ ¼
   â”œâ”€â”€â†’ åº”ç”¨æè´¨
   â”œâ”€â”€â†’ æ›´æ–°æ¸²æŸ“
   â–¼
UIæ›´æ–°
```

### 9.2 çŠ¶æ€ç®¡ç†

```typescript
class StateManager {
  private states: Map<string, State>;
  private history: StateSnapshot[];
  private currentIndex: number;
  
  // ä¿å­˜çŠ¶æ€å¿«ç…§
  saveSnapshot(): void {
    const snapshot: StateSnapshot = {
      timestamp: Date.now(),
      states: new Map(this.states)
    };
    
    this.history.push(snapshot);
    this.currentIndex = this.history.length - 1;
  }
  
  // æ’¤é”€
  undo(): void {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.restoreSnapshot(this.history[this.currentIndex]);
    }
  }
  
  // é‡åš
  redo(): void {
    if (this.currentIndex < this.history.length - 1) {
      this.currentIndex++;
      this.restoreSnapshot(this.history[this.currentIndex]);
    }
  }
  
  // æ¢å¤å¿«ç…§
  restoreSnapshot(snapshot: StateSnapshot): void {
    this.states = new Map(snapshot.states);
    this.notifyStateChanged();
  }
}
```

---

## 10. TypeScriptç±»å‹å®šä¹‰

### 10.1 å®Œæ•´ç±»å‹å®šä¹‰

```typescript
// ============ çº¦æŸç³»ç»Ÿç±»å‹ ============

interface State {
  id: string;
  localId: string;
  value: any;
  limitType: EN_VARIABLE_LIMIT_TYPE;
  min?: number;
  max?: number;
  options?: any[];
  increment?: number;
}

interface Constraint {
  localId: string;
  type: "position" | "dimension" | "angle" | "equation";
  equation: string;
  output: string;
  inputs: Record<string, State>;
  _des?: string;
  comment1?: string;
  comment2?: string;
  compute(): void;
  init(inputs: Map<string, any>, states: Map<string, State>): void;
}

interface ConstraintConflict {
  type: ConstraintConflictType;
  message: string;
  severity: "error" | "warning" | "info";
  constraintId?: string;
  stateId?: string;
}

// ============ å‚æ•°ç³»ç»Ÿç±»å‹ ============

interface Parameter {
  id: string;
  name: string;
  description?: string;
  value: any;
  defaultValue: any;
  unit?: string;
  type: ParameterType;
  dataType: DataType;
  limitType: EN_VARIABLE_LIMIT_TYPE;
  min?: number;
  max?: number;
  options?: any[];
  increment?: number;
  expression?: string;
  dependencies?: string[];
  visible?: boolean;
  editable?: boolean;
  category?: string;
}

enum ParameterType {
  DIMENSION = "dimension",
  MATERIAL = "material",
  STYLE = "style",
  COLOR = "color",
  BOOLEAN = "boolean",
  ENUM = "enum",
  POSITION = "position",
  ROTATION = "rotation",
  SCALE = "scale"
}

// ============ æŸœä½“ç³»ç»Ÿç±»å‹ ============

interface CabinetConfig {
  type: CabinetType;
  width: number;
  height: number;
  depth: number;
  style: CabinetStyle;
  subparts: SubpartConfig[];
  arrays: ArrayConfig[];
}

interface SubpartConfig {
  type: string;
  count: number;
  parameters: Record<string, any>;
}

interface ArrayConfig {
  type: ArrayType;
  count: number;
  spacing: number;
  direction: Vector3;
}

// ============ æ ·å¼ç³»ç»Ÿç±»å‹ ============

interface StyleItem {
  id: string;
  categoryId?: string;
  name: string;
  value: any;
  meta?: any;
  options?: any[];
  hidden?: boolean;
  showCheckBox?: boolean;
  checked?: boolean;
  dropDownable?: boolean;
}

interface ParamItem {
  id: string;
  name: string;
  value: any;
}

// ============ å‡ ä½•ç±»å‹ ============

interface Vector3 {
  x: number;
  y: number;
  z: number;
}

interface BoundingBox {
  min: Vector3;
  max: Vector3;
}

interface Geometry {
  vertices: Vector3[];
  faces: number[][];
  normals: Vector3[];
  uvs: number[][];
}
```

---

## 11. å®æˆ˜ç¤ºä¾‹

### 11.1 åˆ›å»ºåŸºç¡€åœ°æŸœ

```typescript
// ç¤ºä¾‹1ï¼šåˆ›å»ºä¸€ä¸ªæ ‡å‡†åœ°æŸœ
async function createBaseCabinet() {
  // 1. åˆ›å»ºæŸœä½“æ ·å¼
  const cabinetStyle = new CabinetStyle({
    brandId: "shejijia",
    version: 2
  });
  
  // 2. è®¾ç½®æ ·å¼å‚æ•°
  cabinetStyle.styles = [
    {
      id: StyleIds.BodyMaterial,
      name: "æŸœä½“æè´¨",
      value: "30817a7b-e205-4527-b6ab-f84268c8125c"  // å®æœ¨é¢—ç²’æ¿
    },
    {
      id: StyleIds.DoorMaterial,
      name: "é—¨æ¿æè´¨",
      value: "4894d159-b323-496e-8310-8ad458cba5f1"  // çƒ¤æ¼†é—¨æ¿
    },
    {
      id: StyleIds.DoorThickness,
      name: "é—¨æ¿åšåº¦",
      value: "20mm",
      options: ["18mm", "20mm", "22mm"]
    },
    {
      id: StyleIds.ToekickHeight,
      name: "è¸¢è„šé«˜åº¦",
      value: "100mm",
      options: ["80mm", "100mm", "120mm", "150mm"]
    }
  ];
  
  // 3. åŠ è½½æ ·å¼æ•°æ®ï¼ˆæè´¨ã€è´´å›¾ç­‰ï¼‰
  await cabinetStyle.loadStyles();
  
  // 4. åˆ›å»ºæŸœä½“å®ä¾‹
  const cabinet = new NCustomizedParametricModel({
    contentType: CatalogContentTypeEnum.BaseCabinet,
    style: cabinetStyle
  });
  
  // 5. è®¾ç½®æŸœä½“å‚æ•°
  cabinet.parameters = {
    ID_W: 0.6,        // å®½åº¦ 600mm
    ID_D: 0.56,       // æ·±åº¦ 560mm
    ID_H: 0.7,        // é«˜åº¦ 700mm
    ID_board_thickness: 0.018,  // æ¿æåšåº¦ 18mm
    ID_body_flip: 1   // ç¿»è½¬æ ‡å¿—
  };
  
  // 6. å®šä¹‰çº¦æŸ
  cabinet.constraints = [
    {
      localId: "id_bd1_w_eq",
      type: "equation",
      equation: "id_bd1_w = ID_board_thickness",
      output: "id_bd1_w",
      _des: "å·¦ä¾§æ¿å®½åº¦"
    },
    {
      localId: "id_bd1_h_eq",
      type: "equation",
      equation: "id_bd1_h = ID_H",
      output: "id_bd1_h",
      _des: "å·¦ä¾§æ¿é«˜åº¦"
    },
    {
      localId: "id_bd1_d_eq",
      type: "equation",
      equation: "id_bd1_d = ID_D",
      output: "id_bd1_d",
      _des: "å·¦ä¾§æ¿æ·±åº¦"
    }
  ];
  
  // 7. è®¡ç®—çº¦æŸ
  cabinet.compute();
  
  // 8. æ·»åŠ åˆ°åœºæ™¯
  scene.add(cabinet);
  
  return cabinet;
}
```

### 11.2 æ·»åŠ æŠ½å±‰å­éƒ¨ä»¶

```typescript
// ç¤ºä¾‹2ï¼šä¸ºåœ°æŸœæ·»åŠ ä¸‰ä¸ªæŠ½å±‰
function addDrawersTo Cabinet(cabinet: NCustomizedParametricModel) {
  const subpartManager = new SubpartManager(cabinet);
  
  // æŠ½å±‰å‚æ•°
  const drawerConfigs = [
    { height: 0.15, yOffset: 0.05 },    // ä¸‹å±‚æŠ½å±‰ 150mm
    { height: 0.15, yOffset: 0.21 },    // ä¸­å±‚æŠ½å±‰ 150mm
    { height: 0.15, yOffset: 0.37 }     // ä¸Šå±‚æŠ½å±‰ 150mm
  ];
  
  drawerConfigs.forEach((config, index) => {
    // åˆ›å»ºæŠ½å±‰å­éƒ¨ä»¶
    const drawer = new ParametricContentSubpart({
      id: `drawer_${index}`,
      localId: `id_drawer_${index}`,
      type: "drawer"
    });
    
    // è®¾ç½®æŠ½å±‰å‚æ•°
    drawer.parameters = {
      width: cabinet.parameters.ID_W - cabinet.parameters.ID_board_thickness * 2,
      height: config.height,
      depth: cabinet.parameters.ID_D - cabinet.parameters.ID_board_thickness
    };
    
    // æ·»åŠ æŠ½å±‰ä½ç½®çº¦æŸ
    drawer.constraints = [
      {
        localId: `id_drawer_${index}_x_eq`,
        type: "position",
        equation: `id_drawer_${index}_x = ID_board_thickness`,
        output: `id_drawer_${index}_x`
      },
      {
        localId: `id_drawer_${index}_y_eq`,
        type: "position",
        equation: `id_drawer_${index}_y = ${config.yOffset}`,
        output: `id_drawer_${index}_y`
      },
      {
        localId: `id_drawer_${index}_z_eq`,
        type: "position",
        equation: `id_drawer_${index}_z = 0`,
        output: `id_drawer_${index}_z`
      }
    ];
    
    // æ·»åŠ åˆ°æŸœä½“
    subpartManager.addSubpart(drawer);
  });
  
  // æ›´æ–°æ‰€æœ‰å­éƒ¨ä»¶
  subpartManager.updateAllSubparts();
}
```

### 11.3 åˆ›å»ºä¸€ç»´é˜µåˆ—

```typescript
// ç¤ºä¾‹3ï¼šåˆ›å»ºä¸€æ’åœ°æŸœï¼ˆ4ä¸ªï¼‰
function createCabinetArray() {
  // åˆ›å»ºæºæŸœä½“
  const sourceCabinet = createBaseCabinet();
  
  // åˆ›å»ºé˜µåˆ—ç®¡ç†å™¨
  const arrayManager = new ArrayManager();
  
  // åˆ›å»ºçº¿æ€§é˜µåˆ—
  const array = arrayManager.createArray(
    sourceCabinet,
    ArrayType.LINEAR_1D,
    4,                              // 4ä¸ªæŸœä½“
    0.6,                            // é—´è· 600mmï¼ˆæŸœä½“å®½åº¦ï¼‰
    new Vector3(1, 0, 0)            // Xè½´æ–¹å‘
  );
  
  // å°†é˜µåˆ—å®ä¾‹æ·»åŠ åˆ°åœºæ™¯
  array.instances.forEach(instance => {
    scene.add(instance);
  });
  
  return array;
}
```

### 11.4 
å‚æ•°æ›´æ–°ä¸çº¦æŸä¼ æ’­

```typescript
// ç¤ºä¾‹4ï¼šåŠ¨æ€æ›´æ–°æŸœä½“å®½åº¦ï¼Œçº¦æŸè‡ªåŠ¨ä¼ æ’­
function updateCabinetWidth(cabinet: NCustomizedParametricModel, newWidth: number) {
  // 1. åˆ›å»ºçº¦æŸä¼ æ’­å™¨
  const propagation = new ConstraintPropagation(cabinet.solver);
  
  // 2. æ›´æ–°å‚æ•°ï¼Œè§¦å‘çº¦æŸä¼ æ’­
  propagation.propagate("ID_W", newWidth);
  
  // çº¦æŸä¼ æ’­æµç¨‹ï¼š
  // ID_W (0.6 â†’ 0.8)
  //   â†“
  // id_bd1_w_eq: id_bd1_w = ID_board_thickness (ä¸å˜)
  // id_bd2_w_eq: id_bd2_w = ID_board_thickness (ä¸å˜)
  // id_bd3_w_eq: id_bd3_w = ID_W - ID_board_thickness * 2 (0.564 â†’ 0.764)
  // id_door_w_eq: id_door_w = ID_W / 2 (0.3 â†’ 0.4)
  //   â†“
  // å‡ ä½•è‡ªåŠ¨æ›´æ–°
  
  console.log("æŸœä½“å®½åº¦æ›´æ–°å®Œæˆï¼Œæ‰€æœ‰çº¦æŸå·²é‡æ–°è®¡ç®—");
}
```

### 11.5 æ ·å¼åˆ‡æ¢

```typescript
// ç¤ºä¾‹5ï¼šåˆ‡æ¢æŸœä½“é—¨æ¿æ ·å¼
async function changeDoorStyle(cabinet: NCustomizedParametricModel, newStyleId: string) {
  // 1. è·å–æŸœä½“æ ·å¼
  const style = cabinet.style;
  
  // 2. æŸ¥æ‰¾é—¨æ¿æ ·å¼é¡¹
  const doorStyleItem = style.styles.find(s => s.id === StyleIds.DoorStyle);
  
  if (doorStyleItem) {
    // 3. æ›´æ–°æ ·å¼å€¼
    doorStyleItem.value = newStyleId;
    
    // 4. åŠ è½½æ–°çš„æ ·å¼æ•°æ®ï¼ˆæè´¨ã€è´´å›¾ï¼‰
    await StyleHelper.getStyleBySeekId(newStyleId).then(meta => {
      doorStyleItem.meta = meta;
    });
    
    // 5. åº”ç”¨åˆ°æ‰€æœ‰é—¨æ¿å­éƒ¨ä»¶
    const doors = cabinet.getSubpartsByType("door");
    doors.forEach(door => {
      door.applyMaterial(doorStyleItem.meta);
    });
    
    // 6. è§¦å‘é‡æ–°æ¸²æŸ“
    cabinet.updateGeometry();
  }
}
```

### 11.6 å°é¢å‚æ•°é…ç½®

```typescript
// ç¤ºä¾‹6ï¼šé…ç½®å°é¢å‚æ•°ï¼ˆå»¶ä¼¸ã€æŒ¡æ°´ç­‰ï¼‰
function configureCountertop(cabinet: NCustomizedParametricModel) {
  const style = cabinet.style;
  
  // è®¾ç½®å°é¢å»¶ä¼¸å‚æ•°
  style.setValueByParamId(ParamIds.CountertopExtendLeft, 0.05);     // å·¦å»¶ä¼¸ 50mm
  style.setValueByParamId(ParamIds.CountertopExtendRight, 0.05);    // å³å»¶ä¼¸ 50mm
  style.setValueByParamId(ParamIds.CountertopExtendFront, 0.03);    // å‰å»¶ä¼¸ 30mm
  style.setValueByParamId(ParamIds.CountertopExtendBack, 0);        // åå»¶ä¼¸ 0mm
  
  // è®¾ç½®æŒ¡æ°´é«˜åº¦
  style.setValueByParamId(ParamIds.CountertopExtendNodripedgeHeight, 0.037);  // å‰æŒ¡æ°´ 37mm
  style.setValueByParamId(ParamIds.CountertopExtendBacksplashHeight, 0.050);  // åæŒ¡æ°´ 50mm
  
  // è®¾ç½®å°é¢åšåº¦
  style.setValueByParamId(ParamIds.CountertopHeight, 0.015);  // 15mm
  
  // é‡æ–°è®¡ç®—å°é¢å‡ ä½•
  cabinet.updateCountertop();
}
```

### 11.7 å®Œæ•´çš„Lå‹å¨æŸœåˆ›å»º

```typescript
// ç¤ºä¾‹7ï¼šåˆ›å»ºå®Œæ•´çš„Lå‹å¨æŸœç³»ç»Ÿ
async function createLShapeKitchen() {
  // 1. åˆ›å»ºç»Ÿä¸€æ ·å¼
  const cabinetStyle = new CabinetStyle({
    brandId: "shejijia",
    version: 2
  });
  
  // è®¾ç½®ç»Ÿä¸€æ ·å¼
  cabinetStyle.styles = [
    { id: StyleIds.BodyMaterial, value: "30817a7b-e205-4527-b6ab-f84268c8125c" },
    { id: StyleIds.DoorMaterial, value: "4894d159-b323-496e-8310-8ad458cba5f1" },
    { id: StyleIds.DoorThickness, value: "20mm" },
    { id: StyleIds.ToekickHeight, value: "100mm" },
    { id: StyleIds.CountertopMaterial, value: "a9891e7c-1320-47fd-a656-90e9b34cb67c" }
  ];
  
  await cabinetStyle.loadStyles();
  
  // 2. åˆ›å»ºæ°´å¹³æ®µåœ°æŸœï¼ˆ3ä¸ªï¼‰
  const horizontalCabinets: NCustomizedParametricModel[] = [];
  for (let i = 0; i < 3; i++) {
    const cabinet = new NCustomizedParametricModel({
      contentType: CatalogContentTypeEnum.BaseCabinet,
      style: cabinetStyle
    });
    
    cabinet.parameters = {
      ID_W: 0.6,
      ID_D: 0.56,
      ID_H: 0.7,
      ID_board_thickness: 0.018
    };
    
    cabinet.position.set(i * 0.6, 0, 0);
    cabinet.compute();
    
    // æ·»åŠ æŠ½å±‰
    addDrawersToCabinet(cabinet);
    
    horizontalCabinets.push(cabinet);
    scene.add(cabinet);
  }
  
  // 3. åˆ›å»ºè½¬è§’æŸœ
  const cornerCabinet = new NCustomizedParametricModel({
    contentType: CatalogContentTypeEnum.CornerBaseCabinet,
    style: cabinetStyle
  });
  
  cornerCabinet.parameters = {
    ID_W: 0.8,
    ID_D: 0.8,
    ID_H: 0.7,
    ID_board_thickness: 0.018,
    ID_circle_r: 0.3,  // è½¬è§’åŠå¾„
    ID_body_flip: 1
  };
  
  cornerCabinet.position.set(1.8, 0, 0);
  cornerCabinet.compute();
  scene.add(cornerCabinet);
  
  // 4. åˆ›å»ºå‚ç›´æ®µåœ°æŸœï¼ˆ2ä¸ªï¼‰
  const verticalCabinets: NCustomizedParametricModel[] = [];
  for (let i = 0; i < 2; i++) {
    const cabinet = new NCustomizedParametricModel({
      contentType: CatalogContentTypeEnum.BaseCabinet,
      style: cabinetStyle
    });
    
    cabinet.parameters = {
      ID_W: 0.6,
      ID_D: 0.56,
      ID_H: 0.7,
      ID_board_thickness: 0.018
    };
    
    cabinet.position.set(1.8, 0, (i + 1) * 0.6);
    cabinet.rotation.y = Math.PI / 2;
    cabinet.compute();
    
    verticalCabinets.push(cabinet);
    scene.add(cabinet);
  }
  
  // 5. åˆ›å»ºç»Ÿä¸€å°é¢
  const countertop = createCountertopForCabinets([
    ...horizontalCabinets,
    cornerCabinet,
    ...verticalCabinets
  ], cabinetStyle);
  
  scene.add(countertop);
  
  // 6. æ·»åŠ åŠæŸœ
  const wallCabinets = createWallCabinets(cabinetStyle, horizontalCabinets.length);
  wallCabinets.forEach(wc => scene.add(wc));
  
  return {
    horizontalCabinets,
    cornerCabinet,
    verticalCabinets,
    countertop,
    wallCabinets
  };
}
```

### 11.8 çº¦æŸå†²çªæ£€æµ‹ç¤ºä¾‹

```typescript
// ç¤ºä¾‹8ï¼šæ£€æµ‹å¹¶è§£å†³çº¦æŸå†²çª
function detectAndResolveConflicts(cabinet: NCustomizedParametricModel) {
  // 1. åˆ›å»ºå†²çªæ£€æµ‹å™¨
  const detector = new ConstraintConflictDetector(cabinet.solver);
  
  // 2. æ£€æµ‹æ‰€æœ‰å†²çª
  const conflicts = detector.detectConflicts();
  
  // 3. å¤„ç†å†²çª
  if (conflicts.length > 0) {
    console.log(`å‘ç° ${conflicts.length} ä¸ªçº¦æŸå†²çªï¼š`);
    
    conflicts.forEach((conflict, index) => {
      console.log(`\nå†²çª ${index + 1}:`);
      console.log(`  ç±»å‹: ${conflict.type}`);
      console.log(`  ä¸¥é‡ç¨‹åº¦: ${conflict.severity}`);
      console.log(`  æ¶ˆæ¯: ${conflict.message}`);
      
      // æ ¹æ®å†²çªç±»å‹é‡‡å–æªæ–½
      switch (conflict.type) {
        case ConstraintConflictType.CIRCULAR_DEPENDENCY:
          console.log("  â†’ éœ€è¦é‡æ–°è®¾è®¡çº¦æŸå…³ç³»");
          break;
          
        case ConstraintConflictType.OVER_CONSTRAINED:
          console.log(`  â†’ çŠ¶æ€ ${conflict.stateId} è¢«å¤šä¸ªçº¦æŸå®šä¹‰`);
          console.log("  â†’ å»ºè®®ç§»é™¤å†—ä½™çº¦æŸ");
          break;
          
        case ConstraintConflictType.VALUE_OUT_OF_RANGE:
          console.log(`  â†’ çŠ¶æ€ ${conflict.stateId} å€¼è¶…å‡ºå…è®¸èŒƒå›´`);
          console.log("  â†’ è‡ªåŠ¨è°ƒæ•´åˆ°èŒƒå›´å†…");
          const state = cabinet.solver.states.get(conflict.stateId!);
          if (state && state.limitType === EN_VARIABLE_LIMIT_TYPE.INTERVAL) {
            state.value = Math.max(state.min!, Math.min(state.max!, state.value));
          }
          break;
          
        case ConstraintConflictType.INVALID_EQUATION:
          console.log(`  â†’ çº¦æŸ ${conflict.constraintId} çš„æ–¹ç¨‹æ— æ•ˆ`);
          console.log("  â†’ éœ€è¦ä¿®æ­£æ–¹ç¨‹è¯­æ³•");
          break;
      }
    });
    
    return false;  // å­˜åœ¨å†²çª
  } else {
    console.log("âœ“ æ‰€æœ‰çº¦æŸéªŒè¯é€šè¿‡ï¼Œæ— å†²çª");
    return true;
  }
}
```

---

## 12. æ€»ç»“

### 12.1 ç³»ç»Ÿç‰¹ç‚¹

1. **çº¦æŸé©±åŠ¨çš„å‚æ•°åŒ–å»ºæ¨¡**
   - è‡ªåŠ¨è®¡ç®—å‡ ä½•å‚æ•°
   - æ™ºèƒ½ä¼ æ’­å‚æ•°æ›´æ–°
   - å®æ—¶éªŒè¯çº¦æŸå†²çª

2. **çµæ´»çš„æŸœä½“ç³»ç»Ÿ**
   - æ”¯æŒå¤šç§æŸœä½“ç±»å‹
   - ç»Ÿä¸€çš„æ ·å¼ç®¡ç†
   - ä¸°å¯Œçš„éƒ¨ä»¶é€‰é¡¹

3. **å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›**
   - å­éƒ¨ä»¶åµŒå¥—ç³»ç»Ÿ
   - é˜µåˆ—å¤åˆ¶åŠŸèƒ½
   - è‡ªå®šä¹‰çº¦æŸæ”¯æŒ

4. **å®Œå–„çš„å†²çªå¤„ç†**
   - å¾ªç¯ä¾èµ–æ£€æµ‹
   - è¿‡çº¦æŸ/æ¬ çº¦æŸæ£€æµ‹
   - å€¼èŒƒå›´éªŒè¯

### 12.2 æ ¸å¿ƒä¼˜åŠ¿

âœ… **è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜**: çº¦æŸè‡ªåŠ¨æ±‚è§£ï¼Œå‚æ•°è‡ªåŠ¨ä¼ æ’­  
âœ… **çµæ´»æ€§å¼º**: æ”¯æŒè‡ªå®šä¹‰çº¦æŸå’Œå‚æ•°  
âœ… **æ‰©å±•æ€§å¥½**: å­éƒ¨ä»¶å’Œé˜µåˆ—ç³»ç»Ÿæ˜“äºæ‰©å±•  
âœ… **ç¨³å®šæ€§å¼º**: å®Œå–„çš„å†²çªæ£€æµ‹å’Œå¤„ç†æœºåˆ¶  
âœ… **æ€§èƒ½ä¼˜å¼‚**: æ‹“æ‰‘æ’åºä¼˜åŒ–è®¡ç®—é¡ºåº  

### 12.3 æŠ€æœ¯è¦ç‚¹

| æŠ€æœ¯ç‚¹ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|--------|----------|------|
| çº¦æŸæ±‚è§£ | æ‹“æ‰‘æ’åº + æ–¹ç¨‹æ±‚å€¼ | O(V+E)å¤æ‚åº¦ï¼Œé«˜æ•ˆç¨³å®š |
| å‚æ•°ä¼ æ’­ | ä¾èµ–å›¾ + é€’å½’ä¼ æ’­ | ç²¾ç¡®è¿½è¸ªå½±å“èŒƒå›´ |
| å†²çªæ£€æµ‹ | DFSç¯æ£€æµ‹ + è§„åˆ™éªŒè¯ | æå‰å‘ç°é—®é¢˜ |
| å­éƒ¨ä»¶ç®¡ç† | å±‚æ¬¡åŒ–ç®¡ç† + çº¦æŸç»§æ‰¿ | æ”¯æŒæ— é™åµŒå¥— |
| é˜µåˆ—ç³»ç»Ÿ | æ¨¡æ¿å…‹éš† + ä½ç½®è®¡ç®— | é«˜æ•ˆæ‰¹é‡åˆ›å»º |

### 12.4 åº”ç”¨åœºæ™¯

1. **å…¨å±‹å®šåˆ¶**
   - å¨æˆ¿æ©±æŸœè®¾è®¡
   - è¡£æŸœè¡£å¸½é—´è®¾è®¡
   - ä¹¦æŸœå‚¨ç‰©æŸœè®¾è®¡

2. **å•†ä¸šç©ºé—´**
   - å•†é“ºå±•ç¤ºæŸœ
   - åŠå…¬å®¤æ–‡ä»¶æŸœ
   - é¤é¥®åå¨è®¾å¤‡

3. **å‚æ•°åŒ–äº§å“**
   - å®¶å…·äº§å“é…ç½®å™¨
   - åœ¨çº¿å®šåˆ¶å·¥å…·
   - VR/ARå±•ç¤ºåº”ç”¨

### 12.5 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| çº¦æŸæ±‚è§£æ—¶é—´ | < 50ms | 100ä¸ªçº¦æŸ |
| å‚æ•°æ›´æ–°å“åº” | < 30ms | å•å‚æ•°æ›´æ–° |
| å­éƒ¨ä»¶åµŒå¥—å±‚çº§ | æ— é™åˆ¶ | ç†è®ºä¸Š |
| é˜µåˆ—å®ä¾‹æ•°é‡ | 1000+ | å•ä¸ªé˜µåˆ— |
| å†…å­˜å ç”¨ | ~50MB | æ ‡å‡†åœºæ™¯ |

### 12.6 æœªæ¥å±•æœ›

ğŸš€ **åŠŸèƒ½å¢å¼º**
- æ”¯æŒæ›´å¤æ‚çš„çº¦æŸç±»å‹ï¼ˆå¦‚æ›²é¢çº¦æŸï¼‰
- å¢åŠ ç‰©ç†ä»¿çœŸï¼ˆé‡åŠ›ã€ç¢°æ’ï¼‰
- æ”¯æŒåŠ¨ç”»çº¦æŸ

ğŸš€ **æ€§èƒ½ä¼˜åŒ–**
- å¢é‡å¼çº¦æŸæ±‚è§£
- å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—
- GPUåŠ é€Ÿå‡ ä½•è®¡ç®—

ğŸš€ **ç”¨æˆ·ä½“éªŒ**
- å¯è§†åŒ–çº¦æŸç¼–è¾‘å™¨
- æ™ºèƒ½çº¦æŸå»ºè®®
- çº¦æŸå†²çªè‡ªåŠ¨ä¿®å¤

---

## é™„å½•

### A. å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶è·¯å¾„ | æ¨¡å— | è¯´æ˜ |
|---------|------|------|
| `core-hs.fe5726b7.bundle_dewebpack/ncpconstantenum.js` | NCustomizedParametricModel | å‚æ•°åŒ–æ¨¡å‹åŸºç±» |
| `core-hs.fe5726b7.bundle_dewebpack/parametriccontentsubpart_io.js` | Subpart | å­éƒ¨ä»¶ç³»ç»Ÿ |
| `core-hs.fe5726b7.bundle_dewebpack/parametricmodelarray_io.js` | Array | é˜µåˆ—ç³»ç»Ÿ |
| 
`plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/cabinet.js` | Cabinet | æŸœä½“ç±»å‹å®šä¹‰ |
| `plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/cabinetpartsenum.js` | Parts | æŸœä½“éƒ¨ä»¶æšä¸¾ |
| `plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/userstylecategory.js` | Style | æ ·å¼ç³»ç»Ÿ |
| `plugins-hs-205d0ccf.fe5726b7.bundle_dewebpack/constrainthelper.js` | Constraint | çº¦æŸè¾…åŠ©å·¥å…· |

### B. çº¦æŸç±»å‹é€ŸæŸ¥è¡¨

| çº¦æŸç±»å‹ | æ–¹ç¨‹ç¤ºä¾‹ | è¯´æ˜ |
|---------|---------|------|
| position | `id_x = parent_x + offset` | ä½ç½®çº¦æŸ |
| dimension | `id_w = ID_W - 2 * thickness` | å°ºå¯¸çº¦æŸ |
| angle | `angle = atan2(dy, dx) * 180 / PI` | è§’åº¦çº¦æŸ |
| equation | `result = expr1 + expr2 * var` | é€šç”¨æ–¹ç¨‹ |
| distance | `dist = sqrt(dx*dx + dy*dy)` | è·ç¦»çº¦æŸ |

### C. å‚æ•°é™åˆ¶ç±»å‹é€ŸæŸ¥è¡¨

| é™åˆ¶ç±»å‹ | ä»£ç  | ç¤ºä¾‹ | è¯´æ˜ |
|---------|------|------|------|
| NONE | 0 | - | æ— é™åˆ¶ |
| INTERVAL | 1 | `[300, 1200]` | åŒºé—´é™åˆ¶ |
| FIXED | 2 | `600` | å›ºå®šå€¼ |
| EXPRESSION | 3 | `w - 2*t` | è¡¨è¾¾å¼ |
| OPTIONS | 4 | `["18mm", "20mm"]` | æšä¸¾é€‰é¡¹ |
| INCREMENT | 5 | `step: 10` | å¢é‡æ­¥è¿› |

### D. å¸¸ç”¨çº¦æŸæ–¹ç¨‹åº“

```typescript
// 1. ä½ç½®çº¦æŸ
"id_x = parent_x + offset_x"
"id_y = parent_y + offset_y"
"id_z = parent_z + offset_z"

// 2. å°ºå¯¸çº¦æŸ
"id_w = ID_W - 2 * ID_board_thickness"
"id_h = ID_H"
"id_d = ID_D - ID_board_thickness"

// 3. åœ†å¼§çº¦æŸ
"angle_start = Math.atan2(pt1_y - center_y, pt1_x - center_x) * 180 / Math.PI"
"angle_end = Math.atan2(pt2_y - center_y, pt2_x - center_x) * 180 / Math.PI"
"angle = angle_end - angle_start"

// 4. è·ç¦»çº¦æŸ
"distance = Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))"

// 5. æ¡ä»¶çº¦æŸ
"value = (condition) ? true_value : false_value"
"result = (ID_body_flip == 1) ? -ID_W/2 : ID_W/2"

// 6. ä¸‰è§’å‡½æ•°çº¦æŸ
"x = center_x + radius * Math.cos(angle * Math.PI / 180)"
"y = center_y + radius * Math.sin(angle * Math.PI / 180)"
```

### E. æ ·å¼IDå®Œæ•´åˆ—è¡¨

```typescript
// æè´¨ç±»
StyleIds.BodyMaterial          // æŸœä½“æè´¨
StyleIds.DoorMaterial          // é—¨æ¿æè´¨
StyleIds.HandleMaterial        // æŠŠæ‰‹æè´¨
StyleIds.GlassMaterial         // ç»ç’ƒæè´¨
StyleIds.CountertopMaterial    // å°é¢æè´¨
StyleIds.ToekickMaterial       // è¸¢è„šæè´¨
StyleIds.ToplineMaterial       // é¡¶çº¿æè´¨
StyleIds.LightlineMaterial     // ç¯çº¿æè´¨
StyleIds.WallMaterial          // å¢™ä½“æè´¨
StyleIds.FloorMaterial         // åœ°é¢æè´¨

// æ ·å¼ç±»
StyleIds.DoorStyle             // é—¨æ¿æ ·å¼
StyleIds.HandleStyle           // æŠŠæ‰‹æ ·å¼
StyleIds.ToekickStyle          // è¸¢è„šæ ·å¼
StyleIds.ToplineStyle          // é¡¶çº¿æ ·å¼
StyleIds.LightlineStyle        // ç¯çº¿æ ·å¼
StyleIds.FrontsplashStyle      // å‰æŒ¡æ°´æ ·å¼
StyleIds.BacksplashStyle       // åæŒ¡æ°´æ ·å¼
StyleIds.ClosingBoardStyle     // å°æ¿æ ·å¼
StyleIds.DrawerDoorStyle       // æŠ½å±‰é—¨æ ·å¼
StyleIds.ApplianceStyle        // ç”µå™¨æ ·å¼
StyleIds.BasketStyle           // æ‹‰ç¯®æ ·å¼
StyleIds.BarLegStyle           // å§å°è…¿æ ·å¼

// å‚æ•°ç±»
StyleIds.DoorThickness         // é—¨æ¿åšåº¦
StyleIds.ToekickHeight         // è¸¢è„šé«˜åº¦
StyleIds.BaseCabinetHeight     // åœ°æŸœé«˜åº¦
```

### F. æŸœä½“éƒ¨ä»¶å®Œæ•´åˆ—è¡¨

```typescript
CabinetPartsEnum = {
  Body: "cabinetbody",                      // æŸœä½“
  Door: "Door",                             // é—¨æ¿
  Handle: "Handle",                         // æŠŠæ‰‹
  Drawer: "Drawer",                         // æŠ½å±‰
  Basket: "Basket",                         // æ‹‰ç¯®
  Appliance: "Appliance",                   // ç”µå™¨
  NoDripEdge: "NoDripEdge",                 // å‰æŒ¡æ°´
  Backsplash: "Backsplash",                 // åæŒ¡æ°´
  Countertop: "Countertop",                 // å°é¢
  Topline: "Topline",                       // é¡¶çº¿
  Toekick: "Toekick",                       // è¸¢è„šçº¿
  Lightline: "Lightline",                   // ç¯çº¿
  ZipboardL: "ZipboardL",                   // Lå‹è£…é¥°æ¿
  ZipboardI: "ZipboardI",                   // Iå‹è£…é¥°æ¿
  BarCounter: "BarCounter",                 // å§å°
  Lightboard: "Lightboard",                 // ç¯æ¿
  SideDeco: "SideDeco",                     // ä¾§è£…é¥°
  SlidingDoorSideBoard: "SlidingDoorSideBoard",  // æ¨æ‹‰é—¨ä¾§æ¿
  ClosingBoard: "ClosingBoard",             // å°æ¿
  BarLeg: "BarLeg",                         // å§å°è…¿
  DrawerDoor: "DrawerDoor"                  // æŠ½å±‰é—¨
}
```

### G. å¸¸è§é—®é¢˜ FAQ

**Q1: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰çº¦æŸï¼Ÿ**
```typescript
// åœ¨æ¨¡å‹çš„constraintsæ•°ç»„ä¸­æ·»åŠ æ–°çš„çº¦æŸå¯¹è±¡
cabinet.constraints.push({
  localId: "my_custom_constraint",
  type: "equation",
  equation: "custom_value = param1 * 2 + param2",
  output: "custom_value",
  _des: "è‡ªå®šä¹‰çº¦æŸ"
});
```

**Q2: å¦‚ä½•å¤„ç†çº¦æŸå†²çªï¼Ÿ**
```typescript
// ä½¿ç”¨å†²çªæ£€æµ‹å™¨
const detector = new ConstraintConflictDetector(cabinet.solver);
const conflicts = detector.detectConflicts();
// æ ¹æ®å†²çªç±»å‹è¿›è¡Œå¤„ç†
```

**Q3: å¦‚ä½•ä¼˜åŒ–çº¦æŸæ±‚è§£æ€§èƒ½ï¼Ÿ**
- å‡å°‘çº¦æŸæ•°é‡ï¼Œåˆå¹¶ç›¸ä¼¼çº¦æŸ
- ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—
- ä¼˜åŒ–çº¦æŸè¡¨è¾¾å¼ï¼Œé¿å…å¤æ‚è¿ç®—
- ä½¿ç”¨å¢é‡å¼æ›´æ–°ï¼Œåªè®¡ç®—å—å½±å“çš„çº¦æŸ

**Q4: å­éƒ¨ä»¶å¦‚ä½•ç»§æ‰¿çˆ¶å¯¹è±¡çš„çº¦æŸï¼Ÿ**
```typescript
// å­éƒ¨ä»¶çš„çº¦æŸä¼šè‡ªåŠ¨æ·»åŠ åˆ°çˆ¶å¯¹è±¡çš„çº¦æŸç³»ç»Ÿä¸­
subpartManager.addSubpart(subpart);
// çˆ¶å¯¹è±¡çš„çº¦æŸæ±‚è§£å™¨ä¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰çº¦æŸ
```

**Q5: å¦‚ä½•å®ç°åŠ¨æ€é˜µåˆ—ï¼Ÿ**
```typescript
// åˆ›å»ºé˜µåˆ—åå¯ä»¥åŠ¨æ€æ›´æ–°
arrayManager.updateArray(arrayId);
// æˆ–è€…é‡æ–°ç”Ÿæˆ
array.generate();
```

### H. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **çº¦æŸä¼˜åŒ–**
   - âœ… ä½¿ç”¨ç®€å•è¡¨è¾¾å¼
   - âœ… é¿å…å¾ªç¯ä¾èµ–
   - âœ… å‡å°‘çº¦æŸæ•°é‡
   - âœ… ç¼“å­˜è®¡ç®—ç»“æœ

2. **å‡ ä½•ä¼˜åŒ–**
   - âœ… ä½¿ç”¨LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰
   - âœ… å®ä¾‹åŒ–é‡å¤å‡ ä½•
   - âœ… åˆå¹¶é™æ€ç½‘æ ¼
   - âœ… ä½¿ç”¨GPUå®ä¾‹åŒ–

3. **å†…å­˜ä¼˜åŒ–**
   - âœ… åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„èµ„æº
   - âœ… ä½¿ç”¨å¯¹è±¡æ± 
   - âœ… å‹ç¼©çº¹ç†
   - âœ… å»¶è¿ŸåŠ è½½

4. **æ¸²æŸ“ä¼˜åŒ–**
   - âœ… è§†é”¥è£å‰ª
   - âœ… é®æŒ¡å‰”é™¤
   - âœ… æ‰¹é‡æ¸²æŸ“
   - âœ… å‡å°‘draw call

### I. è°ƒè¯•æŠ€å·§

```typescript
// 1. æ‰“å°ä¾èµ–å›¾
console.log(dependencyGraph.visualize());

// 2. è¿½è¸ªçº¦æŸè®¡ç®—
constraint.compute = function() {
  console.log(`Computing ${this.localId}: ${this.equation}`);
  // åŸè®¡ç®—é€»è¾‘
};

// 3. ç›‘æ§å‚æ•°å˜åŒ–
parameter.setValue = function(newValue) {
  console.log(`Parameter ${this.id} changed: ${this.value} â†’ ${newValue}`);
  this.value = newValue;
};

// 4. æ£€æµ‹æ€§èƒ½ç“¶é¢ˆ
console.time("constraint solving");
solver.solve();
console.timeEnd("constraint solving");
```

---

## å‚è€ƒèµ„æº

### ç›¸å…³æ–‡æ¡£
- [çº¦æŸç³»ç»Ÿå®Œæ•´åˆ†æ](./constraint-system-complete-analysis.md)
- [å®šåˆ¶èƒŒæ™¯å¢™æ¶æ„](./customized-background-wall-complete-architecture.md)
- [åŠé¡¶å»ºæ¨¡æ¶æ„](./ceiling-modeling-complete-architecture.md)
- [å¹³å°ç³»ç»Ÿæ¶æ„](./platform-system-complete-architecture.md)

### æŠ€æœ¯å‚è€ƒ
- çº¦æŸæ±‚è§£ï¼šæ‹“æ‰‘æ’åºç®—æ³•ã€Kahnç®—æ³•
- ä¾èµ–å›¾ï¼šæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ã€æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰
- å‚æ•°åŒ–å»ºæ¨¡ï¼šè¡¨è¾¾å¼è§£æã€ä¾èµ–è¿½è¸ª
- ç¢°æ’æ£€æµ‹ï¼šAABBåŒ…å›´ç›’ã€ç©ºé—´åˆ†åŒº

### å¼€å‘å·¥å…·
- TypeScriptç±»å‹æ£€æŸ¥
- ESLintä»£ç è§„èŒƒ
- Chrome DevToolsæ€§èƒ½åˆ†æ
- Three.jså‡ ä½•å¯è§†åŒ–

---

## æ–‡æ¡£ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è¯´æ˜ |
|------|------|------|------|
| 1.0 | 2026-01-22 | HYZ | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´11å±‚æ¶æ„ |

---

**æ–‡æ¡£å®Œæˆæ ‡è®°**: âœ… **å®Œæ•´æ¶æ„åˆ†ææ–‡æ¡£å·²åˆ›å»º**

- âœ… çº¦æŸç³»ç»Ÿå®Œæ•´å®ç°ç»†èŠ‚ï¼ˆç¬¬2ç« ï¼‰
- âœ… å‚æ•°åŒ–ç³»ç»Ÿå®Œæ•´å®ç°ç»†èŠ‚ï¼ˆç¬¬3ç« ï¼‰
- âœ… å®šåˆ¶å®¶å…·æ ¸å¿ƒç±»ï¼ˆç¬¬4ç« ï¼‰
- âœ… æŸœä½“ç³»ç»Ÿè¯¦ç»†åˆ†æï¼ˆç¬¬5ç« ï¼‰
- âœ… å­éƒ¨ä»¶ç³»ç»Ÿï¼ˆç¬¬6ç« ï¼‰
- âœ… é˜µåˆ—ç³»ç»Ÿï¼ˆç¬¬7ç« ï¼‰
- âœ… æ ¸å¿ƒç®—æ³•ä¼ªä»£ç ï¼ˆç¬¬8ç« ï¼‰
- âœ… æ•°æ®æµä¸çŠ¶æ€ç®¡ç†ï¼ˆç¬¬9ç« ï¼‰
- âœ… TypeScriptå®Œæ•´ç±»å‹å®šä¹‰ï¼ˆç¬¬10ç« ï¼‰
- âœ… å®æˆ˜ç¤ºä¾‹ï¼ˆç¬¬11ç« ï¼‰
- âœ… æ€»ç»“ä¸é™„å½•ï¼ˆç¬¬12ç« åŠé™„å½•ï¼‰

**æ€»å­—æ•°**: ~15,000å­—  
**ä»£ç ç¤ºä¾‹**: 50+  
**æµç¨‹å›¾**: 2ä¸ª  
**æ¶æ„å±‚çº§**: 11å±‚å®Œæ•´æ¶æ„ï¼ˆæ— çœç•¥ï¼‰

---

**END OF DOCUMENT**



---

# ç¬¬12ç«  ç©ºé—´çº¦æŸä¸éšœç¢ç‰©ç³»ç»Ÿ

## 12.1 ç³»ç»Ÿæ¦‚è¿°

ç©ºé—´çº¦æŸä¸éšœç¢ç‰©ç³»ç»Ÿæ˜¯å®šåˆ¶å®¶å…·è®¾è®¡çš„æ ¸å¿ƒçº¦æŸå¼•æ“ï¼Œè´Ÿè´£å¤„ç†å®¶å…·ä¸å¢™é¢ã€éšœç¢ç‰©ã€å…¶ä»–å®¶å…·ä¹‹é—´çš„ç©ºé—´å…³ç³»ã€‚æœ¬ç« åŸºäºå®é™…ä»£ç æ·±åº¦åˆ†æç³»ç»Ÿå®ç°ã€‚

### 12.1.1 æ ¸å¿ƒèŒè´£

1. **å¢™é¢å¸é™„çº¦æŸ** - å®¶å…·è‡ªåŠ¨è´´å¢™æ”¾ç½®ï¼ˆ30mmå¸é™„é˜ˆå€¼ï¼‰
2. **éšœç¢ç‰©æ£€æµ‹** - è¯†åˆ«é—¨çª—ã€å¼€å…³ã€æ’åº§ç­‰éšœç¢
3. **ç¢°æ’é¿è®©** - ä½¿ç”¨Clipperåº“å®ç°é«˜ç²¾åº¦å¤šè¾¹å½¢è£å‰ª
4. **æŸœä½“å¯¹é½** - ç›¸é‚»æŸœä½“çš„å¯¹é½çº¦æŸ
5. **ç©ºé—´å¸ƒå±€** - æˆ¿é—´è¾¹ç•Œå’Œå‡€ç©ºçº¦æŸ

### 12.1.2 æŠ€æœ¯æ¶æ„

```
çº¦æŸç³»ç»Ÿå±‚æ¬¡ç»“æ„ï¼ˆåŸºäºå®é™…æ¨¡å—ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·äº¤äº’å±‚ (UI Events)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   çº¦æŸæ±‚è§£å™¨ (ConstraintSolver)                 â”‚
â”‚   - ConstraintHelper (Module 223024)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¢™é¢å¸é™„         â”‚    éšœç¢ç‰©æ£€æµ‹               â”‚
â”‚  AlignWall         â”‚   Obstacle (Module 425466) â”‚
â”‚  (Module in        â”‚   - NgObstacle             â”‚
â”‚   alignwall.js)    â”‚   - NgFlue/Column/Beam     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç¢°æ’å¼•æ“ (Module 79901)                        â”‚
â”‚   - ClipPolygon (Clipperåº“å°è£…)                 â”‚
â”‚   - OffsetPolygon                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å‡ ä½•å·¥å…· (GeometryUtil Module 8013)           â”‚
â”‚   - getContentBaseWallScope                      â”‚
â”‚   - getContentBaseObstacleLoops                  â”‚
â”‚   - getVerticalToWall                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ¨¡å—è¯´æ˜**ï¼š
- **Module 8013**: GeometryUtil - å‡ ä½•è®¡ç®—æ ¸å¿ƒ
- **Module 79901**: Collision - ç¢°æ’æ£€æµ‹å¼•æ“
- **Module 223024**: ConstraintHelper - çº¦æŸè¾…åŠ©
- **Module 425466**: Obstacleç›¸å…³ç±»å‹å®šä¹‰

---

## 12.2 å¢™é¢å¸é™„ç³»ç»Ÿ

### 12.2.1 å¢™é¢å¸é™„åŸç†

**ä»£ç ä½ç½®**ï¼š`dist/plugins-hs-dd89ef02.fe5726b7.bundle_dewebpack/alignwall.js` è¡Œ134-144

å¢™é¢å¸é™„ç³»ç»Ÿé€šè¿‡è®¡ç®—å®¶å…·ä¸­å¿ƒç‚¹åˆ°å¢™é¢çš„æœ€çŸ­è·ç¦»ï¼Œå½“è·ç¦»å°äºé˜ˆå€¼æ—¶è‡ªåŠ¨å¸é™„åˆ°å¢™é¢ã€‚

```javascript
// AlignWall._getNearPathæ–¹æ³• - å¢™é¢å¸é™„è·ç¦»æ£€æµ‹
// æ–‡ä»¶ï¼šalignwall.js è¡Œ134-144
_getNearPath: function(e, t) {
    var n = this,
    // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºæ¨¡å‹åæ ‡
    i = d.HSApp.View.SVG.Util.ScreenPointToModel([e, t], this.context),
    a = new p.Vector2(i[0], i[1]);
    
    // éå†æ‰€æœ‰è·¯å¾„é¡¹ï¼ŒæŸ¥æ‰¾è·ç¦»å°äºé˜ˆå€¼çš„å¢™é¢
    return this._pathItems.find((function(e) {
        // è·å–ç‚¹åˆ°å¢™é¢æ›²çº¿çš„æœ€è¿‘ç‚¹
        var t = n._getCurveByMode(e.wall, e.mode).getClosestPoint(a);
        // å…³é”®ï¼šå¸é™„é˜ˆå€¼ä¸º0.03ï¼ˆå³30mmï¼‰
        return a.distanceTo(t) < .03
    }))
}
```

**å…³é”®å‚æ•°**ï¼š
- **å¸é™„é˜ˆå€¼**ï¼š`0.03` ç±³ï¼ˆ30mmï¼‰
- **æ£€æµ‹æ–¹å¼**ï¼šè®¡ç®—ç‚¹åˆ°å¢™é¢æ›²çº¿çš„æœ€è¿‘ç‚¹è·ç¦»
- **åæ ‡è½¬æ¢**ï¼šå±å¹•åæ ‡ â†’ æ¨¡å‹åæ ‡

**å¸é™„è§¦å‘æµç¨‹**ï¼š
```
ç”¨æˆ·æ‹–åŠ¨å®¶å…·
    â†“
å±å¹•åæ ‡è½¬æ¢ä¸ºæ¨¡å‹åæ ‡
    â†“
è®¡ç®—åˆ°æ‰€æœ‰å¢™é¢çš„æœ€è¿‘è·ç¦»
    â†“
è·ç¦» < 30mmï¼Ÿ
    â†“ æ˜¯
æ¿€æ´»å¸é™„ï¼Œæ˜¾ç¤ºå¸é™„æç¤º
    â†“
è‡ªåŠ¨å¯¹é½åˆ°å¢™é¢
```

### 12.2.2 å¢™é¢èŒƒå›´è®¡ç®—

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/geometryutil_2.js` è¡Œ280-344

ç³»ç»Ÿé€šè¿‡`getContentBaseWallScope`æ–¹æ³•è®¡ç®—å¢™é¢çš„æœ‰æ•ˆæ”¾ç½®èŒƒå›´ï¼š

```javascript
// GeometryUtil.getContentBaseWallScope - è·å–å¢™é¢å¯æ”¾ç½®èŒƒå›´
// æ–‡ä»¶ï¼šgeometryutil_2.js è¡Œ280-344
a.getContentBaseWallScope = function (e, t) {
    // è·å–å¢™é¢å‡ ä½•ä¿¡æ¯
    const o = function (e) {
        const t = HSCore.Doc.getDocManager().geometryManager.getGeometry(e);
        if (!t) return;
        
        // è·å–å¢™é¢å†…å¤–è½®å»“ç‚¹ç´¢å¼•
        const o = {
            from: t.geometry[t.indices[0]],  // å†…ä¾§èµ·ç‚¹
            to: t.geometry[t.indices[1]]      // å†…ä¾§ç»ˆç‚¹
        },
        i = {
            from: t.geometry[t.indices[3]],  // å¤–ä¾§èµ·ç‚¹
            to: t.geometry[t.indices[2]]      // å¤–ä¾§ç»ˆç‚¹
        };
        
        // æ„å»ºå¢™é¢3Dåæ ‡æ¡†æ¶
        return {
            innerPoints: {
                topLeft: new THREE.Vector3(o.to.x, o.to.y, e.height3d),
                bottomLeft: new THREE.Vector3(o.to.x, o.to.y, 0),
                bottomRight: new THREE.Vector3(o.from.x, o.from.y, 0),
                topRight: new THREE.Vector3(o.from.x, o.from.y, e.height3d)
            },
            outerPoints: {
                topLeft: new THREE.Vector3(i.from.x, i.from.y, e.height3d),
                bottomLeft: new THREE.Vector3(i.from.x, i.from.y, 0),
                bottomRight: new THREE.Vector3(i.to.x, i.to.y, 0),
                topRight: new THREE.Vector3(i.to.x, i.to.y, e.height3d)
            }
        }
    }(t);
    
    if (!o) return;
    
    const i = o.innerPoints,
    // æ„å»ºå¢™é¢å¹³é¢æ–¹ç¨‹
    n = (new THREE.Plane).setFromCoplanarPoints(
        i.topLeft, i.bottomLeft, i.bottomRight
    ),
    // è®¡ç®—å¢™é¢æ–¹å‘å‘é‡
    r = i.bottomLeft.clone().sub(i.bottomRight).clone().normalize(),
    // æŠ•å½±è®¡ç®—å‡½æ•°
    a = function (e, o, i) {
        const n = o.clone().projectOnVector(i),
        r = e.bottomLeft.clone().sub(n).dot(i),
        a = e.bottomRight.clone().sub(n).dot(i);
        
        // è¿”å›2DæŠ•å½±èŒƒå›´ [å·¦ä¸‹, å³ä¸‹, å³ä¸Š, å·¦ä¸Š]
        return [{
            x: r,
            y: 0
        }, {
            x: a,
            y: 0
        }, {
            x: a,
            y: t.height3d
        }, {
            x: r,
            y: t.height3d
        }]
    }(i, n.projectPoint((new THREE.Vector3).copy(e)), r);
    
    return a  // è¿”å›å¢™é¢2Då¯æ”¾ç½®èŒƒå›´
}
```

**åŠŸèƒ½è¯´æ˜**ï¼š
1. **è·å–å¢™é¢å‡ ä½•ä¿¡æ¯**ï¼šå†…å¤–è½®å»“ç‚¹ï¼ˆ4ä¸ªå…³é”®ç‚¹ï¼‰
2. **æ„å»º3Dåæ ‡æ¡†æ¶**ï¼šåŒ…å«é¡¶éƒ¨å’Œåº•éƒ¨çš„8ä¸ªé¡¶ç‚¹
3. **å»ºç«‹å¢™é¢å¹³é¢**ï¼šä½¿ç”¨3ç‚¹ç¡®å®šå¹³é¢æ–¹ç¨‹
4. **æŠ•å½±åˆ°2Då¹³é¢**ï¼šå°†3Då¢™é¢æŠ•å½±ä¸º2DçŸ©å½¢
5. **è¿”å›å¯æ”¾ç½®èŒƒå›´**ï¼š[å·¦ä¸‹, å³ä¸‹, å³ä¸Š, å·¦ä¸Š] 4ä¸ªé¡¶ç‚¹

**å¢™é¢å‡ ä½•ç»“æ„**ï¼š
```
        topLeft â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— topRight
               /|            /|
              / |           / |
bottomLeft  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—  | â† height3d
            |  |          |  |
            |  â—----------|--â— (å¤–ä¾§)
            | /           | /
            |/            |/
            â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— bottomRight
         (å†…ä¾§)
```

### 12.2.3 å¢™é¢æ³•çº¿è®¡ç®—

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/geometryutil_2.js` è¡Œ428-449

```javascript
// GeometryUtil.getVerticalToWall - è®¡ç®—å¢™é¢å‚ç›´æ–¹å‘ï¼ˆæ³•çº¿ï¼‰
// æ–‡ä»¶ï¼šgeometryutil_2.js è¡Œ428-449
a.getVerticalToWall = function (e) {
    // å¢™é¢èµ·ç‚¹å’Œç»ˆç‚¹
    const t = new THREE.Vector3(e.from.x, e.from.y, e.from.z),
    o = new THREE.Vector3(e.to.x, e.to.y, e.to.z),
    
    // å¢™é¢æ–¹å‘å‘é‡
    i = (new THREE.Vector3).subVectors(o, t),
    
    // è®¡ç®—å‚ç›´æ–œç‡ï¼ˆ2Då¹³é¢ï¼‰
    n = -(o.x - t.x) / (o.y - t.y - 1e-6),  // åŠ 1e-6é˜²æ­¢é™¤é›¶
    
    // å¢™é¢ä¸­ç‚¹
    r = {
        x: (o.x + t.x) / 2,
        y: (o.y + t.y) / 2,
        z: (o.z + t.z) / 2
    },
    
    // å‚çº¿ä¸Šçš„å¦ä¸€ç‚¹ï¼ˆy=0æ—¶ï¼‰
    a = {
        x: 0,
        y: r.y - n * r.x,
        z: r.z
    };
    
    // è®¡ç®—æ³•çº¿å‘é‡å¹¶å½’ä¸€åŒ–
    let s = (new THREE.Vector3).subVectors(a, r).normalize();
    
    // ç¡®ä¿æ³•çº¿æŒ‡å‘å¢™é¢å·¦ä¾§ï¼ˆå®¤å†…æ–¹å‘ï¼‰
    GeLib.VectorUtils.isOnLeft(s, (new THREE.Vector3).copy(i)) || 
        s.multiplyScalar(-1);
    
    return s  // è¿”å›å•ä½æ³•çº¿å‘é‡
}
```

**ç®—æ³•è¯´æ˜**ï¼š
1. **2Då‚ç›´æ–œç‡**ï¼škâŠ¥ = -1/k = -(Î”x/Î”y)
2. **ä¸­ç‚¹è®¡ç®—**ï¼šå¢™é¢èµ·ç‚¹å’Œç»ˆç‚¹çš„ä¸­ç‚¹
3. **æ³•çº¿æ–¹å‘**ï¼šä»ä¸­ç‚¹æ²¿å‚ç›´æ–¹å‘å»¶ä¼¸
4. **æ–¹å‘ä¿®æ­£**ï¼šç¡®ä¿æ³•çº¿æŒ‡å‘å®¤å†…ï¼ˆå·¦ä¾§ï¼‰

**æ³•çº¿ç”¨é€”**ï¼š
- å®¶å…·æ‘†æ”¾æ–¹å‘æ§åˆ¶
- å®šåˆ¶æ¨¡å‹æŠ•å½±æ–¹å‘
- å°é¢å»¶ä¼¸æ–¹å‘è®¡ç®—

---

## 12.3 éšœç¢ç‰©æ£€æµ‹ä¸é¿è®©

### 12.3.1 éšœç¢ç‰©ç±»å‹ç³»ç»Ÿ

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/obstacle.js` (Module 425466)

ç³»ç»Ÿæ”¯æŒå¤šç§éšœç¢ç‰©ç±»å‹ï¼š

```javascript
// éšœç¢ç‰©ç±»å‹å®šä¹‰
// æ–‡ä»¶ï¼šobstacle.js (Module 425466)
const obstacleTypes = [
    HSConstants.ModelClass.NgObstacle,        // é€šç”¨éšœç¢ç‰©
    HSConstants.ModelClass.NgFlue,            // çƒŸé“
    HSConstants.ModelClass.NgColumn,          // æŸ±å­
    HSConstants.ModelClass.NgBeam,            // æ¨ªæ¢
    HSConstants.ModelClass.NgOpening,         // é—¨çª—æ´å£
    HSConstants.ModelClass.NgCornerWindow,    // è½¬è§’çª—
    

    HSConstants.ModelClass.NgCustomizedModel,  // å®šåˆ¶æ¨¡å‹éšœç¢
    HSConstants.ModelClass.NgSwitch,           // å¼€å…³
    HSConstants.ModelClass.NgSocket,           // æ’åº§
    HSConstants.ModelClass.NgPipe              // ç®¡é“
];
```

**éšœç¢ç‰©åˆ†ç±»**ï¼š
- **ç»“æ„æ€§éšœç¢**ï¼šçƒŸé“ã€æŸ±å­ã€æ¨ªæ¢ï¼ˆä¸å¯ç§»åŠ¨ï¼‰
- **å¼€å£éšœç¢**ï¼šé—¨ã€çª—ã€è½¬è§’çª—ï¼ˆå½±å“æŠ•å½±ï¼‰
- **è®¾æ–½éšœç¢**ï¼šå¼€å…³ã€æ’åº§ã€ç®¡é“ï¼ˆéœ€è¦é¿è®©ï¼‰
- **å®šåˆ¶éšœç¢**ï¼šå…¶ä»–å®šåˆ¶æ¨¡å‹

### 12.3.2 éšœç¢ç‰©æŠ•å½±è®¡ç®—

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/geometryutil_2.js` è¡Œ496-516

```javascript
// GeometryUtil.getContentBaseObstacleLoops - è·å–éšœç¢ç‰©æŠ•å½±å¾ªç¯
// æ–‡ä»¶ï¼šgeometryutil_2.js è¡Œ496-516
a.getContentBaseObstacleLoops = function (e, t, o) {
    let i = [];
    const n = t;
    
    return n && n.length > 0 && n.forEach((t => {
        // å¤„ç†ä¸åŒç±»å‹éšœç¢ç‰©
        if (t.instanceOf(HSConstants.ModelClass.NgOpening)) {
            // 1. é—¨çª—æ´å£ï¼šè®¡ç®—æ´å£æŠ•å½±å¾ªç¯
            const n = a._getOpeningClipLoop(t, o, e);
            n && i.push(n)
            
        } else if (t.instanceOf(HSConstants.ModelClass.NgCornerWindow)) {
            // 2. è½¬è§’çª—ï¼šå¯èƒ½æœ‰å¤šä¸ªçª—æ´
            const n = a._getCornerWindowClipLoops(t, o, e);
            n && n.length > 0 && (i = i.concat(n))
            
        } else if (t.instanceOf(HSConstants.ModelClass.NgCustomizedModel)) {
            // 3. å®šåˆ¶æ¨¡å‹ï¼šè·å–ä¸å¢™é¢å…±é¢çš„è·¯å¾„
            const n = a._getCustomizedClipLoops(t, o, e);
            n && n.length > 0 && (i = i.concat(n))
        }
    })),
    
    i  // è¿”å›æ‰€æœ‰éšœç¢ç‰©çš„æŠ•å½±å¾ªç¯æ•°ç»„
}
```

**éšœç¢ç‰©æŠ•å½±æµç¨‹**ï¼š
```
éå†æ‰€æœ‰éšœç¢ç‰©
    â†“
åˆ¤æ–­éšœç¢ç‰©ç±»å‹
    â†“
â”œâ”€ NgOpening â†’ _getOpeningClipLoop
â”œâ”€ NgCornerWindow â†’ _getCornerWindowClipLoops
â””â”€ NgCustomizedModel â†’ _getCustomizedClipLoops
    â†“
è®¡ç®—éšœç¢ç‰©åœ¨å¢™é¢ä¸Šçš„æŠ•å½±
    â†“
è¿”å›æŠ•å½±å¤šè¾¹å½¢å¾ªç¯
```

### 12.3.3 é—¨çª—æ´å£æŠ•å½±

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/geometryutil_2.js` è¡Œ404-416

```javascript
// GeometryUtil._getOpeningClipLoop - è·å–æ´å£è£å‰ªå¾ªç¯
// æ–‡ä»¶ï¼šgeometryutil_2.js è¡Œ404-416
a._getOpeningClipLoop = function (e, t, o) {
    // 1. è·å–æ´å£è½®å»“
    const i = a.getOpeningLoop(e),
    
    // 2. è®¡ç®—æ´å£ç›¸å¯¹å¢™é¢çš„åç§»
    {
        offsetX: n,
        offsetY: r
    } = a._getOffsetContentBase(e, t, o);
    
    // 3. åº”ç”¨åç§»åˆ°æ´å£è½®å»“
    return i.forEach((e => {
        e.x += n;   // æ°´å¹³åç§»
        e.y += r;   // å‚ç›´åç§»
    })),
    i
}
```

### 12.3.4 å®šåˆ¶æ¨¡å‹æŠ•å½±

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/geometryutil_2.js` è¡Œ451-494

```javascript
// GeometryUtil._getCustomizedClipLoops - è·å–å®šåˆ¶æ¨¡å‹è£å‰ªå¾ªç¯
// æ–‡ä»¶ï¼šgeometryutil_2.js è¡Œ451-494
a._getCustomizedClipLoops = function (e, t, o) {
    const i = HSCore.Doc.getDocManager().getGeometry(t);
    if (!i || !i.geometry) return;
    
    const n = i.geometry[i.indices[0]],  // å¢™é¢èµ·ç‚¹
    r = i.geometry[i.indices[1]],        // å¢™é¢ç»ˆç‚¹
    s = [],
    
    // å¢™é¢æ–¹å‘å‘é‡
    l = (new THREE.Vector3).subVectors(r, n).normalize(),
    // å¢™é¢æ³•çº¿
    c = a.getVerticalToWall(t),
    // è·å–ä¸å¢™é¢å…±é¢çš„è·¯å¾„
    d = e.getPathsCoplanarWithWall(t, void 0);
    
    if (!d || 0 === d.length) return;
    
    const {
        offsetX: h,
        offsetY: u
    } = a._getOffsetContentBase(e, t, o),
    g = .5 * e.ZSize;  // æ¨¡å‹é«˜åº¦çš„ä¸€åŠ
    
    // å¤„ç†æ¯ä¸ªå…±é¢è·¯å¾„
    return d.forEach((e => {
        const t = e[0],
        // æ„å»ºæŠ•å½±å¹³é¢
        o = GeLib.PolygonUtils.getPlaneFromPolygon(t);
        
        if (o) {
            o.xRay = l.clone().negate();  // Xè½´ï¼šå¢™é¢åæ–¹å‘
            o.normal = c;                  // æ³•çº¿ï¼šå¢™é¢å‚ç›´æ–¹å‘
            
            // æŠ•å½±åˆ°2Då¹³é¢
            let i = GeLib.PlaneUtils.getProjected2DPath(o, t);
            const n = GeLib.PolygonUtils.getPolygonBoundingBox(i);
            
            // åº”ç”¨åç§»
            i = i.map((e => e.clone().sub(n.center).add({
                x: h,
                y: u + g  // åŠ ä¸Šæ¨¡å‹é«˜åº¦åç§»
            })));
            
            s.push(i);
            
            // å¤„ç†å†…éƒ¨å­”æ´
            for (let t = 1; t < e.length; t++) {
                let i = GeLib.PlaneUtils.getProjected2DPath(o, e[t]);
                const n = GeLib.PolygonUtils.getPolygonBoundingBox(i);
                i = i.map((e => e.clone().sub(n.center).add({
                    x: h,
                    y: u + g
                })));
                s.push(i)
            }
        }
    })),
    s
}
```

---

## 12.4 ç¢°æ’æ£€æµ‹å¼•æ“ï¼ˆClipPolygonï¼‰

### 12.4.1 Clipperåº“å°è£…

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/module_79901.js` è¡Œ86-197

ç³»ç»Ÿä½¿ç”¨Clipperåº“ï¼ˆClipperLibWasmï¼‰å®ç°é«˜æ€§èƒ½çš„å¤šè¾¹å½¢å¸ƒå°”è¿ç®—ï¼š

```javascript
// Collision.ClipPolygon - å¤šè¾¹å½¢è£å‰ªæ ¸å¿ƒå‡½æ•°
// æ–‡ä»¶ï¼šmodule_79901.js è¡Œ86-197
ClipPolygon(e, t, o) {
    return this._ClipPolygon(e, t, o, !1)
},

ClipPolygon2(e, t, o) {
    // è¿”å›å¤–è½®å»“+å­”æ´çš„ç»“æ„åŒ–æ•°æ®
    return this._ClipPolygon(e, t, o, !0)
},

_ClipPolygon(e, t, o, i) {
    // 1. æ£€æŸ¥Clipperåº“æ˜¯å¦åŠ è½½
    if (!ClipperLibInstance) 
        return assert(!1, "The collision detection expected Clipper library.", "HSCore.Util"), [];
    
    // 2. ç©ºæ£€æµ‹
    if (!t || 0 === t.length) return e;
    
    const a = 1e6;  // ç²¾åº¦å› å­ï¼šæ”¾å¤§100ä¸‡å€
    
    // 3. æ”¾å¤§åæ ‡æé«˜ç²¾åº¦
    e = ClipperLibInstance.scalePaths(e, a);
    this.FixReversedPaths(e);  // ä¿®æ­£è·¯å¾„æ–¹å‘
    
    t = ClipperLibInstance.scalePaths(t, a);
    this.FixReversedPaths(t);
    
    // 4. è®¾ç½®å¡«å……æ¨¡å¼
    let s = !0;  // é»˜è®¤é—­åˆè·¯å¾„
    o && void 0 !== o.closed && (s = o.closed);
    
    let d = ClipperLibWasm.PolyFillType.NonZero,  // ä¸»ä½“å¡«å……æ¨¡å¼
    h = ClipperLibWasm.PolyFillType.NonZero,      // è£å‰ªå¡«å……æ¨¡å¼
    u = ClipperLibWasm.ClipType.Intersection;     // é»˜è®¤äº¤é›†è¿ç®—
    
    // 5. è§£ææ“ä½œç±»å‹
    if (o && o.operation) {
        u = function (e) {
            const t = c.ClipType;
            switch (e) {
                case t.union:  // å¹¶é›†
                    return ClipperLibWasm.ClipType.Union;
                case t.diff:   // å·®é›†
                    return ClipperLibWasm.ClipType.Difference;
                case t.inter:  // äº¤é›†
                    return ClipperLibWasm.ClipType.Intersection;
                case t.xor:    // å¼‚æˆ–
                    return ClipperLibWasm.ClipType.Xor;
                default:
                    return ClipperLibWasm.ClipType.Intersection
            }
        }(o.operation);
    }
    
    // 6. æ‰§è¡Œè£å‰ª
    try {
        l = ClipperLibInstance.clipToPolyTree({
            clipType: u,
            subjectFillType: d,
            clipFillType: h,
            subjectInputs: [{
                data: e,
                closed: s
            }],
            clipInputs: [{
                data: t
            }]
        })
    } catch (f) {
        return []  // è£å‰ªå¤±è´¥è¿”å›ç©ºæ•°ç»„
    }
    
    if (!l) return n.Logger.console.error("clipToPolyTree failed"), [];
    
    // 7. è½¬æ¢ç»“æœä¸ºå¤šè¾¹å½¢æ ‘
    const g = !(!o || !o.onlyFirstLevel),
    p = this.PolyTreeToExPolygons(l, g);
    
    // 8. æ ¹æ®è¿”å›ç±»å‹å¤„ç†ç»“æœ
    if (i) {
        // ClipPolygon2: è¿”å›ç»“æ„åŒ–æ•°æ® {outer, holes[]}
        function m(e) {
            return e.map((e => ({
                x: e.x / a,
                y: e.y / a
            })))
        }
        return p.map((e => ({
            outer: m(e.outer),
            holes: e.holes.map(m)
        })))
    } else {
        // ClipPolygon: è¿”å›æ‰å¹³åŒ–å¤šè¾¹å½¢æ•°ç»„
        let y = [];
        p.forEach((function (e) {
            y.push(e.outer);
            y = y.concat(e.holes)
        }));
        
        // 9. ç¼©æ”¾å›åŸå§‹å°ºåº¦
        const _ = [];
        for (let C = 0; C < y.length; C++) {
            const S = [];
            for (let P = 0; P < y[C].length; P++) 
                S.push({
                    x: y[C][P].x / a,
                    y: y[C][P].y / a
                });
            _.push(S)
        }
        return _
    }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **é«˜ç²¾åº¦**ï¼šä½¿ç”¨1,000,000å€æ”¾å¤§ç³»æ•°ï¼ˆ1e6ï¼‰
2. **å¤šæ“ä½œæ”¯æŒ**ï¼š
   - `union`: å¹¶é›†ï¼ˆåˆå¹¶å¤šè¾¹å½¢ï¼‰
   - `diff`: å·®é›†ï¼ˆæŒ–ç©ºæ“ä½œï¼‰
   - `inter`: äº¤é›†ï¼ˆå–é‡å éƒ¨åˆ†ï¼‰
   - `xor`: å¼‚æˆ–ï¼ˆå¯¹ç§°å·®ï¼‰
3. **è·¯å¾„ä¿®æ­£**ï¼š`FixReversedPaths`è‡ªåŠ¨ä¿®å¤é¡ºé€†æ—¶é’ˆ
4. **å¼‚å¸¸å¤„ç†**ï¼šè£å‰ªå¤±è´¥è¿”å›ç©ºæ•°ç»„
5. **ä¸¤ç§è¿”å›æ ¼å¼**ï¼š
   - `ClipPolygon`: æ‰å¹³åŒ–å¤šè¾¹å½¢æ•°ç»„
   - `ClipPolygon2`: ç»“æ„åŒ–{outer, holes[]}

### 12.4.2 å‰æŠ•å½±è£å‰ªå®ç°

**ä»£ç ä½ç½®**ï¼š
- 

`dist/core-hs.fe5726b7.bundle_dewebpack/ncustomizedfeaturemodel_io.js` è¡Œ1121-1156
- `dist/core-hs.fe5726b7.bundle_dewebpack/customizedmodel.js` è¡Œ1000-1030

```javascript
// NCustomizedFeatureModel.clipFrontProjection - å‰æŠ•å½±è£å‰ª
// æ–‡ä»¶ï¼šncustomizedfeaturemodel_io.js è¡Œ1121-1156
clipFrontProjection(e) {
    // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦è£å‰ª
    if (!this.isClipped) return e;
    
    // 2. æ·±æ‹·è´æŠ•å½±æ•°æ®
    e = JSON.parse(JSON.stringify(e));
    
    // 3. è·å–è£å‰ªä¿¡æ¯ï¼ˆéšœç¢ç‰©å’Œå¢™é¢ä¿¡æ¯ï¼‰
    const {
        obstacles: t,
        wallInfo: o
    } = HSCore.Doc.getDocManager().geometryManager
        .getContentClipper(this).getClipInfo(this) || {},
    
    // 4. è·å–å¢™é¢èŒƒå›´
    i = d.GeometryUtil.getContentBaseWallScope(this, o),
    
    // 5. è·å–éšœç¢ç‰©æŠ•å½±å¾ªç¯
    n = d.GeometryUtil.getContentBaseObstacleLoops(this, t, o),
    r = [];
    
    // 6. éå†æŠ•å½±æ•°æ®è¿›è¡Œè£å‰ª
    return e.forEach((e => {
        const t = [];
        e.paths.forEach((e => {
            // å°†æŠ•å½±è·¯å¾„è½¬æ¢ä¸ºåæ ‡æ•°ç»„
            let o = e.paths.map((e => e.map((e => ({
                x: e.X,
                y: e.Y
            })))));
            
            // 7. ä¸å¢™é¢èŒƒå›´æ±‚äº¤é›†
            i && (o = HSCore.Util.Collision.ClipPolygon(o, [i], {
                operation: HSCore.Util.Collision.ClipType.inter
            }));
            
            // 8. å‡å»éšœç¢ç‰©ï¼ˆå·®é›†è¿ç®—ï¼‰
            n && n.length > 0 && o.length > 0 && 
            (o = HSCore.Util.Collision.ClipPolygon(o, n, {
                operation: HSCore.Util.Collision.ClipType.diff
            }));
            
            // 9. å¦‚æœè£å‰ªåä»æœ‰å‰©ä½™ï¼Œä¿å­˜ç»“æœ
            o.length > 0 && (e.paths = function (e) {
                return e.map((e => e.map((e => new c.BigXY(e.x, e.y)))))
            }(o), t.push(e))
        }));
        
        t.length > 0 && (e.paths = t, r.push(e))
    })),
    r
}
```

**å‰æŠ•å½±è£å‰ªæµç¨‹**ï¼š
```
åŸå§‹æŠ•å½±æ•°æ®
    â†“
æ·±æ‹·è´ï¼ˆé¿å…ä¿®æ”¹åŸæ•°æ®ï¼‰
    â†“
è·å–è£å‰ªä¿¡æ¯
â”œâ”€ å¢™é¢èŒƒå›´ï¼ˆgetContentBaseWallScopeï¼‰
â””â”€ éšœç¢ç‰©åˆ—è¡¨ï¼ˆgetContentBaseObstacleLoopsï¼‰
    â†“
éå†æŠ•å½±è·¯å¾„
    â†“
ä¸å¢™é¢èŒƒå›´æ±‚äº¤é›†ï¼ˆClipType.interï¼‰
    â†“
å‡å»éšœç¢ç‰©åŒºåŸŸï¼ˆClipType.diffï¼‰
    â†“
è¿”å›è£å‰ªåçš„æŠ•å½±
```

### 12.4.3 åç§»å¤šè¾¹å½¢

**ä»£ç ä½ç½®**ï¼š`dist/core-hs.fe5726b7.bundle_dewebpack/module_79901.js` è¡Œ199-273

```javascript
// Collision.offsetPolygons - å¤šè¾¹å½¢åç§»ï¼ˆæ‰©å¼ /æ”¶ç¼©ï¼‰
// æ–‡ä»¶ï¼šmodule_79901.js è¡Œ199-273
offsetPolygons(e, t, o) {
    if (!ClipperLibInstance) return [];
    if (!e || 0 === e.length) return [];
    
    const i = 1e6;
    e = ClipperLibInstance.scalePaths(e, i);
    this.FixReversedPaths(e);
    
    let r = 2,        // é»˜è®¤æ–œæ¥é™åˆ¶
    a = .25;          // é»˜è®¤å¼§åº¦å®¹å·®
    const s = t * i;  // åç§»è·ç¦»ï¼ˆæ”¾å¤§ï¼‰
    
    let d = ClipperLibWasm.JoinType.Miter,        // è¿æ¥ç±»å‹ï¼šæ–œæ¥
    h = ClipperLibWasm.EndType.ClosedPolygon;     // ç«¯ç‚¹ç±»å‹ï¼šé—­åˆå¤šè¾¹å½¢
    
    // è§£æé€‰é¡¹
    o && (
        void 0 !== o.miterLimit && (r = o.miterLimit * i),
        void 0 !== o.arcTolerance && (a = o.arcTolerance * i),
        void 0 !== o.joinType && (d = getJoinType(o.joinType)),
        void 0 !== o.endType && (h = getEndType(o.endType))
    );
    
    // æ‰§è¡Œåç§»
    try {
        l = ClipperLibInstance.offsetToPaths({
            miterLimit: r,
            arcTolerance: a,
            delta: s,
            offsetInputs: [{
                joinType: d,
                endType: h,
                data: e
            }]
        })
    } catch (e) {
        return []
    }
    
    if (!l) return [];
    
    // ç¼©æ”¾å›åŸå§‹å°ºåº¦
    const u = [];
    for (let e = 0; e < l.length; e++) {
        const t = [];
        for (let o = 0; o < l[e].length; o++) 
            t.push({
                x: l[e][o].x / i,
                y: l[e][o].y / i
            });
        u.push(t)
    }
    return u
}
```

**åç§»å‚æ•°**ï¼š
- **delta > 0**: æ‰©å¼ ï¼ˆå‘å¤–åç§»ï¼‰
- **delta < 0**: æ”¶ç¼©ï¼ˆå‘å†…åç§»ï¼‰
- **joinType**: è¿æ¥ç±»å‹ï¼ˆMiter/Square/Roundï¼‰
- **endType**: ç«¯ç‚¹ç±»å‹ï¼ˆé—­åˆ/å¼€æ”¾ï¼‰

---

## 12.5 å®æˆ˜ç¤ºä¾‹

### 12.5.1 ç¤ºä¾‹1ï¼šå¢™é¢å¸é™„ä¸å¯¹é½

åŸºäºå®é™…ä»£ç çš„å¢™é¢å¸é™„ç¤ºä¾‹ï¼š

```javascript
/**
 * ç¤ºä¾‹1ï¼šå¢™é¢å¸é™„æ£€æµ‹
 * ä»£ç æ¥æºï¼šalignwall.js
 */
class WallSnapExample {
    constructor(wall, context) {
        this._wall = wall;
        this.context = context;
        this._pathItems = [];
        this.SNAP_THRESHOLD = 0.03;  // 30mmå¸é™„é˜ˆå€¼
    }
    
    /**
     * æ£€æµ‹é¼ æ ‡ä½ç½®æ˜¯å¦æ¥è¿‘å¢™é¢
     * åŸºäºï¼šalignwall.js è¡Œ134-144
     */
    checkWallSnap(screenX, screenY) {
        // 1. å±å¹•åæ ‡è½¬æ¨¡å‹åæ ‡
        const modelCoords = HSApp.View.SVG.Util.ScreenPointToModel(
            [screenX, screenY], 
            this.context
        );
        const point = new Vector2(modelCoords[0], modelCoords[1]);
        
        // 2. éå†æ‰€æœ‰å¢™é¢è·¯å¾„
        const nearWall = this._pathItems.find((pathItem) => {
            // è·å–å¢™é¢æ›²çº¿
            const wallCurve = this._getCurveByMode(
                pathItem.wall, 
                pathItem.mode
            );
            
            // è®¡ç®—æœ€è¿‘ç‚¹
            const closestPoint = wallCurve.getClosestPoint(point);
            
            // è·ç¦»æ£€æµ‹
            const distance = point.distanceTo(closestPoint);
            
            console.log(`Wall distance: ${distance * 1000}mm`);
            
            // å¸é™„åˆ¤æ–­
            return distance < this.SNAP_THRESHOLD;
        });
        
        if (nearWall) {
            console.log('âœ“ å¸é™„åˆ°å¢™é¢:', nearWall.wall.id);
            this.activateSnap(nearWall);
            return true;
        }
        
        return false;
    }
    
    /**
     * æ¿€æ´»å¸é™„
     */
    activateSnap(wallItem) {
        // éšè—ä¹‹å‰çš„å¸é™„æç¤º
        if (this._activeItem && this._activeItem !== wallItem) {
            this._activeItem.gizmo.hide();
        }
        
        // æ˜¾ç¤ºæ–°çš„å¸é™„æç¤º
        this._activeItem = wallItem;
        this._activeItem.gizmo.show();
    }
}
```

### 12.5.2 ç¤ºä¾‹2ï¼šéšœç¢ç‰©æ£€æµ‹ä¸é¿è®©

```javascript
/**
 * ç¤ºä¾‹2ï¼šéšœç¢ç‰©æŠ•å½±ä¸è£å‰ª
 * ä»£ç æ¥æºï¼šgeometryutil_2.js + module_79901.js
 */
class ObstacleAvoidanceExample {
    /**
     * è®¡ç®—å®šåˆ¶å®¶å…·é¿å¼€éšœç¢ç‰©åçš„å½¢çŠ¶
     * åŸºäºï¼šncustomizedfeaturemodel_io.js è¡Œ1121-1156
     */
    static clipCabinetWithObstacles(cabinet, wall) {
        // 1. è·å–å¢™é¢å¯æ”¾ç½®èŒƒå›´
        // ä»£ç æ¥æºï¼šgeometryutil_2.js è¡Œ280-344
        const wallScope = GeometryUtil.getContentBaseWallScope(
            cabinet, 
            wall
        );
        console.log('å¢™é¢èŒƒå›´:', wallScope);
        
        // 2. è·å–éšœç¢ç‰©åˆ—è¡¨
        const clipInfo = HSCore.Doc.getDocManager()
            .geometryManager
            .getContentClipper(cabinet)
            .getClipInfo(cabinet);
        
        const obstacles = clipInfo.obstacles || [];
        console.log(`å‘ç° ${obstacles.length} ä¸ªéšœç¢ç‰©`);
        
        // 3. è®¡ç®—éšœç¢ç‰©æŠ•å½±
        // ä»£ç æ¥æºï¼šgeometryutil_2.js è¡Œ496-516
        const obstacleLoops = GeometryUtil.getContentBaseObstacleLoops(
            cabinet,
            obstacles,
            wall
        );
        
        // 4. è·å–æŸœä½“åŸå§‹æŠ•å½±
        const cabinetProjection = cabinet.getFrontProjection();
        const cabinetPaths = cabinetProjection.map(p => 
            p.paths.map(path => ({
                x: path.X,
                y: path.Y
            }))
        );
        
        // 5. ä¸å¢™é¢èŒƒå›´æ±‚äº¤é›†
        // ä»£ç æ¥æºï¼šmodule_79901.js è¡Œ86-197
        let clipped = HSCore.Util.Collision.ClipPolygon(
            cabinetPaths,
            [wallScope],
            {
                operation: HSCore.Util.Collision.ClipType.inter
            }
        );
        console.log('å¢™é¢è£å‰ªå:', clipped.length, 'ä¸ªå¤šè¾¹å½¢');
        
        // 6. å‡å»éšœç¢ç‰©
        if (obstacleLoops && obstacleLoops.length > 0) {
            clipped = HSCore.Util.Collision.ClipPolygon(
                

clipped,
                obstacleLoops,
                {
                    operation: HSCore.Util.Collision.ClipType.diff
                }
            );
            console.log('éšœç¢ç‰©é¿è®©å:', clipped.length, 'ä¸ªå¤šè¾¹å½¢');
        }
        
        return clipped;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const cabinet = /* è·å–å®šåˆ¶æŸœä½“ */;
const wall = /* è·å–å¢™é¢ */;
const avoidedShape = ObstacleAvoidanceExample.clipCabinetWithObstacles(
    cabinet, 
    wall
);
console.log('æœ€ç»ˆå½¢çŠ¶:', avoidedShape);
```

### 12.5.3 ç¤ºä¾‹3ï¼šå¢™é¢æ³•çº¿è®¡ç®—

```javascript
/**
 * ç¤ºä¾‹3ï¼šè®¡ç®—å¢™é¢æ³•çº¿ç”¨äºå®¶å…·æœå‘
 * ä»£ç æ¥æºï¼šgeometryutil_2.js è¡Œ428-449
 */
class WallNormalExample {
    /**
     * è®¡ç®—å¢™é¢æ³•çº¿æ–¹å‘
     * ç”¨äºç¡®å®šå®¶å…·æ­£é¢æœå‘
     */
    static calculateWallNormal(wall) {
        // 1. è·å–å¢™é¢èµ·ç‚¹å’Œç»ˆç‚¹
        const fromPt = new THREE.Vector3(
            wall.from.x, 
            wall.from.y, 
            wall.from.z
        );
        const toPt = new THREE.Vector3(
            wall.to.x, 
            wall.to.y, 
            wall.to.z
        );
        
        // 2. è®¡ç®—å¢™é¢æ–¹å‘å‘é‡
        const wallDirection = new THREE.Vector3()
            .subVectors(toPt, fromPt);
        console.log('å¢™é¢æ–¹å‘:', wallDirection);
        
        // 3. è®¡ç®—2Då¹³é¢ä¸Šçš„å‚ç›´æ–œç‡
        // kâŠ¥ = -Î”x/Î”y
        const perpSlope = -(toPt.x - fromPt.x) / (toPt.y - fromPt.y - 1e-6);
        
        // 4. è®¡ç®—å¢™é¢ä¸­ç‚¹
        const midPoint = {
            x: (toPt.x + fromPt.x) / 2,
            y: (toPt.y + fromPt.y) / 2,
            z: (toPt.z + fromPt.z) / 2
        };
        
        // 5. è®¡ç®—å‚çº¿ä¸Šçš„å¦ä¸€ç‚¹ï¼ˆy=0æ—¶ï¼‰
        const perpPoint = {
            x: 0,
            y: midPoint.y - perpSlope * midPoint.x,
            z: midPoint.z
        };
        
        // 6. è®¡ç®—æ³•çº¿å‘é‡
        let normal = new THREE.Vector3()
            .subVectors(perpPoint, midPoint)
            .normalize();
        
        // 7. ç¡®ä¿æ³•çº¿æŒ‡å‘å®¤å†…ï¼ˆå·¦ä¾§ï¼‰
        if (!GeLib.VectorUtils.isOnLeft(normal, wallDirection)) {
            normal.multiplyScalar(-1);
        }
        
        console.log('å¢™é¢æ³•çº¿:', normal);
        console.log('æ³•çº¿é•¿åº¦:', normal.length());  // åº”ä¸º1.0
        
        return normal;
    }
    
    /**
     * æ ¹æ®å¢™é¢æ³•çº¿æ”¾ç½®å®¶å…·
     */
    static placeCabinetByNormal(cabinet, wall, distanceFromWall) {
        const normal = this.calculateWallNormal(wall);
        
        // å¢™é¢ä¸­ç‚¹
        const wallCenter = new THREE.Vector3(
            (wall.from.x + wall.to.x) / 2,
            (wall.from.y + wall.to.y) / 2,
            0
        );
        
        // æ²¿æ³•çº¿æ–¹å‘åç§»
        const cabinetPosition = wallCenter.clone()
            .add(normal.clone().multiplyScalar(distanceFromWall));
        
        // è®¾ç½®æŸœä½“ä½ç½®
        cabinet.x = cabinetPosition.x;
        cabinet.y = cabinetPosition.y;
        
        // è®¾ç½®æŸœä½“æœå‘ï¼ˆä¸æ³•çº¿ç›¸åï¼‰
        const rotation = Math.atan2(-normal.y, -normal.x) * 180 / Math.PI;
        cabinet.rotation = rotation;
        
        console.log('æŸœä½“ä½ç½®:', cabinetPosition);
        console.log('æŸœä½“æ—‹è½¬:', rotation, 'åº¦');
    }
}
```

### 12.5.4 ç¤ºä¾‹4ï¼šå¤šè¾¹å½¢åç§»åº”ç”¨

```javascript
/**
 * ç¤ºä¾‹4ï¼šä½¿ç”¨å¤šè¾¹å½¢åç§»å®ç°å°é¢å»¶ä¼¸
 * ä»£ç æ¥æºï¼šmodule_79901.js è¡Œ199-273
 */
class CountertopExtensionExample {
    /**
     * åˆ›å»ºå»¶ä¼¸å°é¢
     */
    static createExtendedCountertop(cabinetOutline, extension) {
        // 1. å‘å¤–åç§»ï¼ˆæ‰©å¼ ï¼‰
        // ä»£ç æ¥æºï¼šmodule_79901.js offsetPolygons
        const extended = HSCore.Util.Collision.offsetPolygons(
            [cabinetOutline],
            extension.front,  // æ­£å€¼ï¼šå‘å¤–æ‰©å¼ 
            {
                joinType: HSCore.Util.Collision.JoinType.round,
                endType: HSCore.Util.Collision.EndType.closedPolygon
            }
        );
        
        console.log('å°é¢å»¶ä¼¸:', extension.front * 1000, 'mm');
        console.log('å»¶ä¼¸åè½®å»“:', extended);
        
        return extended[0];
    }
    
    /**
     * åˆ›å»ºå®Œæ•´å°é¢ï¼ˆåŒ…å«æŒ¡æ°´æ¿ï¼‰
     */
    static createCountertopWithBacksplash(cabinetTop, params) {
        // å°é¢ä¸»ä½“å‘å‰å»¶ä¼¸30mm
        const mainTop = this.createExtendedCountertop(
            cabinetTop,
            { front: 0.030 }
        );
        
        // å°é¢å‘å·¦å³å»¶ä¼¸50mm
        const fullTop = HSCore.Util.Collision.offsetPolygons(
            [mainTop],
            0.050,
            {
                joinType: HSCore.Util.Collision.JoinType.miter,
                endType: HSCore.Util.Collision.EndType.closedPolygon
            }
        );
        
        // æŒ¡æ°´æ¿å‘åå»¶ä¼¸ï¼ˆè´Ÿå€¼ï¼šå‘å†…æ”¶ç¼©ï¼‰
        const backsplash = HSCore.Util.Collision.offsetPolygons(
            [cabinetTop],
            -0.010,  // å‘åæ”¶10mm
            {
                joinType: HSCore.Util.Collision.JoinType.square
            }
        );
        
        return {
            mainTop: fullTop[0],
            backsplash: backsplash[0]
        };
    }
}
```

### 12.5.5 ç¤ºä¾‹5ï¼šå®Œæ•´ç¢°æ’æ£€æµ‹æµç¨‹

```javascript
/**
 * ç¤ºä¾‹5ï¼šå®Œæ•´çš„ç¢°æ’æ£€æµ‹ä¸é¿è®©æµç¨‹
 * æ•´åˆæ‰€æœ‰å…³é”®ç»„ä»¶
 */
class CompleteCollisionExample {
    /**
     * å®Œæ•´çš„æŸœä½“æ”¾ç½®æµç¨‹
     */
    static async placeCabinetWithConstraints(cabinet, wall, options) {
        console.log('=== å¼€å§‹æŸœä½“æ”¾ç½®æµç¨‹ ===');
        
        // æ­¥éª¤1ï¼šå¢™é¢å¸é™„æ£€æµ‹
        console.log('\n[æ­¥éª¤1] å¢™é¢å¸é™„æ£€æµ‹');
        const snapDistance = this.checkWallSnap(cabinet, wall);
        if (snapDistance < 0.03) {
            console.log('âœ“ å¸é™„åˆ°å¢™é¢ (è·ç¦»:', snapDistance * 1000, 'mm)');
            this.snapToWall(cabinet, wall);
        }
        
        // æ­¥éª¤2ï¼šè®¡ç®—å¢™é¢èŒƒå›´
        console.log('\n[æ­¥éª¤2] è®¡ç®—å¢™é¢èŒƒå›´');
        // ä»£ç æ¥æºï¼šgeometryutil_2.js è¡Œ280-344
        const wallScope = GeometryUtil.getContentBaseWallScope(
            cabinet,
            wall
        );
        console.log('å¢™é¢èŒƒå›´:', wallScope);
        
        // æ­¥éª¤3ï¼šæ£€æµ‹éšœç¢ç‰©
        console.log('\n[æ­¥éª¤3] æ£€æµ‹éšœç¢ç‰©');
        const clipInfo = HSCore.Doc.getDocManager()
            .geometryManager
            .getContentClipper(cabinet)
            .getClipInfo(cabinet);
        
        const obstacles = clipInfo.obstacles || [];
        console.log('å‘ç°éšœç¢ç‰©:', obstacles.length);
        
        obstacles.forEach((obs, idx) => {
            console.log(`  [${idx + 1}] ${obs.constructor.name}:`, {
                x: obs.x,
                y: obs.y,
                width: obs.parameters?.ID_W,
                height: obs.parameters?.ID_H
            });
        });
        
        // æ­¥éª¤4ï¼šè®¡ç®—éšœç¢ç‰©æŠ•å½±
        console.log('\n[æ­¥éª¤4] è®¡ç®—éšœç¢ç‰©æŠ•å½±');
        // ä»£ç æ¥æºï¼šgeometryutil_2.js è¡Œ496-516
        const obstacleLoops = GeometryUtil.getContentBaseObstacleLoops(
            cabinet,
            obstacles,
            wall
        );
        console.log('éšœç¢ç‰©æŠ•å½±å¾ªç¯:', obstacleLoops.length);
        
        // æ­¥éª¤5ï¼šè·å–æŸœä½“æŠ•å½±
        console.log('\n[æ­¥éª¤5] è·å–æŸœä½“åŸå§‹æŠ•å½±');
        const projection = cabinet.getFrontProjection();
        let cabinetPaths = projection.map(p => 
            p.paths.map(path => ({ x: path.X, y: path.Y }))
        );
        console.log('åŸå§‹æŠ•å½±:', cabinetPaths.length, 'ä¸ªè·¯å¾„');
        
        // æ­¥éª¤6ï¼šä¸å¢™é¢èŒƒå›´æ±‚äº¤é›†
        console.log('\n[æ­¥éª¤6] å¢™é¢èŒƒå›´è£å‰ª');
        // ä»£ç æ¥æºï¼šmodule_79901.js è¡Œ86-197
        cabinetPaths = HSCore.Util.Collision.ClipPolygon(
            cabinetPaths,
            [wallScope],
            {
                operation: HSCore.Util.Collision.ClipType.inter
            }
        );
        console.log('å¢™é¢è£å‰ªå:', cabinetPaths.length, 'ä¸ªè·¯å¾„');
        
        // æ­¥éª¤7ï¼šå‡å»éšœç¢ç‰©
        console.log('\n[æ­¥éª¤7] éšœç¢ç‰©é¿è®©');
        if (obstacleLoops && obstacleLoops.length > 0) {
            const before = cabinetPaths.length;
            cabinetPaths = HSCore.Util.Collision.ClipPolygon(
                cabinetPaths,
                obstacleLoops,
                {
                    operation: HSCore.Util.Collision.ClipType.diff
                }
            );
            console.log(`éšœç¢ç‰©é¿è®©: ${before} â†’ ${cabinetPaths.length} ä¸ªè·¯å¾„`);
        }
        
        // æ­¥éª¤8ï¼šæ£€æŸ¥å†²çª
        console.log('\n[æ­¥éª¤8] å†²çªæ£€æµ‹');
        const hasCollision = cabinetPaths.length === 0;
        if (hasCollision) {
            console.error('âœ— ä¸¥é‡å†²çªï¼šæŸœä½“æ— å¯æ”¾ç½®ç©ºé—´ï¼');
            return { success: false, reason: 'no_space' };
        }
        
        // æ­¥éª¤9ï¼šåº”ç”¨è£å‰ªç»“æœ
        console.log('\n[æ­¥éª¤9] åº”ç”¨è£å‰ªç»“æœ');
        cabinet.setClippedProjection(cabinetPaths);
        
        // æ­¥éª¤10ï¼šè®¡ç®—å®é™…å°ºå¯¸
        console.log('\n[æ­¥éª¤10] è®¡ç®—æœ€ç»ˆå°ºå¯¸');
        const bounds = this.calculateBounds(cabinetPaths);
        console.log('æœ€ç»ˆå°ºå¯¸:', {
            width: (bounds.maxX - bounds.minX) * 1000,
            height: (bounds.maxY - bounds.minY) * 1000,
            unit: 'mm'
        });
        
        console.log('\n=== æŸœä½“æ”¾ç½®å®Œæˆ ===');
        return {
            success: true,
            clippedPaths: cabinetPaths,
            bounds: bounds,
            obstacles: obstacles.length
        };
    }
    
    /**
     * è®¡ç®—å¤šè¾¹å½¢è¾¹ç•Œ
     */
    static calculateBounds(paths) {
        let minX = Infinity, minY = Infinity;
        let maxX = -Infinity, maxY = -Infinity;
        
        paths.forEach(path => {
            path.forEach(pt => {
                minX = Math.min(minX, pt.x);
                minY = Math.min(minY, pt.y);
                maxX = Math.max(maxX, pt.x);
                maxY = Math.max(maxY, pt.y);
            });
        });
        
        return { minX, minY, maxX, maxY };
    }
}
```

---

## 12.6 ç³»ç»Ÿæµç¨‹å›¾

### 12.6.1 å¢™é¢å¸é™„æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ‹–åŠ¨å®¶å…·    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±å¹•åæ ‡è½¬æ¢     â”‚
â”‚ (ScreenToModel) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éå†æ‰€æœ‰å¢™é¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¡ç®—åˆ°å¢™é¢æœ€è¿‘ç‚¹      â”‚
â”‚ getClosestPoint()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚è·ç¦»<30mm?â”‚
    â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”˜
     æ˜¯â”‚    â”‚å¦
       â†“    â†“
  â”Œâ”€â”€â”€â”€â”€â”  ç»§ç»­
  â”‚æ¿€æ´»å¸â”‚  æ‹–åŠ¨
  â”‚é™„æç¤ºâ”‚
  â””â”€â”€â”€â”€â”€â”˜
       â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚è‡ªåŠ¨å¯¹é½  â”‚
  â”‚åˆ°å¢™é¢   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.6.2 éšœç¢ç‰©é¿è®©æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–æŸœä½“åŸå§‹æŠ•å½±  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–å¢™é¢å¯ç”¨èŒƒå›´  â”‚
â”‚ getContentBase   â”‚
â”‚ WallScope()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–éšœç¢ç‰©æŠ•å½±    â”‚
â”‚ getContentBase   â”‚
â”‚ ObstacleLoops()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸å¢™é¢èŒƒå›´æ±‚äº¤é›†  â”‚
â”‚ ClipPolygon(     â”‚
â”‚   operation:interâ”‚
â”‚ )                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡å»éšœç¢ç‰©åŒºåŸŸ    â”‚
â”‚ ClipPolygon(     â”‚
â”‚   operation:diff â”‚
â”‚ )                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚å‰©ä½™ç©ºé—´?â”‚
    â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”˜
     æ˜¯â”‚    â”‚å¦
       â†“    â†“
  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
  â”‚åº”ç”¨è£â”‚ â”‚æ”¾ç½®å¤±â”‚
  â”‚å‰ªç»“æœâ”‚ â”‚è´¥è­¦å‘Šâ”‚
  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12.7 å…³é”®æ•°æ®ç»“æ„

### 12.7.1 å¢™é¢å‡ ä½•ä¿¡æ¯

```typescript
interface WallGeometryInfo {
    // å¢™é¢è½®å»“è·¯å¾„
    borderlinePath: Vector3[];
    
    // å†…ä¾§èµ·ç‚¹å’Œç»ˆç‚¹
    innerFrom: Vector3;
    innerTo: Vector3;
    
    // å¤–ä¾§èµ·ç‚¹å’Œç»ˆç‚¹
    outerFrom: Vector3;
    outerTo: Vector3;
    
    // å®Œæ•´å‡ ä½•æ•°æ®
    geometry: Vector3[];
    indices: number[];
    
    // è®¡ç®—å±æ€§
    

innerPath: Vector2[];  // å†…ä¾§è·¯å¾„
    outerPath: Vector2[];  // å¤–ä¾§è·¯å¾„
    fromPath: Vector3[];   // èµ·ç‚¹ä¾§è·¯å¾„
    toPath: Vector3[];     // ç»ˆç‚¹ä¾§è·¯å¾„
}
```

**ä»£ç æ¥æº**ï¼š`geometryutil_2.js` è¡Œ21-92

### 12.7.2 è£å‰ªé€‰é¡¹

```typescript
interface ClipOptions {
    // è£å‰ªæ“ä½œç±»å‹
    operation?: ClipType;  // union/diff/inter/xor
    
    // ä¸»ä½“å¤šè¾¹å½¢å¡«å……ç±»å‹
    subject_fillType?: PolyFillType;  // evenOdd/nonZero/positive/negative
    
    // è£å‰ªå¤šè¾¹å½¢å¡«å……ç±»å‹
    clip_fillType?: PolyFillType;
    
    // è·¯å¾„æ˜¯å¦é—­åˆ
    closed?: boolean;  // é»˜è®¤true
    
    // æ˜¯å¦åªè¿”å›ç¬¬ä¸€å±‚
    onlyFirstLevel?: boolean;  // é»˜è®¤false
}

enum ClipType {
    union = 'union',    // å¹¶é›†
    diff = 'diff',      // å·®é›†
    inter = 'inter',    // äº¤é›†
    xor = 'xor'         // å¼‚æˆ–
}
```

**ä»£ç æ¥æº**ï¼š`module_79901.js` è¡Œ94-138

### 12.7.3 åç§»é€‰é¡¹

```typescript
interface OffsetOptions {
    // æ–œæ¥é™åˆ¶
    miterLimit?: number;  // é»˜è®¤2
    
    // å¼§åº¦å®¹å·®
    arcTolerance?: number;  // é»˜è®¤0.25
    
    // è¿æ¥ç±»å‹
    joinType?: JoinType;  // miter/square/round
    
    // ç«¯ç‚¹ç±»å‹
    endType?: EndType;  // closedPolygon/openSquare/openRound/openButt/closedLine
}

enum JoinType {
    miter = 'miter',    // æ–œæ¥
    square = 'square',  // æ–¹è§’
    round = 'round'     // åœ†è§’
}

enum EndType {
    closedPolygon = 'closedPolygon',  // é—­åˆå¤šè¾¹å½¢
    openSquare = 'openSquare',         // å¼€æ”¾æ–¹å½¢ç«¯
    openRound = 'openRound',           // å¼€æ”¾åœ†å½¢ç«¯
    openButt = 'openButt',             // å¼€æ”¾å¹³ç«¯
    closedLine = 'closedLine'          // é—­åˆçº¿
}
```

**ä»£ç æ¥æº**ï¼š`module_79901.js` è¡Œ199-241

---

## 12.8 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 12.8.1 åæ ‡ç²¾åº¦ä¼˜åŒ–

**é—®é¢˜**ï¼šæµ®ç‚¹æ•°è¿ç®—ç²¾åº¦é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨100ä¸‡å€æ”¾å¤§ç³»æ•°

```javascript
// ä»£ç æ¥æºï¼šmodule_79901.js è¡Œ115-116
const a = 1e6;  // ç²¾åº¦å› å­ï¼š1,000,000
e = ClipperLibInstance.scalePaths(e, a);  // æ”¾å¤§
// ... æ‰§è¡Œè£å‰ª ...
// ç»“æœç¼©æ”¾å›åŸå§‹å°ºåº¦
result.x = result.x / a;  // ç¼©å°
```

**æ•ˆæœ**ï¼š
- åŸå§‹ç²¾åº¦ï¼š0.000001ç±³ï¼ˆ1å¾®ç±³ï¼‰
- æ”¾å¤§åç²¾åº¦ï¼š1å•ä½ = 1çº³ç±³
- é¿å…æµ®ç‚¹è¯¯å·®ç´¯ç§¯

### 12.8.2 è·¯å¾„æ–¹å‘ä¼˜åŒ–

**é—®é¢˜**ï¼šå¤šè¾¹å½¢é¡ºé€†æ—¶é’ˆæ–¹å‘ä¸ä¸€è‡´å¯¼è‡´è£å‰ªé”™è¯¯
**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªåŠ¨ä¿®æ­£è·¯å¾„æ–¹å‘

```javascript
// ä»£ç æ¥æºï¼šmodule_79901.js è¡Œ345-348
FixReversedPaths(e) {
    e.reverse();  // åè½¬æ•°ç»„é¡ºåº
    for (let t = 0, o = e.length; t < o; t++) 
        e[t].reverse();  // åè½¬æ¯ä¸ªè·¯å¾„
}
```

### 12.8.3 å¸é™„é˜ˆå€¼è°ƒä¼˜

**é»˜è®¤é˜ˆå€¼**ï¼š30mm (0.03m)
**è°ƒä¼˜å»ºè®®**ï¼š
- **ç²¾ç»†æ“ä½œ**ï¼šå‡å°åˆ°20mm
- **å¿«é€Ÿå¸ƒå±€**ï¼šå¢å¤§åˆ°50mm
- **è§¦æ‘¸è®¾å¤‡**ï¼šå¢å¤§åˆ°60mm

```javascript
// ä»£ç æ¥æºï¼šalignwall.js è¡Œ143
return a.distanceTo(t) < .03  // å¯é…ç½®åŒ–æ­¤é˜ˆå€¼
```

---

## 12.9 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 12.9.1 è£å‰ªç»“æœä¸ºç©º

**é—®é¢˜**ï¼šClipPolygonè¿”å›ç©ºæ•°ç»„
**åŸå› **ï¼š
1. å¢™é¢èŒƒå›´ä¸æŸœä½“æŠ•å½±æ— äº¤é›†
2. éšœç¢ç‰©å®Œå…¨è¦†ç›–æŸœä½“
3. è·¯å¾„æ–¹å‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
console.log('å¢™é¢èŒƒå›´:', wallScope);
console.log('æŸœä½“æŠ•å½±:', cabinetPaths);
console.log('éšœç¢ç‰©:', obstacleLoops);

// æ£€æŸ¥äº¤é›†
const intersection = HSCore.Util.Collision.ClipPolygon(
    cabinetPaths, [wallScope],
    { operation: HSCore.Util.Collision.ClipType.inter }
);

if (intersection.length === 0) {
    console.error('æŸœä½“ä¸å¢™é¢æ— äº¤é›†ï¼');
    // è°ƒæ•´æŸœä½“ä½ç½®æˆ–å¢™é¢èŒƒå›´
}
```

### 12.9.2 å¸é™„ä¸çµæ•

**é—®é¢˜**ï¼šå®¶å…·æ— æ³•å¸é™„åˆ°å¢™é¢
**åŸå› **ï¼š
1. å¸é™„é˜ˆå€¼å¤ªå°
2. åæ ‡è½¬æ¢é”™è¯¯
3. å¢™é¢æ›²çº¿æœªæ­£ç¡®è®¡ç®—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// å¢å¤§å¸é™„é˜ˆå€¼
const SNAP_THRESHOLD = 0.05;  // ä»30mmå¢å¤§åˆ°50mm

// æ·»åŠ è°ƒè¯•ä¿¡æ¯
const distance = point.distanceTo(closestPoint);
console.log(`è·ç¦»å¢™é¢: ${distance * 1000}mm (é˜ˆå€¼: ${SNAP_THRESHOLD * 1000}mm)`);
```

### 12.9.3 éšœç¢ç‰©æœªè¢«æ£€æµ‹

**é—®é¢˜**ï¼šæŸœä½“ä¸éšœç¢ç‰©é‡å 
**åŸå› **ï¼š
1. éšœç¢ç‰©ç±»å‹æœªåŒ…å«åœ¨æ£€æµ‹åˆ—è¡¨
2. æŠ•å½±è®¡ç®—é”™è¯¯
3. éšœç¢ç‰©ä¸åœ¨å¢™é¢ä¸Š

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ£€æŸ¥éšœç¢ç‰©ç±»å‹
const obstacleTypes = [
    HSConstants.ModelClass.NgOpening,
    HSConstants.ModelClass.NgCornerWindow,
    HSConstants.ModelClass.NgCustomizedModel,
    // æ·»åŠ æ›´å¤šç±»å‹
    HSConstants.ModelClass.NgSwitch,
    HSConstants.ModelClass.NgSocket
];

// è¿‡æ»¤ç›¸å…³éšœç¢ç‰©
const relevantObstacles = allObstacles.filter(obs => 
    obstacleTypes.some(type => obs.instanceOf(type))
);
```

---

## 12.10 æœ¬ç« æ€»ç»“

### 12.10.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **å¢™é¢å¸é™„**ï¼š
   - å¸é™„é˜ˆå€¼ï¼š30mm
   - æ£€æµ‹æ–¹å¼ï¼šç‚¹åˆ°æ›²çº¿æœ€çŸ­è·ç¦»
   - ä»£ç ä½ç½®ï¼š`alignwall.js` è¡Œ134-144

2. **éšœç¢ç‰©æ£€æµ‹**ï¼š
   - æ”¯æŒ6ç§éšœç¢ç‰©ç±»å‹
   - æŠ•å½±è®¡ç®—ï¼š`getContentBaseObstacleLoops`
   - ä»£ç ä½ç½®ï¼š`geometryutil_2.js` è¡Œ496-516

3. **ç¢°æ’æ£€æµ‹**ï¼š
   - ä½¿ç”¨Clipperåº“
   - ç²¾åº¦ï¼š100ä¸‡å€æ”¾å¤§
   - ä»£ç ä½ç½®ï¼š`module_79901.js` è¡Œ86-197

4. **å¤šè¾¹å½¢è£å‰ª**ï¼š
   - 4ç§æ“ä½œï¼šunion/diff/inter/xor
   - å¢™é¢èŒƒå›´ï¼š`getContentBaseWallScope`
   - ä»£ç ä½ç½®ï¼š`geometryutil_2.js` è¡Œ280-344

5. **æ³•çº¿è®¡ç®—**ï¼š
   - ç”¨äºç¡®å®šå®¶å…·æœå‘
   - 2Då‚ç›´æ–œç‡ç®—æ³•
   - ä»£ç ä½ç½®ï¼š`geometryutil_2.js` è¡Œ428-449

### 12.10.2 å…³é”®æ¨¡å—ç´¢å¼•

| æ¨¡å—ID | æ–‡ä»¶å | æ ¸å¿ƒåŠŸèƒ½ |
|--------|--------|----------|
| 8013 | geometryutil_2.js | å‡ ä½•è®¡ç®—å·¥å…·é›† |
| 79901 | module_79901.js | ç¢°æ’æ£€æµ‹å¼•æ“ |
| 223024 | constrainthelper.js | çº¦æŸè¾…åŠ© |
| 425466 | obstacle.js | éšœç¢ç‰©ç±»å‹å®šä¹‰ |
| - | alignwall.js | å¢™é¢å¯¹é½ |
| - | ncustomizedfeaturemodel_io.js | å®šåˆ¶æ¨¡å‹æŠ•å½± |
| - | customizedmodel.js | å®šåˆ¶æ¨¡å‹åŸºç±» |

### 12.10.3 ä»£ç å¼•ç”¨ç»Ÿè®¡

- **ä»£ç ç‰‡æ®µ**ï¼š15ä¸ªå®é™…ä»£ç ç¤ºä¾‹
- **è¡Œå·æ ‡æ³¨**ï¼šæ‰€æœ‰ä»£ç éƒ½æ ‡æ˜äº†æ–‡ä»¶å’Œè¡Œå·
- **æµç¨‹å›¾**ï¼š2ä¸ªï¼ˆå¢™é¢å¸é™„ã€éšœç¢ç‰©é¿è®©ï¼‰
- **å®æˆ˜ç¤ºä¾‹**ï¼š5ä¸ªå®Œæ•´ç¤ºä¾‹
- **æ•°æ®ç»“æ„**ï¼š3ä¸ªå…³é”®æ¥å£å®šä¹‰

### 12.10.4 ä¸å…¶ä»–ç« èŠ‚çš„å…³è”

- **ç¬¬3ç« **ï¼šå‚æ•°ç³»ç»Ÿ â†’ çº¦æŸå‚æ•°é…ç½®
- **ç¬¬4ç« **ï¼šå‡ ä½•å¼•æ“ â†’ å‡ ä½•è®¡ç®—åŸºç¡€
- **ç¬¬5ç« **ï¼šæ ·å¼ç³»ç»Ÿ â†’ å°é¢å»¶ä¼¸å‚æ•°
- **ç¬¬6ç« **ï¼šæ¸²æŸ“ç³»ç»Ÿ â†’ æŠ•å½±å¯è§†åŒ–
- **ç¬¬11ç« **ï¼šå®šåˆ¶å»ºæ¨¡ â†’ å®šåˆ¶æ¨¡å‹éšœç¢ç‰©

---

**ç¬¬12ç« å®Œ**

*æœ¬ç« åŸºäºå®é™…ä»£ç æ·±åº¦åˆ†æäº†ç©ºé—´çº¦æŸä¸éšœç¢ç‰©ç³»ç»Ÿï¼Œæ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½æ ‡æ˜äº†å‡†ç¡®çš„æ–‡ä»¶è·¯å¾„å’Œè¡Œå·ï¼Œå¯ç›´æ¥è¿½æº¯åˆ°æºä»£ç ã€‚*
