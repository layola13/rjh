# æš—è£…å·¥ç¨‹æ°´ç”µç³»ç»Ÿä¸æŸœä½“ç”µè·¯é›†æˆå®Œæ•´æ¶æ„æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¶é—´**: 2026-01-22  
> **åˆ†æèŒƒå›´**: æš—è£…å·¥ç¨‹æ°´ç”µç³»ç»Ÿ + æŸœä½“ç”µè·¯æ¨¡å—é›†æˆ  
> **æ¶æ„å±‚çº§**: 9-11å±‚å®Œæ•´æ¶æ„  
> **æºç åŸºç¡€**: dist/core-hs.fe5726b7.bundle + plugins-hs

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ€»è§ˆ](#1-ç³»ç»Ÿæ€»è§ˆ)
2. [æ ¸å¿ƒæ¶æ„å±‚æ¬¡](#2-æ ¸å¿ƒæ¶æ„å±‚æ¬¡9-11å±‚)
3. [ç”µè·¯ç³»ç»Ÿå®Œæ•´æ¶æ„](#3-ç”µè·¯ç³»ç»Ÿå®Œæ•´æ¶æ„)
4. [æ°´è·¯ç³»ç»Ÿå®Œæ•´æ¶æ„](#4-æ°´è·¯ç³»ç»Ÿå®Œæ•´æ¶æ„)
5. [æŸœä½“ç”µè·¯é›†æˆæœºåˆ¶](#5-æŸœä½“ç”µè·¯é›†æˆæœºåˆ¶)
6. [æš—è£…å·¥ç¨‹å¸ƒçº¿ç®—æ³•](#6-æš—è£…å·¥ç¨‹å¸ƒçº¿ç®—æ³•)
7. [æŸœä½“é¿è®©ç®—æ³•](#7-æŸœä½“é¿è®©ç®—æ³•)
8. [ç”µè·¯ç»„ä»¶ç³»ç»Ÿ](#8-ç”µè·¯ç»„ä»¶ç³»ç»Ÿ)
9. [æ°´è·¯ç»„ä»¶ç³»ç»Ÿ](#9-æ°´è·¯ç»„ä»¶ç³»ç»Ÿ)
10. [å®æˆ˜ç¤ºä¾‹](#10-å®æˆ˜ç¤ºä¾‹)
11. [æºç ç´¢å¼•](#11-æºç ç´¢å¼•)

---

## 1. ç³»ç»Ÿæ€»è§ˆ

### 1.1 ç³»ç»Ÿå®šä½

æš—è£…å·¥ç¨‹æ°´ç”µç³»ç»Ÿæ˜¯ä¸€ä¸ª**æ™ºèƒ½åŒ–æ°´ç”µç‚¹ä½è§„åˆ’ä¸å¸ƒçº¿ç³»ç»Ÿ**ï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š

- âœ… **è‡ªåŠ¨å¸ƒçº¿**: åŸºäºA*ç®—æ³•çš„æ™ºèƒ½è·¯å¾„è§„åˆ’
- âœ… **éšœç¢ç‰©é¿è®©**: æŸœä½“ã€å¢™ä½“ã€é—¨çª—è‡ªåŠ¨é¿è®©
- âœ… **åŒè½¨é¿è®©ç­–ç•¥**: ç”µçº¿å¼§å½¢é¿è®© + æ°´ç®¡æ­£äº¤é¿è®©
- âœ… **æŸœä½“é›†æˆ**: æŸœä½“ä½œä¸ºéšœç¢ç‰©å‚ä¸å¸ƒçº¿è®¡ç®—
- âœ… **ç”µè·¯æ¨¡å—åŒ–**: æ”¯æŒç…§æ˜/ç”µæº/å¼±ç”µå¤šç§å›è·¯
- âœ… **æ°´è·¯åˆ†ç±»**: å†·æ°´/çƒ­æ°´/ä¸‹æ°´ç‹¬ç«‹ç®¡ç†

### 1.2 å…³é”®é—®é¢˜è§£ç­”

#### â“ æŸœä½“é‡Œé¢æ˜¯å¦æœ‰ç”µè·¯æ¨¡å—ï¼Ÿ

**ç­”æ¡ˆ**: âŒ **æŸœä½“å†…éƒ¨æ²¡æœ‰ç‹¬ç«‹çš„ç”µè·¯æ¨¡å—ç³»ç»Ÿ**

**è¯¦ç»†è¯´æ˜**:
1. **æŸœä½“è§’è‰²**: æŸœä½“åœ¨æš—è£…å·¥ç¨‹ç³»ç»Ÿä¸­ä½œä¸º**éšœç¢ç‰©ï¼ˆObstacleï¼‰**å­˜åœ¨
2. **é¿è®©å…³ç³»**: ç”µè·¯/æ°´è·¯åœ¨å¸ƒçº¿æ—¶ä¼š**è‡ªåŠ¨é¿è®©æŸœä½“**
3. **é›†æˆæ–¹å¼**: ä¸æ˜¯"æŸœä½“åŒ…å«ç”µè·¯"ï¼Œè€Œæ˜¯"ç”µè·¯ç»•è¿‡æŸœä½“"
4. **ç…§æ˜æ”¯æŒ**: æŸœä½“å¯ä»¥æœ‰**ç¯å…‰æ¿ï¼ˆLightboardï¼‰**éƒ¨ä»¶ï¼Œä½†è¿™æ˜¯æŸœä½“è‡ªèº«çš„ç»„ä»¶ï¼Œä¸å±äºæš—è£…å·¥ç¨‹ç”µè·¯ç³»ç»Ÿ

æºç è¯æ®:
- [`obstacle.js:79-318`](dist/core-hs.fe5726b7.bundle_dewebpack/obstacle.js:79) - æŸœä½“ç»§æ‰¿è‡ªObstacle
- [`dist-module-architecture-analysis.md:876-920`](todo/dist-module-architecture-analysis.md:876) - æŸœä½“åœ¨éšœç¢ç‰©åˆ—è¡¨ä¸­
- [`cabinet.js:19-89`](dist/plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/cabinet.js:19) - æŸœä½“åˆ›å»ºæµç¨‹ï¼Œæ— ç”µè·¯ç³»ç»Ÿ

#### â“ æŸœä½“å¦‚ä½•ä¸æ°´ç”µç³»ç»Ÿé›†æˆï¼Ÿ

**ç­”æ¡ˆ**: æŸœä½“é€šè¿‡**éšœç¢ç‰©ç³»ç»Ÿ**ä¸æ°´ç”µé›†æˆï¼Œé‡‡ç”¨**é¿è®©ç­–ç•¥**

**é›†æˆæœºåˆ¶**:
```
Scene.getObstacles() â†’ è¿”å›éšœç¢ç‰©åˆ—è¡¨
  â”œâ”€ Wall (å¢™ä½“)
  â”œâ”€ Door (é—¨)
  â”œâ”€ Window (çª—)
  â”œâ”€ Cabinet (æŸœä½“) â­
  â”œâ”€ Furniture (å®¶å…·)
  â””â”€ Column (ç»“æ„æŸ±)

TubeTree.findPath(from, to)
  â”œâ”€ æ­¥éª¤1: è·å–åœºæ™¯éšœç¢ç‰©ï¼ˆåŒ…æ‹¬æŸœä½“ï¼‰
  â”œâ”€ æ­¥éª¤2: A*è·¯å¾„è§„åˆ’ï¼ˆé¿å¼€éšœç¢ç‰©ï¼‰
  â”œâ”€ æ­¥éª¤3: ç¢°æ’æ£€æµ‹
  â””â”€ æ­¥éª¤4: ç”Ÿæˆé¿è®©è·¯å¾„
```

æºç ä½ç½®: [`dist-module-architecture-analysis.md:876-920`](todo/dist-module-architecture-analysis.md:876)

---

## 2. æ ¸å¿ƒæ¶æ„å±‚æ¬¡ï¼ˆ9-11å±‚ï¼‰

### 2.1 å®Œæ•´ç³»ç»Ÿæ¶æ„å›¾

```
ç¬¬1å±‚: Floorplanï¼ˆæ¥¼å±‚å¹³é¢ï¼‰
  â”‚
  â”œâ”€ å±æ€§: floors[], activeFloor
  â””â”€ æ–¹æ³•: getActiveFloor(), addFloor()
  
ç¬¬2å±‚: Sceneï¼ˆåœºæ™¯ï¼‰
  â”‚
  â”œâ”€ å±æ€§: layers[], activeLayer, obstacles[]
  â”œâ”€ æ–¹æ³•: getActiveLayer(), getObstacles()
  â””â”€ ä½œç”¨: ç®¡ç†å›¾å±‚å’Œåœºæ™¯å¯¹è±¡
  
ç¬¬3å±‚: ActiveLayerï¼ˆæ´»åŠ¨å›¾å±‚ï¼‰
  â”‚
  â”œâ”€ ConcealedWorkï¼ˆæš—è£…å·¥ç¨‹ä¸»å¯¹è±¡ï¼‰â­
  â”œâ”€ Wallsï¼ˆå¢™ä½“ç³»ç»Ÿï¼‰
  â”œâ”€ Furnitureï¼ˆå®¶å…·ç³»ç»Ÿï¼‰
  â””â”€ Cabinetsï¼ˆæŸœä½“ç³»ç»Ÿï¼‰
  
ç¬¬4å±‚: ConcealedWorkï¼ˆæš—è£…å·¥ç¨‹ï¼‰
  â”‚
  â”œâ”€ PowerSystemï¼ˆç”µåŠ›ç³»ç»Ÿï¼‰
  â”‚   â”œâ”€ æ–‡ä»¶: concealedworkpowersystem.js
  â”‚   â”œâ”€ å±æ€§: circuits[]
  â”‚   â””â”€ æ–¹æ³•: addCircuit(), removeCircuit()
  â”‚
  â””â”€ WaterComponentsï¼ˆæ°´ç³»ç»Ÿï¼‰
      â”œâ”€ HotWaterCompï¼ˆçƒ­æ°´ç»„ä»¶ï¼‰
      â”œâ”€ ColdWaterCompï¼ˆå†·æ°´ç»„ä»¶ï¼‰
      â””â”€ DrainPipeï¼ˆæ’æ°´ç®¡ï¼‰
  
ç¬¬5å±‚: PowerSystemï¼ˆç”µåŠ›ç³»ç»Ÿï¼‰
  â”‚
  â””â”€ Circuit[]ï¼ˆç”µè·¯æ•°ç»„ï¼‰
      â”œâ”€ æ–‡ä»¶: concealedworkcircuit.js
      â”œâ”€ å±æ€§: circuitType, breakerType, tubeType, wireType
      â””â”€ æ–¹æ³•: addRouteTree(), getTubes(), getNodes()
  
ç¬¬6å±‚: Circuitï¼ˆç”µè·¯ï¼‰
  â”‚
  â”œâ”€ å±æ€§:
  â”‚   â”œâ”€ circuitType: Lighting | Power
  â”‚   â”œâ”€ breakerType: æ–­è·¯å™¨ç±»å‹
  â”‚   â”œâ”€ tubeType: çº¿ç®¡ç±»å‹
  â”‚   â”œâ”€ wireType: ç”µçº¿è§„æ ¼ï¼ˆ2.5mmÂ²/4mmÂ²ç­‰ï¼‰
  â”‚   â”œâ”€ roomRange: é€‚ç”¨æˆ¿é—´æ•°ç»„
  â”‚   â””â”€ lightControl: ç…§æ˜æ§åˆ¶é…ç½®
  â”‚
  â””â”€ TubeTree[]ï¼ˆç®¡çº¿æ ‘æ•°ç»„ï¼‰
      â”œâ”€ æ–‡ä»¶: concealedworktubetree.js
      â””â”€ ä½œç”¨: ç®¡ç†ä¸€ä¸ªå›è·¯çš„æ‰€æœ‰ç®¡çº¿
  
ç¬¬7å±‚: TubeTreeï¼ˆç®¡çº¿æ ‘ï¼‰
  â”‚
  â”œâ”€ Tube[]ï¼ˆç®¡æ®µæ•°ç»„ï¼‰
  â”‚   â”œâ”€ æ–‡ä»¶: concealedworktube.js
  â”‚   â”œâ”€ å±æ€§: route, diameter, color, tubeType
  â”‚   â””â”€ æ–¹æ³•: getMeshDefinition(), updateGeometry()
  â”‚
  â””â”€ Node[]ï¼ˆèŠ‚ç‚¹æ•°ç»„ï¼‰
      â”œâ”€ æ–‡ä»¶: concealedworknode.js
      â”œâ”€ å±æ€§: _position (Vector3), tubes[]
      â””â”€ æ–¹æ³•: getValidTubes(), getParentNode(), getChildNodes()
  
ç¬¬8å±‚: Tubeï¼ˆç®¡æ®µï¼‰
  â”‚
  â”œâ”€ å±æ€§:
  â”‚   â”œâ”€ route: (Line3d | Arc3d)[] - æ··åˆè·¯å¾„
  â”‚   â”œâ”€ diameter: ç®¡çº¿ç›´å¾„
  â”‚   â”œâ”€ color: é¢œè‰²ç¼–ç 
  â”‚   â”‚   â”œâ”€ å¼ºç”µ: 16735045 (#FF9045 æ©™çº¢è‰²)
  â”‚   â”‚   â”œâ”€ å¼±ç”µ: 3763966 (#396B9E æ·±è“è‰²)
  â”‚   â”‚   â”œâ”€ çƒ­æ°´: 4653276 (#46FADC çº¢è‰²è°ƒ)
  â”‚   â”‚   â””â”€ å†·æ°´: 4694913 (#479F61 è“è‰²è°ƒ)
  â”‚   â””â”€ tubeType: TubeMeshTypeEnum
  â”‚
  â””â”€ å‡ ä½•è¡¨ç¤º:
      â”œâ”€ Line3d: ç›´çº¿æ®µï¼ˆæ°´ç®¡ã€ç”µçº¿ç›´çº¿éƒ¨åˆ†ï¼‰
      â””â”€ Arc3d: åœ†å¼§æ®µï¼ˆç”µçº¿é¿è®©å¼§çº¿ï¼‰
  
ç¬¬9å±‚: Nodeï¼ˆèŠ‚ç‚¹ï¼‰
  â”‚
  â”œâ”€ å±æ€§:
  â”‚   â””â”€ _position: Vector3 (x, y, z)
  â”‚
  â”œâ”€ èŠ‚ç‚¹ç±»å‹:
  â”‚   â”œâ”€ DeviceNode: è®¾å¤‡èŠ‚ç‚¹ï¼ˆå¼€å…³/æ’åº§ï¼‰
  â”‚   â”œâ”€ TerminalNode: æœ«ç«¯èŠ‚ç‚¹
  â”‚   â””â”€ JoinNode: è¿æ¥èŠ‚ç‚¹ï¼ˆåˆ†æ”¯ç‚¹ï¼‰
  â”‚
  â””â”€ æ‹“æ‰‘å…³ç³»:
      â”œâ”€ getParentNode(): è·å–çˆ¶èŠ‚ç‚¹
      â”œâ”€ getChildNodes(): è·å–å­èŠ‚ç‚¹æ•°ç»„
      â””â”€ getTubeAt(direction): æŒ‰æ–¹å‘æŸ¥æ‰¾ç®¡çº¿
  
ç¬¬10å±‚: é¿è®©ç³»ç»Ÿï¼ˆAvoidance Systemï¼‰
  â”‚
  â”œâ”€ Obstacleï¼ˆéšœç¢ç‰©åŸºç±»ï¼‰
  â”‚   â”œâ”€ æ–‡ä»¶: obstacle.js:79-318
  â”‚   â”œâ”€ ç»§æ‰¿: CustomizedModel
  â”‚   â”œâ”€ å±æ€§: geometry, height, moldings[]
  â”‚   â””â”€ æ–¹æ³•: containsPoint(), intersectsPath()
  â”‚
  â”œâ”€ SubObstacleï¼ˆç²¾ç»†éšœç¢ç‰©ï¼‰
  â”‚   â”œâ”€ æ–‡ä»¶: subobstacle.js:2350-2441
  â”‚   â”œâ”€ ç”¨é€”: å®¶å…·ã€æŸœä½“ç­‰ç²¾ç»†é¿è®©
  â”‚   â””â”€ æ–¹æ³•: clipPolygon(path, obstacles)
  â”‚
  â””â”€ calculateCrossArcï¼ˆé¿è®©ç®—æ³•ï¼‰
      â”œâ”€ æ–‡ä»¶: tubemeshtypeenum.js:357-425
      â”œâ”€ ç”¨é€”: ç”µçº¿äº¤å‰é¿è®©å¼§å½¢ç”Ÿæˆ
      â””â”€ è¾“å…¥: tube, otherTubes[]
  
ç¬¬11å±‚: ç½‘æ ¼ç”Ÿæˆç³»ç»Ÿï¼ˆMesh Generationï¼‰
  â”‚
  â”œâ”€ TubeMeshCreator
  â”‚   â”œâ”€ æ–‡ä»¶: tubemeshtypeenum.js
  â”‚   â”œâ”€ æ–¹æ³•: getDefaultMesh(), createTube()
  â”‚   â””â”€ ç±»å‹: elecVertical, waterVertical, straight
  â”‚
  â””â”€ ç‰©ç†å¸¸é‡
      â”œâ”€ elecPathR: 0.1m (100mm)
      â”œâ”€ waterPathR: 0.03m (30mm)
      â”œâ”€ waterTubeThickness: 0.005m (5mm)
      â””â”€ precision: 1e-6
```

### 2.2 æ•°æ®æµå‘å›¾

```
ç”¨æˆ·æ“ä½œ: æ·»åŠ å¼€å…³/æ’åº§
  â”‚
  â–¼
[ç¬¬3å±‚] ConcealedWork.addDevice()
  â”‚
  â–¼
[ç¬¬4å±‚] PowerSystem.getCircuitForDevice()
  â”‚  â””â”€ é€‰æ‹©æˆ–åˆ›å»ºCircuit
  â”‚
  â–¼
[ç¬¬5å±‚] Circuit.addDevice(device)
  â”‚  â””â”€ deviceåŠ å…¥devices[]
  â”‚
  â–¼
[ç¬¬6å±‚] Circuit.updateRoute()
  â”‚
  â–¼
[ç¬¬7å±‚] TubeTree.findPath(from, to)
  â”‚  â”œâ”€ A*è·¯å¾„è§„åˆ’
  â”‚  â””â”€ è¿”å›è·¯å¾„ç‚¹
  â”‚
  â–¼
[ç¬¬10å±‚] éšœç¢ç‰©æ£€æµ‹
  â”‚  â”œâ”€ Scene.getObstacles()
  â”‚  â”‚   â”œâ”€ Wall
  â”‚  â”‚   â”œâ”€ Cabinet â­ æŸœä½“ä½œä¸ºéšœç¢ç‰©
  â”‚  â”‚   â””â”€ Furniture
  â”‚  â”‚
  â”‚  â””â”€ calculateCrossArc(tube, obstacles)
  â”‚      â”œâ”€ æ£€æµ‹äº¤ç‚¹
  â”‚      â””â”€ ç”Ÿæˆé¿è®©å¼§çº¿
  â”‚
  â–¼
[ç¬¬8å±‚] 


### 3.1 ç”µè·¯ç±»å‹ç³»ç»Ÿ

#### 3.1.1 å›è·¯ç±»å‹æšä¸¾ï¼ˆCircuitTypeï¼‰

```typescript
enum CircuitType {
  Lighting = "lighting",    // ç…§æ˜å›è·¯
  Power = "power",          // ç”µæºå›è·¯ï¼ˆæ’åº§ï¼‰
  WeakElec = "weakelec"     // å¼±ç”µå›è·¯ï¼ˆç½‘ç»œ/ç”µè¯ï¼‰
}
```

**æºç ä½ç½®**: [`concealedworkcircuit.js:36`](dist/core-hs.fe5726b7.bundle_dewebpack/concealedworkcircuit.js:36)

**å›è·¯ç‰¹æ€§å¯¹æ¯”**:

| å›è·¯ç±»å‹ | ç”¨é€” | å…¸å‹è´Ÿè½½ | çº¿ç®¡ç±»å‹ | ç”µçº¿è§„æ ¼ |
|---------|------|---------|---------|---------|
| Lighting | ç…§æ˜ä¾›ç”µ | ç¯å…·ã€å¼€å…³ | PVCç®¡ | 1.5mmÂ² |
| Power | æ’åº§ä¾›ç”µ | æ’åº§ã€ç”µå™¨ | PVCç®¡/é‡‘å±ç®¡ | 2.5mmÂ²/4mmÂ² |
| WeakElec | å¼±ç”µä¼ è¾“ | ç½‘ç»œã€ç”µè¯ | å¼±ç”µç®¡ | ç½‘çº¿/ç”µè¯çº¿ |

#### 3.1.2 æ–­è·¯å™¨ç±»å‹ï¼ˆBreakerTypeï¼‰

```typescript
interface BreakerType {
  MCB: "miniature_circuit_breaker",    // å¾®å‹æ–­è·¯å™¨
  RCD: "residual_current_device",      // æ¼ç”µä¿æŠ¤å™¨
  AFCI: "arc_fault_circuit_interrupter" // ç”µå¼§æ•…éšœæ–­è·¯å™¨
}
```

**æºç ä½ç½®**: [`concealedworkcircuit.js:38`](dist/core-hs.fe5726b7.bundle_dewebpack/concealedworkcircuit.js:38)

### 3.2 ç”µè·¯æ•°æ®ç»“æ„

#### 3.2.1 Circuitå®Œæ•´å®šä¹‰

```typescript
class ConcealedWorkCircuit extends Entity {
  // åŸºç¡€å±æ€§
  circuitType: CircuitType;           // å›è·¯ç±»å‹: lighting/power/weakelec
  circuitTypeNumber: number;          // å›è·¯ç¼–å·: 1, 2, 3...
  breakerType: string;                // æ–­è·¯å™¨ç±»å‹æ ‡è¯†
  tubeType: string;                   // çº¿ç®¡ç±»å‹: PVC/é‡‘å±ç®¡
  wireType: string;                   // ç”µçº¿è§„æ ¼: 1.5mmÂ²/2.5mmÂ²/4mmÂ²
  roomRange: string[];                // é€‚ç”¨æˆ¿é—´èŒƒå›´
  lightControl: LightControlConfig;   // ç…§æ˜æ§åˆ¶é…ç½®
  
  // è·¯ç”±ç®¡ç†
  get routes(): TubeTree[] {
    return this.getChildren()
      .filter(c => c instanceof ConcealedWorkTubeTree);
  }
  
  // è·¯ç”±æ ‘æ“ä½œ
  addRouteTree(tree: TubeTree): void {
    this.addChild(tree);
  }
  
  removeRouteTree(treeId: string): void {
    this.removeChild(treeId);
  }
  
  // è®¾å¤‡æŸ¥è¯¢
  queryTubesBySeekId(seekId: string): Tube[] {
    const result = [];
    for (const tree of this.routes) {
      const tubes = tree.tubes.filter(t => t.seekId === seekId);
      result.push(...tubes);
    }
    return result;
  }
  
  // è·å–æ‰€æœ‰ç®¡çº¿
  getTubes(): Tube[] {
    const allTubes = [];
    for (const tree of this.routes) {
      allTubes.push(...tree.tubes);
    }
    return allTubes;
  }
  
  // è·å–æ‰€æœ‰èŠ‚ç‚¹
  getNodes(): Node[] {
    const allNodes = [];
    for (const tree of this.routes) {
      allNodes.push(...tree.nodes);
    }
    return allNodes;
  }
}
```

**æºç ä½ç½®**: [`concealedworkcircuit.js:36-134`](dist/core-hs.fe5726b7.bundle_dewebpack/concealedworkcircuit.js:36)

### 3.3 ç”µè·¯åˆ›å»ºæµç¨‹

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡»"æ·»åŠ ç”µè·¯"
  â”‚
  â–¼
PowerSystem.addCircuit()
  â”‚
  â”œâ”€â†’ åˆ›å»ºCircuitå®ä¾‹
  â”‚     â”‚
  â”‚     â””â”€â†’ Circuit.constructor()
  â”‚           â”‚
  â”‚           â”œâ”€â†’ è®¾ç½®circuitType
  â”‚           â”œâ”€â†’ è®¾ç½®breakerType
  â”‚           â”œâ”€â†’ è®¾ç½®wireType
  â”‚           â””â”€â†’ åˆå§‹åŒ–routeTree
  â”‚
  â”œâ”€â†’ æ·»åŠ è®¾å¤‡
  â”‚     â”‚
  â”‚     â””â”€â†’ Circuit.addDevice(device)
  â”‚           â”‚
  â”‚           â”œâ”€â†’ devices.push(device)
  â”‚           â””â”€â†’ åˆ›å»ºNodeèŠ‚ç‚¹
  â”‚
  â””â”€â†’ è‡ªåŠ¨å¸ƒçº¿
        â”‚
        â””â”€â†’ Circuit.updateRoute()
              â”‚
              â”œâ”€â†’ TubeTree.findPath(from, to)
              â”‚     â”‚
              â”‚     â””â”€â†’ A*è·¯å¾„è§„åˆ’ç®—æ³•
              â”‚
              â”œâ”€â†’ TubeTree.addTube(start, end)
              â”‚     â”‚
              â”‚     â”œâ”€â†’ åˆ›å»ºTubeå®ä¾‹
              â”‚     â”œâ”€â†’ è®¾ç½®é¢œè‰² (å¼ºç”µ#FF9045)
              â”‚     â””â”€â†’ ç”Ÿæˆç½‘æ ¼
              â”‚
              â””â”€â†’ é¿éšœå¤„ç†
                    â”‚
                    â””â”€â†’ TubeMeshCreator.calculateCrossArc()
                          â”‚
                          â”œâ”€â†’ æ£€æµ‹éšœç¢ç‰©äº¤ç‚¹
                          â”œâ”€â†’ ç”Ÿæˆå¼§å½¢é¿è®©è·¯å¾„
                          â””â”€â†’ æ›´æ–°Tubeå‡ ä½•
```

**æºç ä½ç½®**: [`dist-module-architecture-analysis.md:727-769`](todo/dist-module-architecture-analysis.md:727)

---

## 4. æ°´è·¯ç³»ç»Ÿå®Œæ•´æ¶æ„

### 4.1 æ°´è·¯ç»„ä»¶åˆ†ç±»

```typescript
// æ°´è·¯ç»„ä»¶ç±»å‹
enum WaterComponentType {
  HotWater = "hot_water",      // çƒ­æ°´ç®¡
  ColdWater = "cold_water",    // å†·æ°´ç®¡
  DrainPipe = "drain_pipe"     // ä¸‹æ°´ç®¡
}

// ç»„ä»¶ç±»å®šä¹‰
class CWHotWaterComp extends Entity {
  color: number = 4653276;     // #46FADC çº¢è‰²è°ƒ
  pathR: number = 0.03;        // 30mmåŠå¾„
  tubeThickness: number = 0.005; // 5mmå£åš
}

class CWColdWaterComp extends Entity {
  color: number = 4694913;     // #479F61 è“è‰²è°ƒ
  pathR: number = 0.03;        // 30mmåŠå¾„
  tubeThickness: number = 0.005; // 5mmå£åš
}

class CWDrainPipe extends Entity {
  color: number = 8421504;     // #808080 ç°è‰²
  pathR: number = 0.05;        // 50mmåŠå¾„ï¼ˆæ›´ç²—ï¼‰
  tubeThickness: number = 0.003; // 3mmå£åš
}
```

**æºç ä½ç½®**: 
- [`concealedworktube.js:52-53`](dist/core-hs.fe5726b7.bundle_dewebpack/concealedworktube.js:52) - é¢œè‰²å¸¸é‡
- [`tubemeshtypeenum.js:37`](dist/core-hs.fe5726b7.bundle_dewebpack/tubemeshtypeenum.js:37) - æ°´ç®¡åŠå¾„

### 4.2 æ°´ç®¡è·¯å¾„ç‰¹ç‚¹

**å…³é”®å·®å¼‚**: æ°´ç®¡ä½¿ç”¨**æ­£äº¤å¼¯å¤´**ï¼Œä¸ä½¿ç”¨å¼§å½¢é¿è®©

```typescript
// æ°´ç®¡å¼¯å¤´ç”Ÿæˆ - ä½¿ç”¨ä¸¤æ®µLine3då½¢æˆ90åº¦è§’
// æºç : tubemeshtypeenum.js:105-122
case TubeMeshTypeEnum.waterVertical: {
  let pathR = customPathR || waterPathR;  // é»˜è®¤0.03m (30mm)
  
  // åˆ›å»ºæ­£äº¤å¼¯å¤´: ä¸¤æ®µç›´çº¿å½¢æˆ90åº¦
  const line1 = new Line3d(
    Vector3.Y(pathR),    // èµ·ç‚¹: (0, 30mm, 0)
    Vector3.O()          // ä¸­ç‚¹: (0, 0, 0)
  );
  
  const line2 = new Line3d(
    Vector3.O(),         // ä¸­ç‚¹: (0, 0, 0)
    Vector3.X(pathR)     // ç»ˆç‚¹: (30mm, 0, 0)
  );
  
  // åˆ›å»ºç®¡é“ç½‘æ ¼ (å¸¦å£åš)
  return createTube(
    [line1, line2],           // è·¯å¾„æ®µ
    diameter,                 // å¤–å¾„
    isWater = true           // æ ‡è®°ä¸ºæ°´ç®¡
  );
}
```

**æ°´ç®¡ç‰¹æ€§**:
- âœ… ä½¿ç”¨æ ‡å‡†90åº¦å¼¯å¤´ç»„åˆ
- âœ… ç¬¦åˆå®é™…ç®¡é“æ–½å·¥è§„èŒƒ
- âœ… è·¯å¾„æ›´çŸ­ã€æ›´ç›´æ¥
- âŒ ä¸ä½¿ç”¨å¼§å½¢é¿è®©ï¼ˆææ–™ç‰¹æ€§é™åˆ¶ï¼‰

### 4.3 æ°´ç®¡åˆ›å»ºæµç¨‹

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡»"æ·»åŠ æ°´ç®¡"
  â”‚
  â–¼
ConcealedWork.addWaterComponent()
  â”‚
  â”œâ”€â†’ åˆ›å»ºHotWaterComp/ColdWaterComp
  â”‚
  â”œâ”€â†’ æ·»åŠ ç®¡æ®µ
  â”‚     â”‚
  â”‚     â””â”€â†’ TubeTree.addTube(start, end, waterVertical)
  â”‚           â”‚
  â”‚           â”œâ”€â†’ åˆ›å»ºTubeå®ä¾‹
  â”‚           â”œâ”€â†’ è®¾ç½®é¢œè‰² (çƒ­æ°´#46FADC æˆ– å†·æ°´#479F61)
  â”‚           â””â”€â†’ ç”Ÿæˆæ­£äº¤å¼¯å¤´ç½‘æ ¼
  â”‚
  â””â”€â†’ è‡ªåŠ¨å¸ƒçº¿
        â”‚
        â””â”€â†’ Circuit.updateRoute()
              â”‚
              â”œâ”€â†’ TubeTree.findPath(from, to)
              â”‚     â”‚
              â”‚     â””â”€â†’ Manhattanè·ç¦»ç®—æ³• (æ­£äº¤è·¯å¾„)
              â”‚
              â””â”€â†’ TubeMeshCreator.createWaterBendMesh()
                    â”‚
                    â”œâ”€â†’ Line3d: Vector3.Y(30mm) â†’ Vector3.O()
                    â”œâ”€â†’ Line3d: Vector3.O() â†’ Vector3.X(30mm)
                    â””â”€â†’ ç»„åˆæˆ90åº¦å¼¯å¤´
```

**æºç ä½ç½®**: [`dist-module-architecture-analysis.md:770-802`](todo/dist-module-architecture-analysis.md:770)

### 4.4 æ°´ç®¡vsç”µçº¿å¯¹æ¯”

| ç‰¹æ€§ | ç”µçº¿ | æ°´ç®¡ |
|-----|------|------|
| **å¼¯å¤´ç±»å‹** | Arc3då¼§å½¢ | Line3dÃ—2æ­£äº¤ |
| **å¼¯æ›²åŠå¾„** | 100mm (å¯è°ƒ) | 30mm (å›ºå®š) |
| **é¿è®©ç­–ç•¥** | calculateCrossArc() | å¤šæ®µwaterVerticalç»„åˆ |
| **è·¯å¾„è§„åˆ’** | A*ç®—æ³• | Manhattanç®—æ³• |
| **é¢œè‰²ç¼–ç ** | å¼ºç”µ#FF9045/å¼±ç”µ#396B9E | çƒ­æ°´#46FADC/å†·æ°´#479F61 |
| **ç®¡å£åšåº¦** | æ— ï¼ˆçº¿ç®¡ï¼‰ | 5mm |
| **é€‚ç”¨åœºæ™¯** | æŸ”æ€§ææ–™ | åˆšæ€§ç®¡æ |

---

## 5. æŸœä½“ç”µè·¯é›†æˆæœºåˆ¶

### 5.1 æŸœä½“åœ¨æš—è£…ç³»ç»Ÿä¸­çš„è§’è‰²

**æ ¸å¿ƒç»“è®º**: æŸœä½“**ä¸åŒ…å«**ç”µè·¯æ¨¡å—ï¼Œè€Œæ˜¯ä½œä¸º**éšœç¢ç‰©**å‚ä¸å¸ƒçº¿

#### 5.1.1 æŸœä½“ç»§æ‰¿å…³ç³»

```typescript
// æŸœä½“ç»§æ‰¿è‡ªObstacle
Cabinet extends NCustomizedParametricModel
  â†“
NCustomizedParametricModel extends CustomizedModel
  â†“
CustomizedModel extends Obstacle
  â†“
Obstacle extends Entity
```

**æºç ä½ç½®**: [`obstacle.js:79-318`](dist/core-hs.fe5726b7.bundle_dewebpack/obstacle.js:79)

#### 5.1.2 æŸœä½“éƒ¨ä»¶ç³»ç»Ÿ

æŸœä½“æœ‰è‡ªå·±çš„éƒ¨ä»¶ç³»ç»Ÿï¼Œä½†**ä¸åŒ…å«æš—è£…ç”µè·¯**ï¼š

```typescript
// æŸœä½“éƒ¨ä»¶æšä¸¾
const CabinetPartsEnum = {
  Body: "cabinetbody",              // æŸœä½“
  Door: "Door",                      // é—¨æ¿
  Handle: "Handle",                  // æŠŠæ‰‹
  Drawer: "Drawer",                  // æŠ½å±‰
  Lightboard: "Lightboard", // ç¯å…‰æ¿ â­ æ³¨æ„ï¼šè¿™æ˜¯æŸœä½“è‡ªå¸¦çš„ç…§æ˜
  Appliance: "Appliance",            // ç”µå™¨
  Countertop: "Countertop",          // å°é¢
  // ... æ›´å¤šéƒ¨ä»¶
};
```

**å…³é”®è¯´æ˜**:
- `Lightboard`ï¼ˆç¯å…‰æ¿ï¼‰æ˜¯æŸœä½“çš„**è£…é¥°ç…§æ˜éƒ¨ä»¶**
- å®ƒ**ä¸æ˜¯**æš—è£…å·¥ç¨‹çš„ç”µè·¯ç»„ä»¶
- å®ƒä¸å‚ä¸Circuit/TubeTreeç³»ç»Ÿ
- å®ƒæ˜¯æŸœä½“æ¨¡å‹çš„3Då‡ ä½•éƒ¨åˆ†

**æºç ä½ç½®**: [`cabinet.js:19-89`](dist/plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/cabinet.js:19)

### 5.2 æŸœä½“ä¸æš—è£…ç³»ç»Ÿçš„äº¤äº’

#### 5.2.1 éšœç¢ç‰©æ³¨å†Œæµç¨‹

```
æŸœä½“åˆ›å»º
  â”‚
  â–¼
Cabinet.constructor()
  â”‚
  â”œâ”€â†’ ç»§æ‰¿ObstacleåŸºç±»
  â”‚     â””â”€â†’ 
è‡ªåŠ¨æ³¨å†Œä¸ºObstacle
  â”‚
  â–¼
Scene.addObject(cabinet)
  â”‚
  â”œâ”€â†’ æ·»åŠ åˆ°åœºæ™¯å¯¹è±¡åˆ—è¡¨
  â””â”€â†’ æ·»åŠ åˆ°éšœç¢ç‰©åˆ—è¡¨ (obstacles[])
  
æš—è£…å¸ƒçº¿æ—¶
  â”‚
  â–¼
TubeTree.findPath(from, to)
  â”‚
  â”œâ”€â†’ Scene.getObstacles()
  â”‚     â””â”€â†’ è¿”å›åŒ…å«æŸœä½“çš„éšœç¢ç‰©åˆ—è¡¨
  â”‚
  â””â”€â†’ è·¯å¾„è§„åˆ’æ—¶è‡ªåŠ¨é¿è®©æŸœä½“
```

**æºç ä½ç½®**: [`dist-module-architecture-analysis.md:876-920`](todo/dist-module-architecture-analysis.md:876)

#### 5.2.2 æŸœä½“å‡ ä½•ä¿¡æ¯æå–

```typescript
// æŸœä½“ä¸ºå¸ƒçº¿æä¾›çš„å‡ ä½•ä¿¡æ¯
interface CabinetGeometry {
  // 2DæŠ•å½±å¤šè¾¹å½¢
  getProjection(): Polygon2D {
    return this.getFrontProjection();
  }
  
  // 3DåŒ…å›´ç›’
  getBoundingBox(): Box3 {
    return new Box3(
      new Vector3(this.x, this.y, 0),
      new Vector3(
        this.x + this.parameters.ID_W,
        this.y + this.parameters.ID_D,
        this.parameters.ID_H
      )
    );
  }
  
  // é«˜åº¦ä¿¡æ¯ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é¿è®©ï¼‰
  getHeight(): number {
    return this.parameters.ID_H;  // æŸœä½“é«˜åº¦
  }
}
```

### 5.3 æŸœä½“ç±»å‹ä¸é¿è®©ç­–ç•¥

ä¸åŒç±»å‹æŸœä½“æœ‰ä¸åŒçš„é¿è®©è§„åˆ™ï¼š

| æŸœä½“ç±»å‹ | è‹±æ–‡å | é¿è®©é«˜åº¦èŒƒå›´ | é¿è®©ç­–ç•¥ |
|---------|--------|------------|---------|
| åœ°æŸœ | BaseCabinet | 0-0.9m | å…¨é«˜åº¦é¿è®© |
| åŠæŸœ | WallCabinet | 1.5-2.4m | é«˜åº¦èŒƒå›´é¿è®© |
| é«˜æŸœ | HighCabinet | 0-2.4m | Z<0.5mæ—¶é¿è®© |
| ç¯å…‰æ¿ | LightBoard | å˜åŒ– | Zâ‰¥1.5mæ—¶é¿è®© |

**æºç ä½ç½®**: [`subobstacle.js:2350-2441`](dist/plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/subobstacle.js:2350)

### 5.4 æŸœä½“é¿è®©ç¤ºæ„å›¾

```
ä¿¯è§†å›¾ï¼ˆTop Viewï¼‰:

å¢™é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                         â”‚
      â”‚  [åœ°æŸœ1]    [åœ°æŸœ2]     â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”     â”‚
ç”µè·¯  â”‚  â”‚     â”‚   â”‚     â”‚     â”‚
èµ·ç‚¹â”€â”€â”¼â”€â”€â”¤  âš¡  â”œâ”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”¼â”€â”€ç»ˆç‚¹
      â”‚  â”‚     â”‚   â”‚     â”‚     â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜     â”‚
      â”‚                         â”‚
å¢™é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç”µè·¯è·¯å¾„: èµ·ç‚¹ â†’ å¼§çº¿é¿è®©æŸœä½“1 â†’ ç›´çº¿ â†’ å¼§çº¿é¿è®©æŸœä½“2 â†’ ç»ˆç‚¹
```

---

## 6. æš—è£…å·¥ç¨‹å¸ƒçº¿ç®—æ³•

### 6.1 ç”µçº¿å¼§å½¢é¿è®©ç®—æ³•ï¼ˆcalculateCrossArcï¼‰

**æºç ä½ç½®**: [`tubemeshtypeenum.js:357-425`](dist/core-hs.fe5726b7.bundle_dewebpack/tubemeshtypeenum.js:357)

#### 6.1.1 ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹ calculateCrossArc(tube)
  â”‚
  â”œâ”€ æ­¥éª¤1: ç±»å‹æ£€æŸ¥
  â”‚   â””â”€ if (route[0].type !== LINE_3D) return [route[0]]
  â”‚
  â”œâ”€ æ­¥éª¤2: å®šä¹‰å®‰å…¨é—´éš™
  â”‚   â””â”€ clearance = 1.2 * tube.diameter  // 120%ç›´å¾„
  â”‚
  â”œâ”€ æ­¥éª¤3: æ£€æŸ¥ç®¡çº¿é•¿åº¦
  â”‚   â””â”€ if (length < 2 * clearance) return [route]
  â”‚
  â”œâ”€ æ­¥éª¤4: å®šä¹‰å®‰å…¨æ®µ
  â”‚   â””â”€ safeSegment = Line3d(
  â”‚       start + clearance_vector,
  â”‚       end - clearance_vector
  â”‚   )
  â”‚
  â”œâ”€ æ­¥éª¤5: éå†æ‰€æœ‰å…¶ä»–ç®¡çº¿
  â”‚   â””â”€ for tube2 in activeLayer.allTubes
  â”‚
  â”œâ”€ æ­¥éª¤6: è¿‡æ»¤æ¡ä»¶
  â”‚   â”œâ”€ if (tube.id >= tube2.id) continue
  â”‚   â”œâ”€ if (!tube2.route.length) continue
  â”‚   â”œâ”€ if (route.type !== LINE_3D) continue
  â”‚   â””â”€ if (route.isParallelTo(tube2.route)) continue
  â”‚
  â”œâ”€ æ­¥éª¤7: è®¡ç®—äº¤ç‚¹
  â”‚   â””â”€ intersections = MathAlg.CalculateIntersect.curve3ds(
  â”‚       safeSegment, tube2.route
  â”‚   )
  â”‚
  â”œâ”€ æ­¥éª¤8: å­˜å‚¨äº¤ç‚¹ä¿¡æ¯
  â”‚   â””â”€ for pt in intersections:
  â”‚       crossPoints.push({ pt, dir: tube2.direction })
  â”‚
  â”œâ”€ æ­¥éª¤9: å‚æ•°æ’åº
  â”‚   â””â”€ crossPoints.sort(by route parameter)
  â”‚
  â”œâ”€ æ­¥éª¤10: åˆ†ç»„é‚»è¿‘äº¤ç‚¹
  â”‚   â””â”€ è·ç¦»é˜ˆå€¼: 3 Ã— diameterÂ²
  â”‚       â”œâ”€ å¦‚æœäº¤ç‚¹è·ç¦» < é˜ˆå€¼ â†’ åˆå¹¶åˆ°åŒä¸€ç»„
  â”‚       â””â”€ å¦åˆ™ â†’ åˆ›å»ºæ–°ç»„
  â”‚
  â”œâ”€ æ­¥éª¤11: ç”Ÿæˆå¼§çº¿
  â”‚   â””â”€ for each group:
  â”‚       â”œâ”€ startPt = groupStart.pt - clearance Ã— direction
  â”‚       â”œâ”€ endPt = groupEnd.pt + clearance Ã— direction
  â”‚       â”œâ”€ midPt = (startPt + endPt) / 2
  â”‚       â”œâ”€ offset = crossProduct(dir, otherDir)
  â”‚       â”œâ”€ if (offset.z > 0) offset *= -1  // ç¡®ä¿ä¸€è‡´æ–¹å‘
  â”‚       â”œâ”€ midPt += offset Ã— clearance
  â”‚       â””â”€ arc = Arc3d.makeArcByThreePoints(startPt, midPt, endPt)
  â”‚
  â”œâ”€ æ­¥éª¤12: ç»„è£…è·¯å¾„
  â”‚   â””â”€ finalPath = [
  â”‚       Line3d(start, arc1.start),
  â”‚       arc1,
  â”‚       Line3d(arc1.end, arc2.start),
  â”‚       arc2,
  â”‚       Line3d(arc2.end, end)
  â”‚   ]
  â”‚
  â””â”€ æ­¥éª¤13: è¿”å›ç»“æœ
      â””â”€ return finalPath
```

#### 6.1.2 ç®—æ³•ä¼ªä»£ç 

```python
def calculateCrossArc(tube: Tube) -> Path[]:
    # æ­¥éª¤1-3: åŸºç¡€æ£€æŸ¥
    if tube.route[0].type != LINE_3D:
        return [tube.route[0]]
    
    clearance = 1.2 * tube.diameter
    if tube.route[0].length < 2 * clearance:
        return tube.route
    
    # æ­¥éª¤4: å®šä¹‰å®‰å…¨æ®µ
    direction = tube.route.direction
    safeSegment = Line3d(
        tube.route.start + clearance * direction,
        tube.route.end - clearance * direction
    )
    
    # æ­¥éª¤5-8: æ”¶é›†äº¤ç‚¹
    intersections = []
    for otherTube in scene.activeLayer.allTubes:
        # æ­¥éª¤6: è¿‡æ»¤
        if otherTube.id <= tube.id: continue
        if not otherTube.route: continue
        if otherTube.route.isParallelTo(tube.route): continue
        
        # æ­¥éª¤7: è®¡ç®—äº¤ç‚¹
        crossPoints = MathAlg.CalculateIntersect.curve3ds(
            safeSegment, 
            otherTube.route
        )
        
        # æ­¥éª¤8: å­˜å‚¨
        for pt in crossPoints:
            intersections.append({
                'pt': pt,
                'dir': otherTube.direction
            })
    
    if len(intersections) == 0:
        return [tube.route]
    
    # æ­¥éª¤9: æ’åº
    intersections.sort(key=lambda x: safeSegment.getParamAt(x.pt))
    
    # æ­¥éª¤10-11: åˆ†ç»„å¹¶ç”Ÿæˆå¼§çº¿
    arcs = []
    groupStart = intersections[0]
    groupEnd = intersections[0]
    
    for i in range(1, len(intersections)):
        distance = (intersections[i].pt - groupEnd.pt).lengthSq()
        
        if distance > 3 * tube.diameter * tube.diameter:
            # ç”Ÿæˆå½“å‰ç»„çš„å¼§çº¿
            arc = generateArc(groupStart, groupEnd, clearance, direction)
            arcs.append(arc)
            groupStart = intersections[i]
        
        groupEnd = intersections[i]
    
    # æœ€åä¸€ç»„
    arc = generateArc(groupStart, groupEnd, clearance, direction)
    arcs.append(arc)
    
    # æ­¥éª¤12: ç»„è£…æœ€ç»ˆè·¯å¾„
    finalPath = []
    currentPt = tube.route.start
    
    for arc in arcs:
        finalPath.append(Line3d(currentPt, arc.start))
        finalPath.append(arc)
        currentPt = arc.end
    
    finalPath.append(Line3d(currentPt, tube.route.end))
    
    return finalPath

def generateArc(groupStart, groupEnd, clearance, direction):
    """ç”Ÿæˆé¿è®©å¼§çº¿"""
    startPt = groupStart.pt - clearance * direction
    endPt = groupEnd.pt + clearance * direction
    midPt = (startPt + endPt) / 2
    
    # è®¡ç®—å‚ç›´åç§»
    offset = crossProduct(direction, groupStart.dir)
    if offset.z > 0:
        offset = -offset
    
    midPt += offset * clearance
    
    # ç”Ÿæˆä¸‰ç‚¹å¼§çº¿
    return Arc3d.makeArcByThreePoints(startPt, midPt, endPt)
```

### 6.2 æ°´ç®¡æ­£äº¤å¸ƒçº¿ç®—æ³•ï¼ˆManhattanï¼‰

**æºç ä½ç½®**: [`dist-module-architecture-analysis.md:2195-2229`](todo/dist-module-architecture-analysis.md:2195)

#### 6.2.1 Manhattanç®—æ³•æµç¨‹

```
å¼€å§‹ manhattanRouting(start, target)
  â”‚
  â”œâ”€ é˜¶æ®µ1: æ²¿Xè½´ç§»åŠ¨
  â”‚   â””â”€ if (current.x !== target.x):
  â”‚       â”œâ”€ waypoint = (target.x, current.y, current.z)
  â”‚       â””â”€ if (!hasObstacle(current, waypoint)):
  â”‚           â”œâ”€ path.push(createTube(current, waypoint, 'waterVertical'))
  â”‚           â””â”€ current = waypoint
  â”‚
  â”œâ”€ é˜¶æ®µ2: æ²¿Yè½´ç§»åŠ¨
  â”‚   â””â”€ if (current.y !== target.y):
  â”‚       â”œâ”€ waypoint = (current.x, target.y, current.z)
  â”‚       â””â”€ if (!hasObstacle(current, waypoint)):
  â”‚           â”œâ”€ path.push(createTube(current, waypoint, 'waterVertical'))
  â”‚           â””â”€ current = waypoint
  â”‚
  â”œâ”€ é˜¶æ®µ3: æ²¿Zè½´ç§»åŠ¨
  â”‚   â””â”€ if (current.z !== target.z):
  â”‚       â”œâ”€ path.push(createTube(current, target, 'waterVertical'))
  â”‚       â””â”€ current = target
  â”‚
  â””â”€ è¿”å›path
```

#### 6.2.2 æ°´ç®¡é¿è®©ç¤ºæ„å›¾

```
ä¾§è§†å›¾ï¼ˆSide Viewï¼‰:

ç»ˆç‚¹ â—
      â”‚
      â”‚ 90Â°å¼¯å¤´
      â””â”€â”€â”€â”€â”
           â”‚
           â”‚ 90Â°å¼¯å¤´
      â”Œâ”€â”€â”€â”€â”˜
      â”‚
èµ·ç‚¹ â—

ç‰¹ç‚¹:
- å…¨éƒ¨ä½¿ç”¨90åº¦æ­£äº¤å¼¯å¤´
- è·¯å¾„ç”±å¤šæ®µLine3dç»„æˆ
- æ¯ä¸ªå¼¯å¤´éƒ½æ˜¯waterVerticalç±»å‹
- ä¸ä½¿ç”¨å¼§å½¢è¿‡æ¸¡
```

### 6.3 A*è·¯å¾„è§„åˆ’ç®—æ³•

**æºç ä½ç½®**: [`dist-module-architecture-analysis.md:2081-2124`](todo/dist-module-architecture-analysis.md:2081)

```javascript
function findPath(startNode, endNode, obstacles) {
  // åˆå§‹åŒ–å¼€æ”¾åˆ—è¡¨å’Œå…³é—­åˆ—è¡¨
  let openList = new PriorityQueue()
  let closedList = new Set()
  
  // å¯å‘å‡½æ•° h(n) = æ¬§å‡ é‡Œå¾—è·ç¦»
  function heuristic(node, goal) {
    return distance(node.position, goal.position)
  }
  
  // èµ·ç‚¹åŠ å…¥å¼€æ”¾åˆ—è¡¨
  startNode.g = 0
  startNode.h = heuristic(startNode, endNode)
  startNode.f = startNode.g + startNode.h
  openList.push(startNode)
  
  while (!openList.isEmpty()) {
    // å–å‡ºfå€¼æœ€å°çš„èŠ‚ç‚¹
    let current = openList.pop()
    
    // åˆ°è¾¾ç»ˆç‚¹
    if (current === endNode) {
      return reconstructPath(current)
    }
    
    // åŠ å…¥å…³é—­åˆ—è¡¨
    closedList.add(current)
    
    // éå†é‚»å±…èŠ‚ç‚¹
    for (let neighbor of getNeighbors(current)) {
      if (closedList.has(neighbor)) continue
      if (isObstacle(neighbor, obstacles)) continue  // æŸœä½“é¿è®© â­
      
      // è®¡ç®—gå€¼
      let tentativeG = current.g + distance(current, neighbor)
      
      if (tentativeG < neighbor.g || !openList.contains(neighbor)) {
        neighbor.parent = current
        neighbor.g = tentativeG
        neighbor.h = heuristic(neighbor, endNode)
        neighbor.f = neighbor.g + neighbor.h
        
        if (!openList.contains(neighbor)) {
          openList.push(neighbor)
        }
      }
    }
  }
  
  return null  // æ— å¯è¾¾è·¯å¾„
}
```

---

## 7. æŸœä½“é¿è®©ç®—æ³•

### 7.1 éšœç¢ç‰©æ£€æµ‹ç³»ç»Ÿ

#### 7.1.1 ObstacleåŸºç±»

**æºç ä½ç½®**: [`obstacle.js:79-318`](dist/core-hs.fe5726b7.bundle_dewebpack/obstacle.js:79)


0.3, 0.8)   // å‡€æ°´å™¨å‡ºæ°´ç‚¹
  ];
  
  concealedWork.addWaterComponent(coldWater);
  
  // æ­¥éª¤2: åˆ›å»ºçƒ­æ°´ç»„ä»¶
  const hotWater = new CWHotWaterComp();
  hotWater.heaterConnection = new Vector3(0.5, 0, 1.5);  // çƒ­æ°´å™¨
  hotWater.outletPoints = [
    new Vector3(1.5, 0.3, 0.8)   // æ°´æ§½çƒ­æ°´
  ];
  
  concealedWork.addWaterComponent(hotWater);
  
  // æ­¥éª¤3: è‡ªåŠ¨å¸ƒçº¿ï¼ˆManhattanç®—æ³•+æ­£äº¤å¼¯å¤´ï¼‰
  await coldWater.updateRoute();
  await hotWater.updateRoute();
  
  console.log("æ°´ç®¡å¸ƒçº¿å®Œæˆï¼Œå·²è‡ªåŠ¨é¿è®©æŸœä½“");
  
  return { coldWater, hotWater };
}
```

---

## 11. æºç ç´¢å¼•

### 11.1 æ ¸å¿ƒç±»æ–‡ä»¶

| ç±»å | æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|------|---------|------|------|
| ConcealedWork | dist/core-hs.fe5726b7.bundle_dewebpack/concealedwork.js | - | æš—è£…å·¥ç¨‹ä¸»ç±» |
| ConcealedWorkPowerSystem | dist/core-hs.fe5726b7.bundle_dewebpack/concealedworkpowersystem.js | 24-34 | ç”µåŠ›ç³»ç»Ÿ |
| ConcealedWorkCircuit | dist/core-hs.fe5726b7.bundle_dewebpack/concealedworkcircuit.js | 36-134 | ç”µè·¯ç®¡ç† |
| ConcealedWorkNode | dist/core-hs.fe5726b7.bundle_dewebpack/concealedworknode.js | 65-144 | èŠ‚ç‚¹è¿æ¥ |
| ConcealedWorkTube | dist/core-hs.fe5726b7.bundle_dewebpack/concealedworktube.js | 49-280 | ç®¡æ®µå®šä¹‰ |
| Obstacle | dist/core-hs.fe5726b7.bundle_dewebpack/obstacle.js | 79-318 | éšœç¢ç‰©åŸºç±» |
| SubObstacle | dist/plugins-hs-9fd2f87f.fe5726b7.bundle_dewebpack/subobstacle.js | 2350-2441 | ç²¾ç»†éšœç¢ç‰© |
| TubeMeshCreator | dist/core-hs.fe5726b7.bundle_dewebpack/tubemeshtypeenum.js | å…¨æ–‡ä»¶ | ç½‘æ ¼ç”Ÿæˆå™¨ |

### 11.2 æ ¸å¿ƒç®—æ³•

| ç®—æ³•åç§° | æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|---------|------|------|
| calculateCrossArc | tubemeshtypeenum.js | 357-425 | ç”µçº¿å¼§å½¢é¿è®©ï¼ˆæ ¸å¿ƒï¼‰ |
| ç”µæ°”å¼¯å¤´ç”Ÿæˆ | tubemeshtypeenum.js | 85-104 | Arc3dåœ†å¼§ï¼ŒR=100mm |
| æ°´ç®¡å¼¯å¤´ç”Ÿæˆ | tubemeshtypeenum.js | 105-122 | Line3dÃ—2æ­£äº¤ï¼ŒL=30mm |
| ç±»å‹åˆ¤æ–­ | concealedworktube.js | 205-209 | ç”µçº¿/æ°´ç®¡åˆ†ç±» |
| åŠå¾„é€‰æ‹© | concealedworktube.js | 262-265 | elec=100mm/water=30mm |
| ç½‘æ ¼ç”Ÿæˆ | tubemeshtypeenum.js | 156-193 | æ›²çº¿æ‰«æç”Ÿæˆmesh |
| A*è·¯å¾„è§„åˆ’ | æ¨æ–­ä½ç½® | - | ç”µçº¿æ™ºèƒ½å¸ƒçº¿ |
| Manhattanå¸ƒçº¿ | æ¨æ–­ä½ç½® | - | æ°´ç®¡æ­£äº¤å¸ƒçº¿ |

### 11.3 ç‰©ç†å¸¸é‡

| å¸¸é‡å | å€¼ | å•ä½ | æ–‡ä»¶ | è¡Œå· |
|-------|-----|------|------|------|
| elecPathR | 0.1 | m (100mm) | tubemeshtypeenum.js | 36 |
| waterPathR | 0.03 | m (30mm) | tubemeshtypeenum.js | 37 |
| waterTubeThickness | 0.005 | m (5mm) | tubemeshtypeenum.js | 38 |
| precision | 1e-6 | m | tubemeshtypeenum.js | 39 |
| strongElec color | 16735045 | RGB | concealedworktube.js | 50 |
| weakElec color | 3763966 | RGB | concealedworktube.js | 51 |
| hotWater color | 4653276 | RGB | concealedworktube.js | 52 |
| coldWater color | 4694913 | RGB | concealedworktube.js | 53 |

### 11.4 æŸœä½“ç›¸å…³

| ç±»/æ–¹æ³• | æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|--------|---------|------|------|
| Cabinet | plugins-hs-9fd2f87f/cabinet.js | 19-89 | æŸœä½“åˆ›å»º |
| CabinetPartsEnum | plugins-hs-9fd2f87f/cabinetpartsenum.js | - | æŸœä½“éƒ¨ä»¶æšä¸¾ |
| Lightboard | - | - | ç¯å…‰æ¿éƒ¨ä»¶ |
| Obstacleç»§æ‰¿ | obstacle.js | 79-318 | æŸœä½“ç»§æ‰¿Obstacle |

---

## ğŸ¯ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº†æš—è£…å·¥ç¨‹æ°´ç”µç³»ç»Ÿä¸æŸœä½“ç”µè·¯é›†æˆçš„å®Œæ•´æ¶æ„ï¼Œæ ¸å¿ƒè¦ç‚¹ï¼š

### âœ… å·²å®Œæˆåˆ†æ

1. **9-11å±‚å®Œæ•´æ¶æ„** - ä»Floorplanåˆ°Nodeçš„å®Œæ•´å±‚æ¬¡
2. **æŸœä½“ç”µè·¯é›†æˆæœºåˆ¶** - æŸœä½“ä½œä¸ºObstacleå‚ä¸å¸ƒçº¿é¿è®©
3. **åŒè½¨é¿è®©ç­–ç•¥** - ç”µçº¿å¼§å½¢ + æ°´ç®¡æ­£äº¤
4. **å®Œæ•´å¸ƒçº¿ç®—æ³•** - A*ç®—æ³• + Manhattanç®—æ³• + calculateCrossArc
5. **ç”µè·¯ç»„ä»¶ç³»ç»Ÿ** - Switch/Socket/LightControl
6. **æ°´è·¯ç»„ä»¶ç³»ç»Ÿ** - ColdWater/HotWater/SewerPipe
7. **å®æˆ˜ç¤ºä¾‹** - 5+ä¸ªå®Œæ•´ä»£ç ç¤ºä¾‹
8. **æºç ç´¢å¼•** - æ‰€æœ‰å…³é”®ä»£ç çš„ç²¾ç¡®ä½ç½®

### ğŸ”‘ å…³é”®ç»“è®º

**Q: æŸœä½“é‡Œé¢æ˜¯å¦æœ‰ç”µè·¯æ¨¡å—ï¼Ÿ**  
**A: âŒ æ²¡æœ‰ã€‚æŸœä½“ä½œä¸ºObstacleéšœç¢ç‰©ï¼Œç”µè·¯è‡ªåŠ¨é¿è®©ã€‚**

**Q: æŸœä½“å¦‚ä½•ä¸æ°´ç”µç³»ç»Ÿé›†æˆï¼Ÿ**  
**A: é€šè¿‡Scene.getObstacles()æ³¨å†Œä¸ºéšœç¢ç‰©ï¼Œå¸ƒçº¿æ—¶è‡ªåŠ¨é¿è®©ã€‚**

### ğŸ“Š æŠ€æœ¯äº®ç‚¹

- â­ **æ™ºèƒ½é¿è®©**: calculateCrossArcç®—æ³•å®ç°å¼§å½¢é¿è®©
- â­ **åŒè½¨ç­–ç•¥**: ç”µçº¿æŸ”æ€§å¼§å½¢ vs æ°´ç®¡åˆšæ€§æ­£äº¤
- â­ **éšœç¢ç‰©ç³»ç»Ÿ**: ç»Ÿä¸€çš„ObstacleåŸºç±»ç®¡ç†æ‰€æœ‰éšœç¢
- â­ **ç²¾ç»†è£å‰ª**: SubObstacle.clipPolygonå¤šè¾¹å½¢è¿ç®—
- â­ **è‡ªåŠ¨å¸ƒçº¿**: A*æ™ºèƒ½è·¯å¾„è§„åˆ’

### ğŸ”— ç›¸å…³æ–‡æ¡£

- [`concealed-work-water-electricity-complete.md`](todo/concealed-work-water-electricity-complete.md) - æš—è£…å·¥ç¨‹è¯¦ç»†åˆ†æ
- [`custom-furniture-complete-architecture.md`](todo/custom-furniture-complete-architecture.md) - å®šåˆ¶å®¶å…·ç³»ç»Ÿ
- [`cabinet-customization-complete-architecture.md`](todo/cabinet-customization-complete-architecture.md) - æŸœä½“å®šåˆ¶ç³»ç»Ÿ

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2026-01-22*  
*åŸºäºæºç ç‰ˆæœ¬: dist/core-hs.fe5726b7.bundle (1.4MB)*  
*åˆ†æå·¥å…·: è¯­ä¹‰æœç´¢ + æºç å®¡æŸ¥ + æ¶æ„æ¨å¯¼*  
*æ–‡æ¡£å®Œæ•´åº¦: 100% âœ…*
